# WPCleanAdmin 项目规则文档

## 1. 项目概述

WPCleanAdmin 是一个 WordPress 管理界面清理和优化插件，提供数据库优化、性能监控、登录界面自定义等功能。

**项目 URL**: https://github.com/sutchan
**默认署名**: Sut

## 2. 文件结构规范

### 2.1 主要目录结构

```
WPCleanAdmin/
├── wp-clean-admin.php        # 插件主入口文件
├── wpcleanadmin/             # 插件核心目录
│   ├── assets/               # 静态资源文件
│   │   ├── css/              # 样式文件
│   │   └── js/               # JavaScript 文件
│   ├── includes/             # PHP 类和功能文件
│   │   ├── tests/            # 测试相关文件
│   │   ├── autoload.php      # 自动加载器
│   │   └── *.php             # 各类功能实现
│   ├── languages/            # 语言文件
│   └── wp-clean-admin.php    # 插件主类文件
├── docs/                     # 项目文档（新增时使用）
├── build/                    # 多平台构建源代码（如需）
└── dist/                     # 构建产物（如需）
```

### 2.2 目录用途说明

- **docs/**: 存放项目文档、使用说明、API 文档等
- **build/**: 存放多平台构建源代码
- **dist/**: 存放构建产物，如压缩后的 JS/CSS 文件
- **.trae/rules/**: 存放项目规则文档

## 3. 编码规范

### 3.1 PHP 编码规范

- 使用 PSR-4 自动加载规范
- 所有 PHP 文件必须包含文件级注释，说明文件功能
- 所有函数必须包含函数级注释
- 类名使用 `WPCA_` 前缀，采用 PascalCase 命名法
- 方法名和函数名使用 camelCase 命名法
- 变量名使用 camelCase 命名法
- 常量名使用全大写加下划线命名法
- 每行代码长度不超过 120 个字符
- 使用 4 个空格缩进，不使用 Tab
- 文件编码必须为 UTF-8
- 必须包含闭合的 PHP 标签 `?>`

### 3.2 JavaScript 编码规范

- 使用 camelCase 命名函数和变量
- 使用 PascalCase 命名构造函数和类
- 使用全大写加下划线命名常量
- 所有函数必须包含函数级注释
- 使用 2 个空格缩进
- 文件编码必须为 UTF-8

### 3.3 CSS 编码规范

- 使用连字符（kebab-case）命名类和 ID
- 所有样式块必须包含注释说明
- 使用 2 个空格缩进
- 文件编码必须为 UTF-8

## 4. 本地化规范

### 4.1 多语言支持

- 所有界面字符串必须使用翻译函数包裹：`__()`、`_e()`、`_x()`、`_ex()`
- 翻译函数必须包含正确的文本域（text domain）：`wp-clean-admin`
- 字符串必须同时添加到以下文件：
  - `wpcleanadmin/languages/wp-clean-admin.pot`（主翻译模板）
  - `wpcleanadmin/languages/wp-clean-admin-en_US.po`（英文）
  - `wpcleanadmin/languages/wp-clean-admin-zh_CN.po`（中文）

### 4.2 翻译文件更新

- 只将 PHP 和 JS 文件中的字符串添加到 POT 文件
- 排除 `.md`、`.txt` 等非代码文件

## 5. 版本控制规范

### 5.1 版本号格式

使用语义化版本号（Semantic Versioning）：`主版本号.次版本号.修订号`
- 主版本号：不兼容的 API 变更
- 次版本号：向后兼容的功能性新增
- 修订号：向后兼容的问题修正

### 5.2 版本同步

- 所有代码文件必须同步版本号
- 每次构建项目时，自动升级最小版本号（修订号）
- 版本号必须写入以下位置：
  - 插件主入口文件的插件头注释
  - CHANGELOG.md 文件
  - 相关类文件的版本注释

### 5.3 版本历史记录

- 所有版本变更必须记录在 `CHANGELOG.md` 文件中
- 记录格式：
  ```
  ## x.y.z - YYYY-MM-DD
  
  ### Added
  - 新增功能描述
  
  ### Changed
  - 修改功能描述
  
  ### Fixed
  - 修复问题描述
  ```

## 6. 构建规范

### 6.1 构建前准备

- 每次构建项目时，先清理工作区缓存文件
- 检查所有文件的语法和闭合标签

### 6.2 构建过程

- 压缩 JS 和 CSS 文件
- 生成必要的 MO 文件
- 更新版本号
- 生成构建日志

## 7. 安全规范

### 7.1 输入验证

- 所有用户输入必须进行严格验证
- 使用 WordPress 提供的安全函数：`sanitize_text_field()`、`esc_html()` 等
- 数据库查询必须使用预处理语句

### 7.2 权限检查

- 所有管理功能必须进行权限检查
- 使用 `WPCA_Permissions::current_user_can()` 进行权限验证

### 7.3 安全头信息

- 添加适当的安全头信息
- 实现 CSRF 保护

## 8. 错误处理规范

### 8.1 异常捕获

- 所有可能抛出异常的代码块必须使用 try-catch 捕获
- 错误信息必须记录到日志

### 8.2 函数存在性检查

- 在调用可能不存在的函数前，必须使用 `function_exists()` 进行检查
- 在访问可能不存在的属性前，必须使用 `isset()` 进行检查

## 9. 调试规范

### 9.1 调试常量

- 使用 WordPress 调试常量控制调试输出：`WP_DEBUG`
- 仅在调试模式下输出详细错误信息

### 9.2 日志记录

- 使用 `error_log()` 记录错误和调试信息
- 日志信息必须包含插件名称前缀

## 10. 自动化任务规范

### 10.1 自动维护

- 空闲 1 分钟时，参考项目文档，继续开发未完善的代码
- 空闲 10 分钟时，自动开始修复问题
- 空闲 60 分钟时，自动开始清理冗余文件和缓存文件
- 每天自动同步工作区文件版本号

### 10.2 自动修复

- 自动修复发现的代码问题
- 自动检查语法及闭合标签
- 自动修复未定义函数和常量错误

## 11. 模型选择规范

- 优先使用 Gemini 模型
- 如果 Gemini 模型不可用，再切换到自动模式

## 12. 交互规范

### 12.1 输出处理

- 模型思考次数达到上限时，自动输入"继续"并回车
- 输出过长时，自动点击"继续"获取完整输出
- 折叠思考过程，只显示最终结果

### 12.2 文件审查

- 出现文件待审查请求时，自动全部接受审查请求
