<?php\r\n/**\r\n * WPCleanAdmin Cleanup Class\r\n *\r\n * @package WPCleanAdmin\r\n * @version 1.7.15\r\n * @author Sut\r\n * @author URI: https://github.com/sutchan\r\n * @since 1.7.15\r\n */\r\nnamespace WPCleanAdmin;\r\n\r\nif ( ! defined( 'ABSPATH' ) ) {\r\n    exit;\r\n}\r\n\r\n/**\r\n * Cleanup class\r\n */\r\nclass Cleanup {\r\n    \r\n    /**\r\n     * Singleton instance\r\n     *\r\n     * @var Cleanup\r\n     */\r\n    private static $instance;\r\n    \r\n    /**\r\n     * Get singleton instance\r\n     *\r\n     * @return Cleanup\r\n     */\r\n    public static function getInstance() {\r\n        if ( ! isset( self::$instance ) ) {\r\n            self::$instance = new self();\r\n        }\r\n        return self::$instance;\r\n    }\r\n    \r\n    /**\r\n     * Constructor\r\n     */\r\n    private function __construct() {\r\n        $this->init();\r\n    }\r\n    \r\n    /**\r\n     * Initialize the cleanup module\r\n     */\r\n    public function init() {\r\n        // Add cleanup hooks\r\n        if ( function_exists( 'add_action' ) ) {\r\n            \add_action( 'wpca_cleanup_database', array( $this, 'run_database_cleanup' ) );\r\n            \add_action( 'wpca_cleanup_media', array( $this, 'run_media_cleanup' ) );\r\n            \add_action( 'wpca_cleanup_comments', array( $this, 'run_comments_cleanup' ) );\r\n            \add_action( 'wpca_cleanup_content', array( $this, 'run_content_cleanup' ) );\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Get cleanup statistics\r\n     *\r\n     * @return array Cleanup statistics\r\n     */\r\n    public function get_cleanup_stats() {\r\n        global $wpdb;\r\n        \r\n        $stats = array();\r\n        \r\n        // Get transients count\r\n        $stats['transients'] = $wpdb->get_var( "SELECT COUNT(*) FROM {$wpdb->options} WHERE option_name LIKE '%_transient%'" );\r\n        \r\n        // Get orphaned postmeta count\r\n        $stats['orphaned_postmeta'] = $wpdb->get_var( "SELECT COUNT(*) FROM {$wpdb->postmeta} LEFT JOIN {$wpdb->posts} ON {$wpdb->postmeta}.post_id = {$wpdb->posts}.ID WHERE {$wpdb->posts}.ID IS NULL" );\r\n        \r\n        // Get orphaned termmeta count\r\n        $stats['orphaned_termmeta'] = $wpdb->get_var( "SELECT COUNT(*) FROM {$wpdb->termmeta} LEFT JOIN {$wpdb->terms} ON {$wpdb->termmeta}.term_id = {$wpdb->terms}.term_id WHERE {$wpdb->terms}.term_id IS NULL" );\r\n        \r\n        // Get orphaned relationships count\r\n        $stats['orphaned_relationships'] = $wpdb->get_var( "SELECT COUNT(*) FROM {$wpdb->term_relationships} LEFT JOIN {$wpdb->posts} ON {$wpdb->term_relationships}.object_id = {$wpdb->posts}.ID WHERE {$wpdb->posts}.ID IS NULL" );\r\n        \r\n        // Get spam comments count\r\n        $stats['spam_comments'] = $wpdb->get_var( "SELECT COUNT(*) FROM {$wpdb->comments} WHERE comment_approved = 'spam'" );\r\n        \r\n        // Get trash comments count\r\n        $stats['trash_comments'] = $wpdb->get_var( "SELECT COUNT(*) FROM {$wpdb->comments} WHERE comment_approved = 'trash'" );\r\n        \r\n        // Get unapproved comments count\r\n        $stats['unapproved_comments'] = $wpdb->get_var( "SELECT COUNT(*) FROM {$wpdb->comments} WHERE comment_approved = '0'" );\r\n        \r\n        // Get orphaned media count\r\n        $stats['orphaned_media'] = $this->get_orphaned_media_count();\r\n        \r\n        return $stats;\r\n    }\r\n    \r\n    /**\r\n     * Get orphaned media count\r\n     *\r\n     * @return int Orphaned media count\r\n     */\r\n    private function get_orphaned_media_count() {\r\n        global $wpdb;\r\n        \r\n        // Use a single query to get orphaned media count\r\n        // This is more efficient than looping through all media files and checking each one individually\r\n        $orphaned_count = $wpdb->get_var( "\r\n            SELECT COUNT(*) \r\n            FROM {$wpdb->posts} p \r\n            LEFT JOIN {$wpdb->postmeta} pm ON pm.meta_value LIKE CONCAT('%', p.ID, '%') \r\n            WHERE p.post_type = 'attachment' \r\n            AND pm.meta_id IS NULL\r\n        " );\r\n        \r\n        return intval( $orphaned_count );\r\n    }\r\n    \r\n    /**\r\n     * Run database cleanup\r\n     *\r\n     * @param array $options Cleanup options\r\n     * @return array Cleanup results\r\n     */\r\n    public function run_database_cleanup( $options = array() ) {\r\n        global $wpdb;\r\n        \r\n        $results = array(\r\n            'success' => true,\r\n            'message' => \__( 'Database cleanup completed successfully', WPCA_TEXT_DOMAIN ),\r\n            'cleaned' => array()\r\n        );\r\n        \r\n        // Set default options\r\n        $default_options = array(\r\n            'transients' => true,\r\n            'orphaned_postmeta' => true,\r\n            'orphaned_termmeta' => true,\r\n            'orphaned_relationships' => true,\r\n            'expired_crons' => true\r\n        );\r\n        \r\n        $options = ( function_exists( '\wp_parse_args' ) ? \wp_parse_args( $options, $default_options ) : array_merge( $default_options, $options ) );\r\n        \r\n        // Clean transients\r\n        if ( $options['transients'] ) {\r\n            $deleted = $wpdb->query( "DELETE FROM {$wpdb->options} WHERE option_name LIKE '%_transient_timeout_%' AND option_value < " . time() );\r\n            $deleted += $wpdb->query( "DELETE t1 FROM {$wpdb->options} t1 INNER JOIN {$wpdb->options} t2 ON t1.option_name = CONCAT( '_transient_', SUBSTRING( t2.option_name, 19 ) ) WHERE t2.option_name LIKE '%_transient_timeout_%'" );\r\n            $results['cleaned']['transients'] = $deleted;\r\n        }\r\n        \r\n        // Clean orphaned postmeta\r\n        if ( $options['orphaned_postmeta'] ) {\r\n            $deleted = $wpdb->query( "DELETE pm FROM {$wpdb->postmeta} pm LEFT JOIN {$wpdb->posts} p ON pm.post_id = p.ID WHERE p.ID IS NULL" );\r\n            $results['cleaned']['orphaned_postmeta'] = $deleted;\r\n        }\r\n        \r\n        // Clean orphaned termmeta\r\n        if ( $options['orphaned_termmeta'] ) {\r\n            $deleted = $wpdb->query( "DELETE tm FROM {$wpdb->termmeta} tm LEFT JOIN {$wpdb->terms} t ON tm.term_id = t.term_id WHERE t.term_id IS NULL" );\r\n            $results['cleaned']['orphaned_termmeta'] = $deleted;\r\n        }\r\n        \r\n        // Clean orphaned relationships\r\n        if ( $options['orphaned_relationships'] ) {\r\n            $deleted = $wpdb->query( "DELETE tr FROM {$wpdb->term_relationships} tr LEFT JOIN {$wpdb->posts} p ON tr.object_id = p.ID WHERE p.ID IS NULL" );\r\n            $results['cleaned']['orphaned_relationships'] = $deleted;\r\n        }\r\n        \r\n        // Clean expired crons\r\n        if ( $options['expired_crons'] ) {\r\n            $crons = ( function_exists( '\_get_cron_array' ) ? \_get_cron_array() : array() );\r\n            $now = time();\r\n            $deleted = 0;\r\n            \r\n            foreach ( $crons as $timestamp => $cronhooks ) {\r\n                if ( $timestamp < $now ) {\r\n                    foreach ( $cronhooks as $hook => $events ) {\r\n                        foreach ( $events as $sig => $data ) {\r\n                            if ( function_exists( '\wp_unschedule_event' ) ) {\r\n                                \wp_unschedule_event( $timestamp, $hook, $data['args'] );\r\n                                $deleted++;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            \r\n            $results['cleaned']['expired_crons'] = $deleted;\r\n        }\r\n        \r\n        return $results;\r\n    }\r\n    \r\n    /**\r\n     * Run media cleanup\r\n     *\r\n     * @param array $options Cleanup options\r\n     * @return array Cleanup results\r\n     */\r\n    public function run_media_cleanup( $options = array() ) {\r\n        global $wpdb;\r\n        \r\n        $results = array(\r\n            'success' => true,\r\n            'message' => \__( 'Media cleanup completed successfully', WPCA_TEXT_DOMAIN ),\r\n            'cleaned' => array()\r\n        );\r\n        \r\n        // Set default options\r\n        $default_options = array(\r\n            'orphaned_media' => true,\r\n            'unused_media' => true,\r\n            'duplicate_media' => false\r\n        );\r\n        \r\n        $options = ( function_exists( '\wp_parse_args' ) ? \wp_parse_args( $options, $default_options ) : array_merge( $default_options, $options ) );\r\n        \r\n        // Clean orphaned media\r\n        if ( $options['orphaned_media'] ) {\r\n            // Get all orphaned media files in a single query\r\n            // This is more efficient than looping through all media files and checking each one individually\r\n            $orphaned_media = $wpdb->get_results( "\r\n                SELECT p.ID, p.guid \r\n                FROM {$wpdb->posts} p \r\n                LEFT JOIN {$wpdb->postmeta} pm ON pm.meta_value LIKE CONCAT('%', p.ID, '%') \r\n                WHERE p.post_type = 'attachment' \r\n                AND pm.meta_id IS NULL\r\n            " );\r\n            \r\n            $deleted = 0;\r\n            \r\n            foreach ( $orphaned_media as $media ) {\r\n                // Delete media file\r\n                if ( function_exists( '\wp_delete_attachment' ) ) {\r\n                    \wp_delete_attachment( $media->ID, true );\r\n                    $deleted++;\r\n                }\r\n            }\r\n            \r\n            $results['cleaned']['orphaned_media'] = $deleted;\r\n        }\r\n        \r\n        return $results;\r\n    }\r\n    \r\n    /**\r\n     * Run comments cleanup\r\n     *\r\n     * @param array $options Cleanup options\r\n     * @return array Cleanup results\r\n     */\r\n    public function run_comments_cleanup( $options = array() ) {\r\n        global $wpdb;\r\n        \r\n        $results = array(\r\n            'success' => true,\r\n            'message' => \__( 'Comments cleanup completed successfully', WPCA_TEXT_DOMAIN ),\r\n            'cleaned' => array()\r\n        );\r\n        \r\n        // Set default options\r\n        $default_options = array(\r\n            'spam_comments' => true,\r\n            'trash_comments' => true,\r\n            'unapproved_comments' => false,\r\n            'old_comments' => false\r\n        );\r\n        \r\n        $options = ( function_exists( '\wp_parse_args' ) ? \wp_parse_args( $options, $default_options ) : array_merge( $default_options, $options ) );\r\n        \r\n        // Clean spam comments\r\n        if ( $options['spam_comments'] ) {\r\n            $deleted = $wpdb->query( "DELETE FROM {$wpdb->comments} WHERE comment_approved = 'spam'" );\r\n            $results['cleaned']['spam_comments'] = $deleted;\r\n        }\r\n        \r\n        // Clean trash comments\r\n        if ( $options['trash_comments'] ) {\r\n            $deleted = $wpdb->query( "DELETE FROM {$wpdb->comments} WHERE comment_approved = 'trash'" );\r\n            $results['cleaned']['trash_comments'] = $deleted;\r\n        }\r\n        \r\n        // Clean unapproved comments\r\n        if ( $options['unapproved_comments'] ) {\r\n            $deleted = $wpdb->query( "DELETE FROM {$wpdb->comments} WHERE comment_approved = '0'" );\r\n            $results['cleaned']['unapproved_comments'] = $deleted;\r\n        }\r\n        \r\n        // Clean old comments\r\n        if ( $options['old_comments'] ) {\r\n            $old_days = isset( $options['old_days'] ) ? intval( $options['old_days'] ) : 365;\r\n            $old_date = date( 'Y-m-d H:i:s', strtotime( "-{$old_days} days" ) );\r\n            $deleted = $wpdb->query( $wpdb->prepare( "DELETE FROM {$wpdb->comments} WHERE comment_date < %s", $old_date ) );\r\n            $results['cleaned']['old_comments'] = $deleted;\r\n        }\r\n        \r\n        return $results;\r\n    }\r\n    \r\n    /**\r\n     * Run content cleanup\r\n     *\r\n     * @param array $options Cleanup options\r\n     * @return array Cleanup results\r\n     */\r\n    public function run_content_cleanup( $options = array() ) {\r\n        global $wpdb;\r\n        \r\n        $results = array(\r\n            'success' => true,\r\n            'message' => \__( 'Content cleanup completed successfully', WPCA_TEXT_DOMAIN ),\r\n            'cleaned' => array()\r\n        );\r\n        \r\n        // Set default options\r\n        $default_options = array(\r\n            'unused_shortcodes' => true,\r\n            'empty_posts' => true,\r\n            'duplicate_posts' => false\r\n        );\r\n        \r\n        $options = ( function_exists( '\wp_parse_args' ) ? \wp_parse_args( $options, $default_options ) : array_merge( $default_options, $options ) );\r\n        \r\n        // Clean unused shortcodes\r\n        if ( $options['unused_shortcodes'] ) {\r\n            // This is a placeholder for actual shortcode cleanup\r\n            $results['cleaned']['unused_shortcodes'] = 0;\r\n        }\r\n        \r\n        // Clean empty posts\r\n        if ( $options['empty_posts'] ) {\r\n            $deleted = $wpdb->query( "DELETE FROM {$wpdb->posts} WHERE post_content = '' AND post_type = 'post' AND post_status = 'publish'" );\r\n            $results['cleaned']['empty_posts'] = $deleted;\r\n        }\r\n        \r\n        return $results;\r\n    }\r\n}