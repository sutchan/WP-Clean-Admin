<?php\r\n/**\r\n * WPCleanAdmin Database Class\r\n *\r\n * @package WPCleanAdmin\r\n * @version 1.7.15\r\n * @author Sut\r\n * @author URI: https://github.com/sutchan\r\n * @since 1.7.15\r\n */\r\nnamespace WPCleanAdmin;\r\n\r\nif ( ! defined( 'ABSPATH' ) ) {\r\n    exit;\r\n}\r\n\r\n/**\r\n * Database class\r\n */\r\nclass Database {\r\n    \r\n    /**\r\n     * Singleton instance\r\n     *\r\n     * @var Database\r\n     */\r\n    private static $instance;\r\n    \r\n    /**\r\n     * Get singleton instance\r\n     *\r\n     * @return Database\r\n     */\r\n    public static function getInstance() {\r\n        if ( ! isset( self::$instance ) ) {\r\n            self::$instance = new self();\r\n        }\r\n        return self::$instance;\r\n    }\r\n    \r\n    /**\r\n     * Constructor\r\n     */\r\n    private function __construct() {\r\n        $this->init();\r\n    }\r\n    \r\n    /**\r\n     * Initialize the database module\r\n     */\r\n    public function init() {\r\n        // Add database optimization hooks\r\n        if ( function_exists( 'add_action' ) ) {\r\n            \add_action( 'wpca_optimize_database', array( $this, 'optimize_database' ) );\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Get database information\r\n     *\r\n     * @return array Database information\r\n     */\r\n    public function get_database_info() {\r\n        global $wpdb;\r\n        \r\n        $info = array();\r\n        \r\n        // Get database name and version\r\n        $info['name'] = $wpdb->dbname;\r\n        $info['version'] = $wpdb->db_version();\r\n        \r\n        // Get table count\r\n        $info['table_count'] = $wpdb->get_var( $wpdb->prepare( "SELECT COUNT(*) FROM information_schema.TABLES WHERE table_schema = %s", $wpdb->dbname ) );\r\n        \r\n        // Get database size\r\n        $result = $wpdb->get_row( $wpdb->prepare( "SELECT SUM(data_length + index_length) AS size FROM information_schema.TABLES WHERE table_schema = %s", $wpdb->dbname ), ARRAY_A );\r\n        $info['size'] = ( function_exists( 'size_format' ) ? \size_format( $result['size'], 2 ) : round( $result['size'] / 1024 / 1024, 2 ) . ' MB' );\r\n        \r\n        // Get WordPress tables\r\n        $info['wp_tables'] = array();\r\n        $tables = $wpdb->get_results( $wpdb->prepare( "SHOW TABLES LIKE %s", $wpdb->prefix . '%' ), ARRAY_N );\r\n        \r\n        foreach ( $tables as $table ) {\r\n            $table_name = $table[0];\r\n            $table_info = $wpdb->get_row( $wpdb->prepare( "SELECT data_length, index_length FROM information_schema.TABLES WHERE table_schema = %s AND table_name = %s", $wpdb->dbname, $table_name ), ARRAY_A );\r\n            \r\n            $total_size = $table_info['data_length'] + $table_info['index_length'];\r\n            $data_size = $table_info['data_length'];\r\n            $index_size = $table_info['index_length'];\r\n            \r\n            $info['wp_tables'][] = array(\r\n                'name' => $table_name,\r\n                'size' => ( function_exists( 'size_format' ) ? \size_format( $total_size, 2 ) : round( $total_size / 1024 / 1024, 2 ) . ' MB' ),\r\n                'data_size' => ( function_exists( 'size_format' ) ? \size_format( $data_size, 2 ) : round( $data_size / 1024 / 1024, 2 ) . ' MB' ),\r\n                'index_size' => ( function_exists( 'size_format' ) ? \size_format( $index_size, 2 ) : round( $index_size / 1024 / 1024, 2 ) . ' MB' )\r\n            );\r\n        }\r\n        \r\n        return $info;\r\n    }\r\n    \r\n    /**\r\n     * Optimize database tables\r\n     *\r\n     * @return array Optimization results\r\n     */\r\n    public function optimize_database() {\r\n        global $wpdb;\r\n        \r\n        $results = array(\r\n            'success' => true,\r\n            'message' => \__( 'Database optimization completed successfully', WPCA_TEXT_DOMAIN ),\r\n            'tables' => array()\r\n        );\r\n        \r\n        // Get all WordPress tables\r\n        $tables = $wpdb->get_results( $wpdb->prepare( "SHOW TABLES LIKE %s", $wpdb->prefix . '%' ), ARRAY_N );\r\n        \r\n        foreach ( $tables as $table ) {\r\n            $table_name = $table[0];\r\n            $result = $wpdb->query( $wpdb->prepare( "OPTIMIZE TABLE %s", $table_name ) );\r\n            \r\n            $results['tables'][] = array(\r\n                'name' => $table_name,\r\n                'optimized' => $result !== false\r\n            );\r\n        }\r\n        \r\n        return $results;\r\n    }\r\n    \r\n    /**\r\n     * Backup database\r\n     *\r\n     * @param array $options Backup options\r\n     * @return array Backup results\r\n     */\r\n    public function backup_database( $options = array() ) {\r\n        global $wpdb;\r\n        \r\n        $results = array(\r\n            'success' => false,\r\n            'message' => \__( 'Database backup failed', WPCA_TEXT_DOMAIN )\r\n        );\r\n        \r\n        // Set default options\r\n        $default_options = array(\r\n            'tables' => 'all',\r\n            'format' => 'sql',\r\n            'compress' => true\r\n        );\r\n        \r\n        $options = ( function_exists( '\wp_parse_args' ) ? \wp_parse_args( $options, $default_options ) : array_merge( $default_options, $options ) );\r\n        \r\n        // Create backup directory if it doesn't exist\r\n        $backup_dir = WPCA_PLUGIN_DIR . 'backups/';\r\n        if ( ! file_exists( $backup_dir ) ) {\r\n            if ( function_exists( 'wp_mkdir_p' ) ) {\r\n                \wp_mkdir_p( $backup_dir );\r\n            } else {\r\n                // Fallback to mkdir with recursive flag\r\n                mkdir( $backup_dir, 0755, true );\r\n            }\r\n        }\r\n        \r\n        // Generate backup file name\r\n        $backup_file = $backup_dir . 'wpca-backup-' . date( 'Y-m-d-H-i-s' ) . '.' . $options['format'];\r\n        \r\n        // Get tables to backup\r\n        if ( $options['tables'] === 'all' ) {\r\n            $tables = $wpdb->get_results( $wpdb->prepare( "SHOW TABLES LIKE %s", $wpdb->prefix . '%' ), ARRAY_N );\r\n            $tables = array_column( $tables, 0 );\r\n        } else {\r\n            // Get all valid WordPress tables\r\n            $all_wp_tables = $wpdb->get_results( $wpdb->prepare( "SHOW TABLES LIKE %s", $wpdb->prefix . '%' ), ARRAY_N );\r\n            $all_wp_tables = array_column( $all_wp_tables, 0 );\r\n            \r\n            // Filter requested tables to only include valid WordPress tables\r\n            $requested_tables = explode( ',', $options['tables'] );\r\n            $tables = array();\r\n            \r\n            foreach ( $requested_tables as $table ) {\r\n                $table = trim( $table );\r\n                // Only include valid WordPress tables to prevent SQL injection\r\n                if ( in_array( $table, $all_wp_tables ) ) {\r\n                    $tables[] = $table;\r\n                }\r\n            }\r\n        }\r\n        \r\n        // Start backup\r\n        $backup_content = "-- WordPress Database Backup\n";\r\n        $backup_content .= "-- Generated by WP Clean Admin on " . date( 'Y-m-d H:i:s' ) . "\n";\r\n        $backup_content .= "-- Database: {$wpdb->dbname}\n\n";\r\n        \r\n        // Backup each table\r\n        foreach ( $tables as $table ) {\r\n            // Get table structure\r\n            $create_table = $wpdb->get_var( $wpdb->prepare( "SHOW CREATE TABLE %s", $table ) );\r\n            $backup_content .= "-- Table structure for table `{$table}`\n";\r\n            $backup_content .= "{$create_table};\n\n";\r\n            \r\n            // Get table data\r\n            $rows = $wpdb->get_results( $wpdb->prepare( "SELECT * FROM %s", $table ), ARRAY_A );\r\n            if ( count( $rows ) > 0 ) {\r\n                $backup_content .= "-- Dumping data for table `{$table}`\n";\r\n                $backup_content .= "INSERT INTO `{$table}` VALUES\n";\r\n                \r\n                $values = array();\r\n                foreach ( $rows as $row ) {\r\n                    $row_values = array();\r\n                    foreach ( $row as $value ) {\r\n                        $row_values[] = $wpdb->prepare( '%s', $value );\r\n                    }\r\n                    $values[] = "(" . implode( ',', $row_values ) . ")";\r\n                }\r\n                \r\n                $backup_content .= implode( ",\n", $values ) . ";\n\n";\r\n            }\r\n        }\r\n        \r\n        // Save backup file\r\n        if ( file_put_contents( $backup_file, $backup_content ) !== false ) {\r\n            $results['success'] = true;\r\n            $results['message'] = \__( 'Database backup created successfully', WPCA_TEXT_DOMAIN );\r\n            $results['file'] = basename( $backup_file );\r\n            $results['size'] = filesize( $backup_file );\r\n        }\r\n        \r\n        return $results;\r\n    }\r\n    \r\n    /**\r\n     * Restore database from backup\r\n     *\r\n     * @param string $backup_file Backup file name\r\n     * @return array Restore results\r\n     */\r\n    public function restore_database( $backup_file ) {\r\n        global $wpdb;\r\n        \r\n        $results = array(\r\n            'success' => false,\r\n            'message' => \__( 'Database restore failed', WPCA_TEXT_DOMAIN )\r\n        );\r\n        \r\n        // Get full backup file path\r\n        $backup_path = WPCA_PLUGIN_DIR . 'backups/' . $backup_file;\r\n        \r\n        // Check if backup file exists\r\n        if ( ! file_exists( $backup_path ) ) {\r\n            $results['message'] = \__( 'Backup file not found', WPCA_TEXT_DOMAIN );\r\n            return $results;\r\n        }\r\n        \r\n        // Read backup file content\r\n        $backup_content = file_get_contents( $backup_path );\r\n        \r\n        // Execute SQL queries\r\n        $queries = explode( ';', $backup_content );\r\n        $success = true;\r\n        \r\n        foreach ( $queries as $query ) {\r\n            $query = trim( $query );\r\n            if ( ! empty( $query ) ) {\r\n                if ( $wpdb->query( $query ) === false ) {\r\n                    $success = false;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        \r\n        if ( $success ) {\r\n            $results['success'] = true;\r\n            $results['message'] = \__( 'Database restore completed successfully', WPCA_TEXT_DOMAIN );\r\n        }\r\n        \r\n        return $results;\r\n    }\r\n    \r\n    /**\r\n     * Get database backups list\r\n     *\r\n     * @return array Database backups\r\n     */\r\n    public function get_database_backups() {\r\n        $backups = array();\r\n        \r\n        // Get backup directory\r\n        $backup_dir = WPCA_PLUGIN_DIR . 'backups/';\r\n        \r\n        // Check if backup directory exists\r\n        if ( ! file_exists( $backup_dir ) ) {\r\n            return $backups;\r\n        }\r\n        \r\n        // Get backup files\r\n        $files = glob( $backup_dir . '*.sql' );\r\n        \r\n        foreach ( $files as $file ) {\r\n            $backups[] = array(\r\n                'name' => basename( $file ),\r\n                'path' => $file,\r\n                'size' => filesize( $file ),\r\n                'modified' => filemtime( $file )\r\n            );\r\n        }\r\n        \r\n        // Sort backups by modified date (newest first)\r\n        usort( $backups, function( $a, $b ) {\r\n            return $b['modified'] - $a['modified'];\r\n        } );\r\n        \r\n        return $backups;\r\n    }\r\n    \r\n    /**\r\n     * Delete database backup\r\n     *\r\n     * @param string $backup_file Backup file name\r\n     * @return array Delete results\r\n     */\r\n    public function delete_database_backup( $backup_file ) {\r\n        $results = array(\r\n            'success' => false,\r\n            'message' => \__( 'Failed to delete backup file', WPCA_TEXT_DOMAIN )\r\n        );\r\n        \r\n        // Get full backup file path\r\n        $backup_path = WPCA_PLUGIN_DIR . 'backups/' . $backup_file;\r\n        \r\n        // Check if backup file exists\r\n        if ( file_exists( $backup_path ) ) {\r\n            // Delete backup file\r\n            if ( unlink( $backup_path ) ) {\r\n                $results['success'] = true;\r\n                $results['message'] = \__( 'Backup file deleted successfully', WPCA_TEXT_DOMAIN );\r\n            }\r\n        }\r\n        \r\n        return $results;\r\n    }\r\n}