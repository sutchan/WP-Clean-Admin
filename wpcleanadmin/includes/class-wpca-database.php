<?php\n/**\n * WP Clean Admin 数据库管理类\n *\n * 提供数据库优化与清理能力，包括表优化、孤儿数据清理、临时数据清理与统计。\n *\n * @package WP_Clean_Admin\n * @since 1.6.0\n * @version 1.7.13\n * @file wpcleanadmin/includes/class-wpca-database.php\n * @updated 2025-06-18\n */\n\nif (!defined('ABSPATH')) {\n    exit;\n}\n\n// 定义WordPress函数的回退实现，以防在非WordPress环境中运行\nif (!function_exists('absint')) {\n    /**\n     * 将值转换为非负整数\n     * @param mixed $value 要转换的值\n     * @return int 非负整数\n     */\n    function absint($value) {\n        return abs(intval($value));\n    }\n}\n\nif (!function_exists('wp_next_scheduled')) {\n    /**\n     * 获取计划任务的下次执行时间\n     * @param string $hook 任务钩子名称\n     * @param array $args 参数\n     * @return int|false 时间戳或false\n     */\n    function wp_next_scheduled($hook, $args = array()) {\n        // 在非WordPress环境中返回false\n        return false;\n    }\n}\n\nif (!function_exists('wp_schedule_event')) {\n    /**\n     * 计划一个定期任务\n     * @param int $timestamp 首次执行时间戳\n     * @param string $recurrence 重复间隔\n     * @param string $hook 任务钩子名称\n     * @param array $args 参数\n     * @return bool 是否成功\n     */\n    function wp_schedule_event($timestamp, $recurrence, $hook, $args = array()) {\n        // 在非WordPress环境中返回true，避免错误\n        return true;\n    }\n}\n\nif (!function_exists('wp_unschedule_event')) {\n    /**\n     * 取消一个计划任务\n     * @param int $timestamp 任务时间戳\n     * @param string $hook 任务钩子名称\n     * @param array $args 参数\n     * @return bool 是否成功\n     */\n    function wp_unschedule_event($timestamp, $hook, $args = array()) {\n        // 在非WordPress环境中返回true，避免错误\n        return true;\n    }\n}\n\nif (!function_exists('delete_expired_transients')) {\n    /**\n     * 删除所有过期的transients\n     * @return int 删除的数量\n     */\n    function delete_expired_transients() {\n        // 在非WordPress环境中返回0，避免错误\n        return 0;\n    }\n}\n\n/**\n * Class WPCA_Database\n * 数据库优化与清理的核心实现\n */\nclass WPCA_Database {\n    /**\n     * 单例实例\n     * @var WPCA_Database|null\n     */\n    protected static $instance = null;\n\n    /**\n     * WordPress 数据库对象\n     * @var wpdb\n     */\n    private $db;\n\n    /**\n     * 插件设置\n     * @var array\n     */\n    private $options = array();\n\n    /**\n     * WordPress 表前缀\n     * @var string\n     */\n    private $table_prefix = '';\n\n    /**\n     * 需要优化的表列表\n     * @var array\n     */\n    private $tables_to_optimize = array();\n\n    /**\n     * 清理项目配置\n     * @var array\n     */\n    private $cleanup_items = array();\n\n    /**\n     * 构造函数\n     * 初始化数据库优化功能并注册必要钩子\n     */\n    public function __construct() {\n        global $wpdb;\n\n        if (isset($wpdb) && is_object($wpdb)) {\n            $this->db = $wpdb;\n            $this->table_prefix = isset($wpdb->prefix) ? $wpdb->prefix : '';\n        }\n\n        if (class_exists('WPCA_Settings') && method_exists('WPCA_Settings', 'get_options')) {\n            $this->options = WPCA_Settings::get_options();\n        }\n\n        $this->initialize_config();\n        $this->register_hooks();\n    }\n\n    /**\n     * 获取单例实例\n     * @return WPCA_Database\n     */\n    public static function get_instance() {\n        if (self::$instance === null) {\n            self::$instance = new self();\n        }\n        return self::$instance;\n    }\n\n    /**\n     * 初始化数据库优化与清理的配置\n     */\n    private function initialize_config() {\n        $this->tables_to_optimize = array(\n            "{$this->table_prefix}posts",\n            "{$this->table_prefix}postmeta",\n            "{$this->table_prefix}comments",\n            "{$this->table_prefix}commentmeta",\n            "{$this->table_prefix}links",\n            "{$this->table_prefix}term_relationships",\n            "{$this->table_prefix}term_taxonomy",\n            "{$this->table_prefix}terms",\n            "{$this->table_prefix}options",\n            "{$this->table_prefix}users",\n            "{$this->table_prefix}usermeta"\n        );\n\n        if (isset($this->options['tables_to_optimize']) && is_array($this->options['tables_to_optimize'])) {\n            $custom_tables = array_filter($this->options['tables_to_optimize']);\n            if (!empty($custom_tables)) {\n                $this->tables_to_optimize = array_unique(array_merge($this->tables_to_optimize, $custom_tables));\n            }\n        }\n\n        // 获取清理项目设置\n        $cleanup_items_option = function_exists('get_option') ? get_option('wpca_cleanup_items', array()) : array();\n        \n        $this->cleanup_items = array(\n            'revision_posts' => array(\n                'enabled' => isset($cleanup_items_option['revision_posts']['enabled']) ? $cleanup_items_option['revision_posts']['enabled'] : (isset($this->options['cleanup_revisions']) && $this->options['cleanup_revisions']),\n                'days' => isset($cleanup_items_option['revision_posts']['days']) ? $cleanup_items_option['revision_posts']['days'] : (function_exists('absint') ? absint($this->options['revision_days'] ?? 30) : intval($this->options['revision_days'] ?? 30)),\n                'description' => function_exists('__') ? __('Remove old post revisions', 'wp-clean-admin') : 'Remove old post revisions'\n            ),\n            'auto_drafts' => array(\n                'enabled' => isset($cleanup_items_option['auto_drafts']['enabled']) ? $cleanup_items_option['auto_drafts']['enabled'] : (isset($this->options['cleanup_auto_drafts']) && $this->options['cleanup_auto_drafts']),\n                'description' => function_exists('__') ? __('Remove auto-saved drafts', 'wp-clean-admin') : 'Remove auto-saved drafts'\n            ),\n            'trashed_posts' => array(\n                'enabled' => isset($cleanup_items_option['trashed_posts']['enabled']) ? $cleanup_items_option['trashed_posts']['enabled'] : (isset($this->options['cleanup_trashed_posts']) && $this->options['cleanup_trashed_posts']),\n                'days' => isset($cleanup_items_option['trashed_posts']['days']) ? $cleanup_items_option['trashed_posts']['days'] : (function_exists('absint') ? absint($this->options['trashed_days'] ?? 30) : intval($this->options['trashed_days'] ?? 30)),\n                'description' => function_exists('__') ? __('Remove trashed posts', 'wp-clean-admin') : 'Remove trashed posts'\n            ),\n            'spam_comments' => array(\n                'enabled' => isset($cleanup_items_option['spam_comments']['enabled']) ? $cleanup_items_option['spam_comments']['enabled'] : (isset($this->options['cleanup_spam_comments']) && $this->options['cleanup_spam_comments']),\n                'days' => isset($cleanup_items_option['spam_comments']['days']) ? $cleanup_items_option['spam_comments']['days'] : (function_exists('absint') ? absint($this->options['spam_days'] ?? 7) : intval($this->options['spam_days'] ?? 7)),\n                'description' => function_exists('__') ? __('Remove spam comments', 'wp-clean-admin') : 'Remove spam comments'\n            ),\n            'trashed_comments' => array(\n                'enabled' => isset($cleanup_items_option['trashed_comments']['enabled']) ? $cleanup_items_option['trashed_comments']['enabled'] : (isset($this->options['cleanup_trashed_comments']) && $this->options['cleanup_trashed_comments']),\n                'days' => isset($cleanup_items_option['trashed_comments']['days']) ? $cleanup_items_option['trashed_comments']['days'] : (function_exists('absint') ? absint($this->options['trashed_comments_days'] ?? 30) : intval($this->options['trashed_comments_days'] ?? 30)),\n                'description' => function_exists('__') ? __('Remove trashed comments', 'wp-clean-admin') : 'Remove trashed comments'\n            ),\n            'pingbacks_trackbacks' => array(\n                'enabled' => isset($cleanup_items_option['pingbacks_trackbacks']['enabled']) ? $cleanup_items_option['pingbacks_trackbacks']['enabled'] : (isset($this->options['cleanup_pingbacks_trackbacks']) && $this->options['cleanup_pingbacks_trackbacks']),\n                'description' => function_exists('__') ? __('Remove pingbacks and trackbacks', 'wp-clean-admin') : 'Remove pingbacks and trackbacks'\n            ),\n            'orphaned_postmeta' => array(\n                'enabled' => isset($cleanup_items_option['orphaned_postmeta']['enabled']) ? $cleanup_items_option['orphaned_postmeta']['enabled'] : (isset($this->options['cleanup_orphaned_postmeta']) && $this->options['cleanup_orphaned_postmeta']),\n                'description' => function_exists('__') ? __('Remove orphaned postmeta entries', 'wp-clean-admin') : 'Remove orphaned postmeta entries'\n            ),\n            'orphaned_commentmeta' => array(\n                'enabled' => isset($cleanup_items_option['orphaned_commentmeta']['enabled']) ? $cleanup_items_option['orphaned_commentmeta']['enabled'] : (isset($this->options['cleanup_orphaned_commentmeta']) && $this->options['cleanup_orphaned_commentmeta']),\n                'description' => function_exists('__') ? __('Remove orphaned commentmeta entries', 'wp-clean-admin') : 'Remove orphaned commentmeta entries'\n            ),\n            'orphaned_relationships' => array(\n                'enabled' => isset($cleanup_items_option['orphaned_relationships']['enabled']) ? $cleanup_items_option['orphaned_relationships']['enabled'] : (isset($this->options['cleanup_orphaned_relationships']) && $this->options['cleanup_orphaned_relationships']),\n                'description' => function_exists('__') ? __('Remove orphaned term relationships', 'wp-clean-admin') : 'Remove orphaned term relationships'\n            ),\n            'orphaned_usermeta' => array(\n                'enabled' => isset($cleanup_items_option['orphaned_usermeta']['enabled']) ? $cleanup_items_option['orphaned_usermeta']['enabled'] : (isset($this->options['cleanup_orphaned_usermeta']) && $this->options['cleanup_orphaned_usermeta']),\n                'description' => function_exists('__') ? __('Remove orphaned usermeta entries', 'wp-clean-admin') : 'Remove orphaned usermeta entries'\n            ),\n            'expired_transients' => array(\n                'enabled' => isset($cleanup_items_option['expired_transients']['enabled']) ? $cleanup_items_option['expired_transients']['enabled'] : (isset($this->options['cleanup_expired_transients']) && $this->options['cleanup_expired_transients']),\n                'description' => function_exists('__') ? __('Remove expired transients', 'wp-clean-admin') : 'Remove expired transients'\n            ),\n            'all_transients' => array(\n                'enabled' => isset($cleanup_items_option['all_transients']['enabled']) ? $cleanup_items_option['all_transients']['enabled'] : (isset($this->options['cleanup_all_transients']) && $this->options['cleanup_all_transients']),\n                'description' => function_exists('__') ? __('Remove all transients (use with caution)', 'wp-clean-admin') : 'Remove all transients (use with caution)'\n            ),\n            'oembed_caches' => array(\n                'enabled' => isset($cleanup_items_option['oembed_caches']['enabled']) ? $cleanup_items_option['oembed_caches']['enabled'] : (isset($this->options['cleanup_oembed_caches']) && $this->options['cleanup_oembed_caches']),\n                'description' => function_exists('__') ? __('Remove oEmbed caches', 'wp-clean-admin') : 'Remove oEmbed caches'\n            )\n        );\n    }\n\n    /**\n     * 注册数据库优化与清理相关钩子\n     */\n    private function register_hooks() {\n        if (isset($this->options['enable_auto_cleanup']) && $this->options['enable_auto_cleanup'] && function_exists('add_action')) {\n            add_action('wpca_database_cleanup', array($this, 'run_auto_cleanup'));\n            if (function_exists('wp_next_scheduled') && function_exists('wp_schedule_event') && function_exists('time')) {\n                if (!wp_next_scheduled('wpca_database_cleanup')) {\n                    $interval = isset($this->options['cleanup_interval']) ? $this->options['cleanup_interval'] : 'weekly';\n                    wp_schedule_event(time(), $interval, 'wpca_database_cleanup');\n                }\n            }\n        }\n\n        if (function_exists('add_action')) {\n            add_action('wp_ajax_wpca_optimize_tables', array($this, 'ajax_optimize_tables'));\n            add_action('wp_ajax_wpca_cleanup_database', array($this, 'ajax_cleanup_database'));\n            add_action('wp_ajax_wpca_get_database_info', array($this, 'ajax_get_database_info'));\n            add_action('wp_ajax_wpca_get_cleanup_stats', array($this, 'ajax_get_cleanup_stats'));\n        }\n\n        if (function_exists('register_activation_hook')) {\n            if (defined('WPCA_MAIN_FILE')) { register_activation_hook(WPCA_MAIN_FILE, array($this, 'set_scheduled_cleanup')); }\n        }\n        if (function_exists('register_deactivation_hook')) {\n            if (defined('WPCA_MAIN_FILE')) { register_deactivation_hook(WPCA_MAIN_FILE, array($this, 'remove_scheduled_cleanup')); }\n        }\n    }\n\n    /**\n     * 获取清理项目配置\n     * @return array 清理项目配置\n     */\n    public function get_cleanup_items() {\n        return $this->cleanup_items;\n    }\n\n    /**\n     * 获取可用的清理项目配置（用于UI显示）\n     * @return array 可用的清理项目配置\n     */\n    public function get_available_cleanup_items() {\n        $available_items = array();\n        \n        foreach ($this->cleanup_items as $key => $item) {\n            // 生成标题\n            $title = '';\n            switch ($key) {\n                case 'revision_posts':\n                    $title = function_exists('__') ? __('Post Revisions', 'wp-clean-admin') : 'Post Revisions';\n                    break;\n                case 'auto_drafts':\n                    $title = function_exists('__') ? __('Auto Drafts', 'wp-clean-admin') : 'Auto Drafts';\n                    break;\n                case 'trashed_posts':\n                    $title = function_exists('__') ? __('Trashed Posts', 'wp-clean-admin') : 'Trashed Posts';\n                    break;\n                case 'spam_comments':\n                    $title = function_exists('__') ? __('Spam Comments', 'wp-clean-admin') : 'Spam Comments';\n                    break;\n                case 'trashed_comments':\n                    $title = function_exists('__') ? __('Trashed Comments', 'wp-clean-admin') : 'Trashed Comments';\n                    break;\n                case 'pingbacks_trackbacks':\n                    $title = function_exists('__') ? __('Pingbacks & Trackbacks', 'wp-clean-admin') : 'Pingbacks & Trackbacks';\n                    break;\n                case 'orphaned_postmeta':\n                    $title = function_exists('__') ? __('Orphaned Post Meta', 'wp-clean-admin') : 'Orphaned Post Meta';\n                    break;\n                case 'orphaned_commentmeta':\n                    $title = function_exists('__') ? __('Orphaned Comment Meta', 'wp-clean-admin') : 'Orphaned Comment Meta';\n                    break;\n                case 'orphaned_relationships':\n                    $title = function_exists('__') ? __('Orphaned Term Relationships', 'wp-clean-admin') : 'Orphaned Term Relationships';\n                    break;\n                case 'orphaned_usermeta':\n                    $title = function_exists('__') ? __('Orphaned User Meta', 'wp-clean-admin') : 'Orphaned User Meta';\n                    break;\n                case 'expired_transients':\n                    $title = function_exists('__') ? __('Expired Transients', 'wp-clean-admin') : 'Expired Transients';\n                    break;\n                case 'all_transients':\n                    $title = function_exists('__') ? __('All Transients', 'wp-clean-admin') : 'All Transients';\n                    break;\n                case 'oembed_caches':\n                    $title = function_exists('__') ? __('oEmbed Caches', 'wp-clean-admin') : 'oEmbed Caches';\n                    break;\n                default:\n                    $title = ucwords(str_replace('_', ' ', $key));\n                    break;\n            }\n            \n            $available_items[$key] = array(\n                'title' => $title,\n                'description' => $item['description'],\n                'requires_days' => isset($item['days']),\n                'default_days' => isset($item['days']) ? $item['days'] : 0\n            );\n        }\n        \n        return $available_items;\n    }\n\n    /**\n     * 设置计划任务：定期清理数据库\n     */\n    public function set_scheduled_cleanup() {\n        $this->remove_scheduled_cleanup();\n        if (function_exists('wp_schedule_event') && function_exists('time')) {\n            wp_schedule_event(time(), 'weekly', 'wpca_database_cleanup');\n        }\n    }\n\n    /**\n     * 移除计划任务：数据库清理\n     */\n    public function remove_scheduled_cleanup() {\n        if (function_exists('wp_next_scheduled') && function_exists('wp_unschedule_event')) {\n            $timestamp = wp_next_scheduled('wpca_database_cleanup');\n            if ($timestamp) {\n                wp_unschedule_event($timestamp, 'wpca_database_cleanup');\n            }\n        }\n    }\n\n    /**\n     * 运行自动数据库清理\n     */\n    public function run_auto_cleanup() {\n        // 获取保存的清理设置\n        $cleanup_items_option = function_exists('get_option') ? get_option('wpca_cleanup_items', array()) : array();\n        \n        // 合并默认配置和用户设置\n        $cleanup_items = $this->cleanup_items;\n        foreach ($cleanup_items as $key => $item) {\n            if (isset($cleanup_items_option[$key]['enabled'])) {\n                $cleanup_items[$key]['enabled'] = $cleanup_items_option[$key]['enabled'];\n            }\n            if (isset($cleanup_items_option[$key]['days'])) {\n                $cleanup_items[$key]['days'] = $cleanup_items_option[$key]['days'];\n            }\n        }\n        \n        $results = $this->cleanup_database($cleanup_items);\n        if (isset($this->options['log_cleanup_results']) && $this->options['log_cleanup_results'] && method_exists($this, 'log_cleanup_results')) {\n            $this->log_cleanup_results($results);\n        }\n        if (isset($this->options['notify_cleanup_complete']) && $this->options['notify_cleanup_complete'] && method_exists($this, 'send_cleanup_notification')) {\n            $this->send_cleanup_notification($results);\n        }\n    }\n\n    /**\n     * 记录清理结果\n     * @param array $results 清理结果\n     */\n    private function log_cleanup_results($results) {\n        // 在非WordPress环境中使用error_log记录\n        if (function_exists('error_log')) {\n            $log_message = 'WPCleanAdmin Database Cleanup Results: ' . print_r($results, true);\n            error_log($log_message);\n        }\n    }\n\n    /**\n     * 发送清理完成通知\n     * @param array $results 清理结果\n     */\n    private function send_cleanup_notification($results) {\n        // 在非WordPress环境中不发送通知\n        // 在WordPress环境中可以使用wp_mail发送邮件通知\n    }\n\n    /**\n     * 优化数据库表\n     *\n     * @param array $tables 指定优化的表，不传则使用默认列表\n     * @return array 优化结果\n     */\n    public function optimize_tables($tables = array()) {\n        if (!isset($this->db) || !is_object($this->db)) {\n            return array(\n                'success' => 0,\n                'failed' => 0,\n                'total' => 0,\n                'optimized_tables' => array(),\n                'errors' => array(__('Database object not available', 'wp-clean-admin'))\n            );\n        }\n\n        if (empty($tables)) {\n            $tables = $this->tables_to_optimize;\n        }\n\n        $results = array(\n            'success' => 0,\n            'failed' => 0,\n            'total' => function_exists('count') ? count($tables) : 0,\n            'optimized_tables' => array(),\n            'errors' => array()\n        );\n\n        foreach ($tables as $table) {\n            $safe_table = $this->sanitize_table_name($table);\n            if (empty($safe_table)) {\n                $results['errors'][] = function_exists('sprintf') && function_exists('__') ? sprintf(__('Invalid table name: %s', 'wp-clean-admin'), $table) : 'Invalid table name';\n                $results['failed']++;\n                continue;\n            }\n\n            if (method_exists($this->db, 'get_var') && method_exists($this->db, 'prepare')) {\n                $exists = $this->db->get_var($this->db->prepare('SHOW TABLES LIKE %s', $safe_table));\n                if (!$exists) {\n                    $results['errors'][] = function_exists('sprintf') && function_exists('__') ? sprintf(__('Table does not exist: %s', 'wp-clean-admin'), $safe_table) : 'Table does not exist';\n                    $results['failed']++;\n                    continue;\n                }\n            }\n\n            try {\n                $result = $this->db->query("OPTIMIZE TABLE `{$safe_table}`");\n                if ($result !== false) {\n                    $results['optimized_tables'][] = $safe_table;\n                    $results['success']++;\n                } else {\n                    $results['errors'][] = function_exists('sprintf') && function_exists('__') ? sprintf(__('Failed to optimize table: %s', 'wp-clean-admin'), $safe_table) : 'Failed to optimize table';\n                    $results['failed']++;\n                }\n            } catch (Exception $e) {\n                $results['errors'][] = function_exists('sprintf') && function_exists('__') ? sprintf(__('Error optimizing table %s: %s', 'wp-clean-admin'), $safe_table, $e->getMessage()) : 'Error optimizing table';\n                $results['failed']++;\n            }\n        }\n\n        return $results;\n    }\n\n    /**\n     * 清理数据库垃圾数据\n     *\n     * @param array $cleanup_items 清理项目配置\n     * @return array 清理结果\n     */\n    public function cleanup_database($cleanup_items = array()) {\n        if (!isset($this->db) || !is_object($this->db) || !method_exists($this->db, 'query')) {\n            return array(\n                'success' => false,\n                'removed' => 0,\n                'details' => array(),\n                'error' => function_exists('__') ? __('Database object not available', 'wp-clean-admin') : 'Database object not available'\n            );\n        }\n\n        if (empty($cleanup_items)) {\n            $cleanup_items = $this->cleanup_items;\n        }\n\n        $results = array(\n            'success' => true,\n            'removed' => 0,\n            'details' => array()\n        );\n\n        try {\n            $this->db->query('START TRANSACTION');\n\n            if (isset($cleanup_items['revision_posts']['enabled']) && $cleanup_items['revision_posts']['enabled']) {\n                $days = isset($cleanup_items['revision_posts']['days']) ? $cleanup_items['revision_posts']['days'] : 30;\n                $removed = $this->cleanup_old_revisions($days);\n                $results['removed'] += is_numeric($removed) ? $removed : 0;\n                $results['details']['revision_posts'] = is_numeric($removed) ? $removed : 0;\n            }\n\n            if (isset($cleanup_items['auto_drafts']['enabled']) && $cleanup_items['auto_drafts']['enabled']) {\n                $removed = $this->cleanup_auto_drafts();\n                $results['removed'] += is_numeric($removed) ? $removed : 0;\n                $results['details']['auto_drafts'] = is_numeric($removed) ? $removed : 0;\n            }\n\n            if (isset($cleanup_items['trashed_posts']['enabled']) && $cleanup_items['trashed_posts']['enabled']) {\n                $days = isset($cleanup_items['trashed_posts']['days']) ? $cleanup_items['trashed_posts']['days'] : 30;\n                $removed = $this->cleanup_trashed_posts($days);\n                $results['removed'] += is_numeric($removed) ? $removed : 0;\n                $results['details']['trashed_posts'] = is_numeric($removed) ? $removed : 0;\n            }\n\n            if (isset($cleanup_items['spam_comments']['enabled']) && $cleanup_items['spam_comments']['enabled']) {\n                $days = isset($cleanup_items['spam_comments']['days']) ? $cleanup_items['spam_comments']['days'] : 7;\n                $removed = $this->cleanup_spam_comments($days);\n                $results['removed'] += is_numeric($removed) ? $removed : 0;\n                $results['details']['spam_comments'] = is_numeric($removed) ? $removed : 0;\n            }\n\n            if (isset($cleanup_items['trashed_comments']['enabled']) && $cleanup_items['trashed_comments']['enabled']) {\n                $days = isset($cleanup_items['trashed_comments']['days']) ? $cleanup_items['trashed_comments']['days'] : 30;\n                $removed = $this->cleanup_trashed_comments($days);\n                $results['removed'] += is_numeric($removed) ? $removed : 0;\n                $results['details']['trashed_comments'] = is_numeric($removed) ? $removed : 0;\n            }\n\n            if (isset($cleanup_items['pingbacks_trackbacks']['enabled']) && $cleanup_items['pingbacks_trackbacks']['enabled']) {\n                $removed = $this->cleanup_pingbacks_trackbacks();\n                $results['removed'] += is_numeric($removed) ? $removed : 0;\n                $results['details']['pingbacks_trackbacks'] = is_numeric($removed) ? $removed : 0;\n            }\n\n            if (isset($cleanup_items['orphaned_postmeta']['enabled']) && $cleanup_items['orphaned_postmeta']['enabled']) {\n                $removed = $this->cleanup_orphaned_postmeta();\n                $results['removed'] += is_numeric($removed) ? $removed : 0;\n                $results['details']['orphaned_postmeta'] = is_numeric($removed) ? $removed : 0;\n            }\n\n            if (isset($cleanup_items['orphaned_commentmeta']['enabled']) && $cleanup_items['orphaned_commentmeta']['enabled']) {\n                $removed = $this->cleanup_orphaned_commentmeta();\n                $results['removed'] += is_numeric($removed) ? $removed : 0;\n                $results['details']['orphaned_commentmeta'] = is_numeric($removed) ? $removed : 0;\n            }\n\n            if (isset($cleanup_items['orphaned_relationships']['enabled']) && $cleanup_items['orphaned_relationships']['enabled']) {\n                $removed = $this->cleanup_orphaned_relationships();\n                $results['removed'] += is_numeric($removed) ? $removed : 0;\n                $results['details']['orphaned_relationships'] = is_numeric($removed) ? $removed : 0;\n            }\n\n            if (isset($cleanup_items['orphaned_usermeta']['enabled']) && $cleanup_items['orphaned_usermeta']['enabled']) {\n                $removed = $this->cleanup_orphaned_usermeta();\n                $results['removed'] += is_numeric($removed) ? $removed : 0;\n                $results['details']['orphaned_usermeta'] = is_numeric($removed) ? $removed : 0;\n            }\n\n            if (isset($cleanup_items['expired_transients']['enabled']) && $cleanup_items['expired_transients']['enabled']) {\n                $removed = $this->cleanup_expired_transients();\n                $results['removed'] += is_numeric($removed) ? $removed : 0;\n                $results['details']['expired_transients'] = is_numeric($removed) ? $removed : 0;\n            }\n\n            if (isset($cleanup_items['all_transients']['enabled']) && $cleanup_items['all_transients']['enabled']) {\n                $removed = $this->cleanup_all_transients();\n                $results['removed'] += is_numeric($removed) ? $removed : 0;\n                $results['details']['all_transients'] = is_numeric($removed) ? $removed : 0;\n            }\n\n            if (isset($cleanup_items['oembed_caches']['enabled']) && $cleanup_items['oembed_caches']['enabled']) {\n                $removed = $this->cleanup_oembed_caches();\n                $results['removed'] += is_numeric($removed) ? $removed : 0;\n                $results['details']['oembed_caches'] = is_numeric($removed) ? $removed : 0;\n            }\n\n            $this->db->query('COMMIT');\n        } catch (Exception $e) {\n            $this->db->query('ROLLBACK');\n            $results['success'] = false;\n            $results['error'] = function_exists('sprintf') && function_exists('__') ? sprintf(__('Database cleanup error: %s', 'wp-clean-admin'), $e->getMessage()) : 'Database cleanup error';\n        }\n\n        return $results;\n    }\n\n    /**\n     * 安全清理：旧修订版本\n     * @param int $days 天数阈值\n     * @return int 清理行数\n     */\n    private function cleanup_old_revisions($days) {\n        $days = function_exists('absint') ? absint($days) : intval($days);\n        $posts = $this->table_prefix . 'posts';\n        $sql = $this->db->prepare("DELETE FROM `{$posts}` WHERE post_type='revision' AND post_modified < DATE_SUB(NOW(), INTERVAL %d DAY)", $days);\n        $this->db->query($sql);\n        return isset($this->db->rows_affected) ? (int)$this->db->rows_affected : 0;\n    }\n\n    /**\n     * 清理自动草稿\n     * @return int 清理行数\n     */\n    private function cleanup_auto_drafts() {\n        $posts = $this->table_prefix . 'posts';\n        $sql = "DELETE FROM `{$posts}` WHERE post_status='auto-draft'";\n        $this->db->query($sql);\n        return isset($this->db->rows_affected) ? (int)$this->db->rows_affected : 0;\n    }\n\n    /**\n     * 清理回收站文章\n     * @param int $days 天数阈值\n     * @return int 清理行数\n     */\n    private function cleanup_trashed_posts($days) {\n        $days = function_exists('absint') ? absint($days) : intval($days);\n        $posts = $this->table_prefix . 'posts';\n        $sql = $this->db->prepare("DELETE FROM `{$posts}` WHERE post_status='trash' AND post_modified < DATE_SUB(NOW(), INTERVAL %d DAY)", $days);\n        $this->db->query($sql);\n        return isset($this->db->rows_affected) ? (int)$this->db->rows_affected : 0;\n    }\n\n    /**\n     * 清理垃圾评论\n     * @param int $days 天数阈值\n     * @return int 清理行数\n     */\n    private function cleanup_spam_comments($days) {\n        $days = function_exists('absint') ? absint($days) : intval($days);\n        $comments = $this->table_prefix . 'comments';\n        $sql = $this->db->prepare("DELETE FROM `{$comments}` WHERE comment_approved='spam' AND comment_date < DATE_SUB(NOW(), INTERVAL %d DAY)", $days);\n        $this->db->query($sql);\n        return isset($this->db->rows_affected) ? (int)$this->db->rows_affected : 0;\n    }\n\n    /**\n     * 清理回收站评论\n     * @param int $days 天数阈值\n     * @return int 清理行数\n     */\n    private function cleanup_trashed_comments($days) {\n        $days = function_exists('absint') ? absint($days) : intval($days);\n        $comments = $this->table_prefix . 'comments';\n        $sql = $this->db->prepare("DELETE FROM `{$comments}` WHERE comment_approved='trash' AND comment_date < DATE_SUB(NOW(), INTERVAL %d DAY)", $days);\n        $this->db->query($sql);\n        return isset($this->db->rows_affected) ? (int)$this->db->rows_affected : 0;\n    }\n\n    /**\n     * 清理 pingbacks/trackbacks\n     * @return int 清理行数\n     */\n    private function cleanup_pingbacks_trackbacks() {\n        $comments = $this->table_prefix . 'comments';\n        $sql = "DELETE FROM `{$comments}` WHERE comment_type IN ('pingback','trackback')";\n        $this->db->query($sql);\n        return isset($this->db->rows_affected) ? (int)$this->db->rows_affected : 0;\n    }\n\n    /**\n     * 清理孤儿 postmeta\n     * @return int 清理行数\n     */\n    private function cleanup_orphaned_postmeta() {\n        $postmeta = $this->table_prefix . 'postmeta';\n        $posts = $this->table_prefix . 'posts';\n        $sql = "DELETE pm FROM `{$postmeta}` pm LEFT JOIN `{$posts}` p ON pm.post_id = p.ID WHERE p.ID IS NULL";\n        $this->db->query($sql);\n        return isset($this->db->rows_affected) ? (int)$this->db->rows_affected : 0;\n    }\n\n    /**\n     * 清理孤儿 commentmeta\n     * @return int 清理行数\n     */\n    private function cleanup_orphaned_commentmeta() {\n        $commentmeta = $this->table_prefix . 'commentmeta';\n        $comments = $this->table_prefix . 'comments';\n        $sql = "DELETE cm FROM `{$commentmeta}` cm LEFT JOIN `{$comments}` c ON cm.comment_id = c.comment_ID WHERE c.comment_ID IS NULL";\n        $this->db->query($sql);\n        return isset($this->db->rows_affected) ? (int)$this->db->rows_affected : 0;\n    }\n\n    /**\n     * 清理孤儿 term_relationships\n     * @return int 清理行数\n     */\n    private function cleanup_orphaned_relationships() {\n        $relationships = $this->table_prefix . 'term_relationships';\n        $posts = $this->table_prefix . 'posts';\n        $sql = "DELETE tr FROM `{$relationships}` tr LEFT JOIN `{$posts}` p ON tr.object_id = p.ID WHERE p.ID IS NULL";\n        $this->db->query($sql);\n        return isset($this->db->rows_affected) ? (int)$this->db->rows_affected : 0;\n    }\n\n    /**\n     * 清理孤儿 usermeta\n     * @return int 清理行数\n     */\n    private function cleanup_orphaned_usermeta() {\n        $usermeta = $this->table_prefix . 'usermeta';\n        $users = $this->table_prefix . 'users';\n        $sql = "DELETE um FROM `{$usermeta}` um LEFT JOIN `{$users}` u ON um.user_id = u.ID WHERE u.ID IS NULL";\n        $this->db->query($sql);\n        return isset($this->db->rows_affected) ? (int)$this->db->rows_affected : 0;\n    }\n\n    /**\n     * 清理过期 transients\n     * @return int 清理数量（近似）\n     */\n    private function cleanup_expired_transients() {\n        if (function_exists('delete_expired_transients')) {\n            delete_expired_transients();\n            return 1;\n        }\n\n        $options = $this->table_prefix . 'options';\n        $expired = $this->db->get_results("SELECT option_name, option_value FROM `{$options}` WHERE option_name LIKE '_transient_timeout_%'");\n        $count = 0;\n        $now = time();\n        if (is_array($expired)) {\n            foreach ($expired as $row) {\n                $timeout = intval($row->option_value);\n                if ($timeout > 0 && $timeout < $now) {\n                    $key = substr($row->option_name, strlen('_transient_timeout_'));\n                    $this->db->query($this->db->prepare("DELETE FROM `{$options}` WHERE option_name IN (%s, %s)", '_transient_' . $key, '_transient_timeout_' . $key));\n                    $count += isset($this->db->rows_affected) ? (int)$this->db->rows_affected : 0;\n                }\n            }\n        }\n        return $count;\n    }\n\n    /**\n     * 清理全部 transients（谨慎使用）\n     * @return int 清理行数\n     */\n    private function cleanup_all_transients() {\n        $options = $this->table_prefix . 'options';\n        $sql = "DELETE FROM `{$options}` WHERE option_name LIKE '_transient_%' OR option_name LIKE '_site_transient_%'";\n        $this->db->query($sql);\n        return isset($this->db->rows_affected) ? (int)$this->db->rows_affected : 0;\n    }\n\n    /**\n     * 清理 oEmbed 缓存\n     * @return int 清理行数\n     */\n    private function cleanup_oembed_caches() {\n        $postmeta = $this->table_prefix . 'postmeta';\n        $sql = "DELETE FROM `{$postmeta}` WHERE meta_key LIKE '_oembed_%'";\n        $this->db->query($sql);\n        return isset($this->db->rows_affected) ? (int)$this->db->rows_affected : 0;\n    }\n\n    /**\n     * AJAX：优化数据表\n     */\n    public function ajax_optimize_tables() {\n        if (!function_exists('wp_send_json_error') || !function_exists('wp_send_json_success')) { return; }\n        if (function_exists('wp_doing_ajax') && !wp_doing_ajax()) { wp_send_json_error(array('message' => __('Invalid request', 'wp-clean-admin')), 400); return; }\n        if (!isset($_POST['nonce']) || (function_exists('wp_verify_nonce') && !wp_verify_nonce($_POST['nonce'], 'wpca_ajax_request'))) { wp_send_json_error(array('message' => __('Security verification failed', 'wp-clean-admin')), 403); return; }\n        if (!function_exists('current_user_can') || !current_user_can('manage_options')) { wp_send_json_error(array('message' => __('Insufficient permissions', 'wp-clean-admin')), 403); return; }\n\n        $tables = array();\n        if (isset($_POST['tables']) && is_array($_POST['tables'])) {\n            foreach ($_POST['tables'] as $t) {\n                if (is_string($t)) { $tables[] = $t; }\n            }\n        }\n        $r = $this->optimize_tables($tables);\n        $payload = array(\n            'successful_tables' => intval($r['success'] ?? 0),\n            'failed_tables' => intval($r['failed'] ?? 0),\n            'total_tables' => intval($r['total'] ?? 0),\n            'optimized_tables' => $r['optimized_tables'] ?? array(),\n            'errors' => $r['errors'] ?? array()\n        );\n        wp_send_json_success($payload);\n    }\n\n    /**\n     * AJAX：执行数据库清理\n     */\n    public function ajax_cleanup_database() {\n        if (!function_exists('wp_send_json_error') || !function_exists('wp_send_json_success')) { return; }\n        if (function_exists('wp_doing_ajax') && !wp_doing_ajax()) { wp_send_json_error(array('message' => __('Invalid request', 'wp-clean-admin')), 400); return; }\n        if (!isset($_POST['nonce']) || (function_exists('wp_verify_nonce') && !wp_verify_nonce($_POST['nonce'], 'wpca_ajax_request'))) { wp_send_json_error(array('message' => __('Security verification failed', 'wp-clean-admin')), 403); return; }\n        if (!function_exists('current_user_can') || !current_user_can('manage_options')) { wp_send_json_error(array('message' => __('Insufficient permissions', 'wp-clean-admin')), 403); return; }\n\n        // 获取保存的清理设置\n        $cleanup_items_option = function_exists('get_option') ? get_option('wpca_cleanup_items', array()) : array();\n        \n        // 合并默认配置和用户设置\n        $items = $this->cleanup_items;\n        foreach ($items as $key => $item) {\n            if (isset($cleanup_items_option[$key]['enabled'])) {\n                $items[$key]['enabled'] = $cleanup_items_option[$key]['enabled'];\n            }\n            if (isset($cleanup_items_option[$key]['days'])) {\n                $items[$key]['days'] = $cleanup_items_option[$key]['days'];\n            }\n        }\n        \n        $r = $this->cleanup_database($items);\n        $payload = array(\n            'total_items_removed' => intval($r['removed'] ?? 0),\n            'detailed_results' => $r['details'] ?? array(),\n            'success' => (bool)($r['success'] ?? false)\n        );\n        wp_send_json_success($payload);\n    }\n\n    /**\n     * AJAX：获取数据库信息（表大小与行数概览）\n     */\n    public function ajax_get_database_info() {\n        if (!function_exists('wp_send_json_error') || !function_exists('wp_send_json_success')) { return; }\n        if (function_exists('wp_doing_ajax') && !wp_doing_ajax()) { wp_send_json_error(array('message' => __('Invalid request', 'wp-clean-admin')), 400); return; }\n        if (!isset($_POST['nonce']) || (function_exists('wp_verify_nonce') && !wp_verify_nonce($_POST['nonce'], 'wpca_ajax_request'))) { wp_send_json_error(array('message' => __('Security verification failed', 'wp-clean-admin')), 403); return; }\n        if (!function_exists('current_user_can') || !current_user_can('manage_options')) { wp_send_json_error(array('message' => __('Insufficient permissions', 'wp-clean-admin')), 403); return; }\n\n        $info = array();\n        foreach ($this->tables_to_optimize as $table) {\n            $safe = $this->sanitize_table_name($table);\n            if (!$safe) { continue; }\n            $status = $this->db->get_row($this->db->prepare('SHOW TABLE STATUS LIKE %s', $safe));\n            if ($status) {\n                $info[$safe] = array(\n                    'rows' => intval($status->Rows ?? 0),\n                    'size' => intval(($status->Data_length ?? 0) + ($status->Index_length ?? 0))\n                );\n            }\n        }\n        wp_send_json_success(array('tables' => $info));\n    }\n\n    /**\n     * AJAX：获取清理统计（预估）\n     */\n    public function ajax_get_cleanup_stats() {\n        if (!function_exists('wp_send_json_error') || !function_exists('wp_send_json_success')) { return; }\n        if (function_exists('wp_doing_ajax') && !wp_doing_ajax()) { wp_send_json_error(array('message' => __('Invalid request', 'wp-clean-admin')), 400); return; }\n        if (!isset($_POST['nonce']) || (function_exists('wp_verify_nonce') && !wp_verify_nonce($_POST['nonce'], 'wpca_ajax_request'))) { wp_send_json_error(array('message' => __('Security verification failed', 'wp-clean-admin')), 403); return; }\n        if (!function_exists('current_user_can') || !current_user_can('manage_options')) { wp_send_json_error(array('message' => __('Insufficient permissions', 'wp-clean-admin')), 403); return; }\n\n        // 获取保存的清理设置\n        $cleanup_items_option = function_exists('get_option') ? get_option('wpca_cleanup_items', array()) : array();\n        \n        // 合并默认配置和用户设置\n        $cleanup_items = $this->cleanup_items;\n        foreach ($cleanup_items as $key => $item) {\n            if (isset($cleanup_items_option[$key]['enabled'])) {\n                $cleanup_items[$key]['enabled'] = $cleanup_items_option[$key]['enabled'];\n            }\n            if (isset($cleanup_items_option[$key]['days'])) {\n                $cleanup_items[$key]['days'] = $cleanup_items_option[$key]['days'];\n            }\n        }\n\n        $prefix = $this->table_prefix;\n        $stats = array();\n        $days_rev = $cleanup_items['revision_posts']['days'] ?? 30;\n        $days_trash_posts = $cleanup_items['trashed_posts']['days'] ?? 30;\n        $days_spam = $cleanup_items['spam_comments']['days'] ?? 7;\n        $days_trash_comments = $cleanup_items['trashed_comments']['days'] ?? 30;\n\n        $stats['revision_posts'] = intval($this->db->get_var($this->db->prepare("SELECT COUNT(1) FROM `{$prefix}posts` WHERE post_type='revision' AND post_modified < DATE_SUB(NOW(), INTERVAL %d DAY)", $days_rev)));\n        $stats['auto_drafts'] = intval($this->db->get_var("SELECT COUNT(1) FROM `{$prefix}posts` WHERE post_status='auto-draft'"));\n        $stats['trashed_posts'] = intval($this->db->get_var($this->db->prepare("SELECT COUNT(1) FROM `{$prefix}posts` WHERE post_status='trash' AND post_modified < DATE_SUB(NOW(), INTERVAL %d DAY)", $days_trash_posts)));\n        $stats['spam_comments'] = intval($this->db->get_var($this->db->prepare("SELECT COUNT(1) FROM `{$prefix}comments` WHERE comment_approved='spam' AND comment_date < DATE_SUB(NOW(), INTERVAL %d DAY)", $days_spam)));\n        $stats['trashed_comments'] = intval($this->db->get_var($this->db->prepare("SELECT COUNT(1) FROM `{$prefix}comments` WHERE comment_approved='trash' AND comment_date < DATE_SUB(NOW(), INTERVAL %d DAY)", $days_trash_comments)));\n        $stats['pingbacks_trackbacks'] = intval($this->db->get_var("SELECT COUNT(1) FROM `{$prefix}comments` WHERE comment_type IN ('pingback','trackback')"));\n        $stats['orphaned_postmeta'] = intval($this->db->get_var("SELECT COUNT(1) FROM `{$prefix}postmeta` pm LEFT JOIN `{$prefix}posts` p ON pm.post_id = p.ID WHERE p.ID IS NULL"));\n        $stats['orphaned_commentmeta'] = intval($this->db->get_var("SELECT COUNT(1) FROM `{$prefix}commentmeta` cm LEFT JOIN `{$prefix}comments` c ON cm.comment_id = c.comment_ID WHERE c.comment_ID IS NULL"));\n        $stats['orphaned_relationships'] = intval($this->db->get_var("SELECT COUNT(1) FROM `{$prefix}term_relationships` tr LEFT JOIN `{$prefix}posts` p ON tr.object_id = p.ID WHERE p.ID IS NULL"));\n        $stats['orphaned_usermeta'] = intval($this->db->get_var("SELECT COUNT(1) FROM `{$prefix}usermeta` um LEFT JOIN `{$prefix}users` u ON um.user_id = u.ID WHERE u.ID IS NULL"));\n        $stats['oembed_caches'] = intval($this->db->get_var("SELECT COUNT(1) FROM `{$prefix}postmeta` WHERE meta_key LIKE '_oembed_%'"));\n\n        wp_send_json_success(array('stats' => $stats));\n    }\n\n    /**\n     * 获取数据库信息（表大小与行数概览）\n     * @return array 包含表信息的数组\n     */\n    public function get_database_info() {\n        $info = array();\n        foreach ($this->tables_to_optimize as $table) {\n            $safe = $this->sanitize_table_name($table);\n            if (!$safe) { continue; }\n            $status = $this->db->get_row($this->db->prepare('SHOW TABLE STATUS LIKE %s', $safe));\n            if ($status) {\n                $info[$safe] = array(\n                    'rows' => intval($status->Rows ?? 0),\n                    'size' => intval(($status->Data_length ?? 0) + ($status->Index_length ?? 0))\n                );\n            }\n        }\n        return $info;\n    }\n\n    /**\n     * 获取清理统计（预估）\n     * @return array 包含清理统计的数组\n     */\n    public function get_cleanup_stats() {\n        // 获取保存的清理设置\n        $cleanup_items_option = function_exists('get_option') ? get_option('wpca_cleanup_items', array()) : array();\n        \n        // 合并默认配置和用户设置\n        $cleanup_items = $this->cleanup_items;\n        foreach ($cleanup_items as $key => $item) {\n            if (isset($cleanup_items_option[$key]['enabled'])) {\n                $cleanup_items[$key]['enabled'] = $cleanup_items_option[$key]['enabled'];\n            }\n            if (isset($cleanup_items_option[$key]['days'])) {\n                $cleanup_items[$key]['days'] = $cleanup_items_option[$key]['days'];\n            }\n        }\n\n        $prefix = $this->table_prefix;\n        $stats = array();\n        $days_rev = $cleanup_items['revision_posts']['days'] ?? 30;\n        $days_trash_posts = $cleanup_items['trashed_posts']['days'] ?? 30;\n        $days_spam = $cleanup_items['spam_comments']['days'] ?? 7;\n        $days_trash_comments = $cleanup_items['trashed_comments']['days'] ?? 30;\n\n        $stats['revision_posts'] = intval($this->db->get_var($this->db->prepare("SELECT COUNT(1) FROM `{$prefix}posts` WHERE post_type='revision' AND post_modified < DATE_SUB(NOW(), INTERVAL %d DAY)", $days_rev)));\n        $stats['auto_drafts'] = intval($this->db->get_var("SELECT COUNT(1) FROM `{$prefix}posts` WHERE post_status='auto-draft'"));\n        $stats['trashed_posts'] = intval($this->db->get_var($this->db->prepare("SELECT COUNT(1) FROM `{$prefix}posts` WHERE post_status='trash' AND post_modified < DATE_SUB(NOW(), INTERVAL %d DAY)", $days_trash_posts)));\n        $stats['spam_comments'] = intval($this->db->get_var($this->db->prepare("SELECT COUNT(1) FROM `{$prefix}comments` WHERE comment_approved='spam' AND comment_date < DATE_SUB(NOW(), INTERVAL %d DAY)", $days_spam)));\n        $stats['trashed_comments'] = intval($this->db->get_var($this->db->prepare("SELECT COUNT(1) FROM `{$prefix}comments` WHERE comment_approved='trash' AND comment_date < DATE_SUB(NOW(), INTERVAL %d DAY)", $days_trash_comments)));\n        $stats['pingbacks_trackbacks'] = intval($this->db->get_var("SELECT COUNT(1) FROM `{$prefix}comments` WHERE comment_type IN ('pingback','trackback')"));\n        $stats['orphaned_postmeta'] = intval($this->db->get_var("SELECT COUNT(1) FROM `{$prefix}postmeta` pm LEFT JOIN `{$prefix}posts` p ON pm.post_id = p.ID WHERE p.ID IS NULL"));\n        $stats['orphaned_commentmeta'] = intval($this->db->get_var("SELECT COUNT(1) FROM `{$prefix}commentmeta` cm LEFT JOIN `{$prefix}comments` c ON cm.comment_id = c.comment_ID WHERE c.comment_ID IS NULL"));\n        $stats['orphaned_relationships'] = intval($this->db->get_var("SELECT COUNT(1) FROM `{$prefix}term_relationships` tr LEFT JOIN `{$prefix}posts` p ON tr.object_id = p.ID WHERE p.ID IS NULL"));\n        $stats['orphaned_usermeta'] = intval($this->db->get_var("SELECT COUNT(1) FROM `{$prefix}usermeta` um LEFT JOIN `{$prefix}users` u ON um.user_id = u.ID WHERE u.ID IS NULL"));\n        $stats['oembed_caches'] = intval($this->db->get_var("SELECT COUNT(1) FROM `{$prefix}postmeta` WHERE meta_key LIKE '_oembed_%'"));\n\n        return $stats;\n    }\n\n    /**\n     * 表名安全处理（仅允许当前站点前缀与合法字符）\n     * @param string $table 原始表名\n     * @return string 安全表名或空字符串\n     */\n    private function sanitize_table_name($table) {\n        if (!is_string($table) || $table === '') { return ''; }\n        $pattern = '/^[a-zA-Z0-9_]+$/';\n        if (!preg_match($pattern, $table)) { return ''; }\n        if ($this->table_prefix && strpos($table, $this->table_prefix) !== 0) { return ''; }\n        return $table;\n    }\n}\n\n?>