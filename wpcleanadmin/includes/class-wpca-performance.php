<?php\r\n/**\r\n * WPCleanAdmin Performance Class\r\n *\r\n * @package WPCleanAdmin\r\n * @version 1.7.15\r\n * @author Sut\r\n * @author URI: https://github.com/sutchan\r\n * @since 1.7.15\r\n */\r\nnamespace WPCleanAdmin;\r\n\r\nif ( ! defined( 'ABSPATH' ) ) {\r\n    exit;\r\n}\r\n\r\n/**\r\n * Performance class\r\n */\r\nclass Performance {\r\n    \r\n    /**\r\n     * Singleton instance\r\n     *\r\n     * @var Performance\r\n     */\r\n    private static $instance;\r\n    \r\n    /**\r\n     * Get singleton instance\r\n     *\r\n     * @return Performance\r\n     */\r\n    public static function getInstance() {\r\n        if ( ! isset( self::$instance ) ) {\r\n            self::$instance = new self();\r\n        }\r\n        return self::$instance;\r\n    }\r\n    \r\n    /**\r\n     * Constructor\r\n     */\r\n    private function __construct() {\r\n        $this->init();\r\n    }\r\n    \r\n    /**\r\n     * Initialize the performance module\r\n     */\r\n    public function init() {\r\n        // Load settings\r\n        $settings = wpca_get_settings();\r\n        \r\n        // Apply performance optimizations based on settings\r\n        if ( isset( $settings['performance'] ) ) {\r\n            // Disable emojis\r\n            if ( isset( $settings['performance']['disable_emojis'] ) && $settings['performance']['disable_emojis'] ) {\r\n                $this->disable_emojis();\r\n            }\r\n            \r\n            // Disable XML-RPC\r\n            if ( isset( $settings['performance']['disable_xmlrpc'] ) && $settings['performance']['disable_xmlrpc'] ) {\r\n                $this->disable_xmlrpc();\r\n            }\r\n            \r\n            // Disable REST API\r\n            if ( isset( $settings['performance']['disable_rest_api'] ) && $settings['performance']['disable_rest_api'] ) {\r\n                $this->disable_rest_api();\r\n            }\r\n            \r\n            // Disable heartbeat\r\n            if ( isset( $settings['performance']['disable_heartbeat'] ) && $settings['performance']['disable_heartbeat'] ) {\r\n                $this->disable_heartbeat();\r\n            }\r\n            \r\n            // Optimize database\r\n            if ( isset( $settings['performance']['optimize_database'] ) && $settings['performance']['optimize_database'] ) {\r\n                $this->optimize_database();\r\n            }\r\n            \r\n            // Clean transients\r\n            if ( isset( $settings['performance']['clean_transients'] ) && $settings['performance']['clean_transients'] ) {\r\n                $this->clean_transients();\r\n            }\r\n        }\r\n        \r\n        // Add performance hooks\r\n        \add_action( 'wpca_clear_cache', array( $this, 'clear_cache' ) );\r\n    }\r\n    \r\n    /**\r\n     * Disable WordPress emojis\r\n     */\r\n    public function disable_emojis() {\r\n        // Remove emoji actions\r\n        if ( function_exists( 'remove_action' ) ) {\r\n            remove_action( 'admin_print_styles', 'print_emoji_styles' );\r\n            remove_action( 'wp_head', 'print_emoji_detection_script', 7 );\r\n            remove_action( 'admin_print_scripts', 'print_emoji_detection_script' );\r\n            remove_action( 'wp_print_styles', 'print_emoji_styles' );\r\n        }\r\n        \r\n        if ( function_exists( 'remove_filter' ) ) {\r\n            remove_filter( 'wp_mail', 'wp_staticize_emoji_for_email' );\r\n            remove_filter( 'the_content_feed', 'wp_staticize_emoji' );\r\n            remove_filter( 'comment_text_rss', 'wp_staticize_emoji' );\r\n        }\r\n        \r\n        // Disable emoji TinyMCE plugin\r\n        \add_filter( 'tiny_mce_plugins', array( $this, 'disable_emojis_tinymce' ) );\r\n    }\r\n    \r\n    /**\r\n     * Disable emojis in TinyMCE\r\n     *\r\n     * @param array $plugins TinyMCE plugins\r\n     * @return array Modified TinyMCE plugins\r\n     */\r\n    public function disable_emojis_tinymce( $plugins ) {\r\n        if ( is_array( $plugins ) ) {\r\n            return array_diff( $plugins, array( 'wpemoji' ) );\r\n        }\r\n        return $plugins;\r\n    }\r\n    \r\n    /**\r\n     * Disable XML-RPC\r\n     */\r\n    public function disable_xmlrpc() {\r\n        // Disable XML-RPC methods\r\n        \add_filter( 'xmlrpc_enabled', '__return_false' );\r\n        \add_filter( 'xmlrpc_methods', '__return_empty_array' );\r\n        \r\n        // Remove XML-RPC headers\r\n        if ( function_exists( 'remove_action' ) ) {\r\n            remove_action( 'wp_head', 'rsd_link' );\r\n            remove_action( 'wp_head', 'wlwmanifest_link' );\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Disable REST API\r\n     */\r\n    public function disable_rest_api() {\r\n        // Disable REST API for non-authenticated users\r\n        \add_filter( 'rest_authentication_errors', array( $this, 'disable_rest_api_authentication' ) );\r\n    }\r\n    \r\n    /**\r\n     * Disable REST API authentication\r\n     *\r\n     * @param WP_Error|bool $result Authentication result\r\n     * @return WP_Error|bool Modified authentication result\r\n     */\r\n    public function disable_rest_api_authentication( $result ) {\r\n        if ( function_exists( 'is_user_logged_in' ) && ! is_user_logged_in() ) {\r\n            return new \WP_Error( 'rest_not_logged_in', \__( 'REST API is disabled for non-authenticated users', WPCA_TEXT_DOMAIN ), array( 'status' => 401 ) );\r\n        }\r\n        return $result;\r\n    }\r\n    \r\n    /**\r\n     * Disable heartbeat\r\n     */\r\n    public function disable_heartbeat() {\r\n        // Remove heartbeat actions\r\n        if ( function_exists( 'remove_action' ) ) {\r\n            remove_action( 'admin_enqueue_scripts', 'wp_enqueue_heartbeat' );\r\n            remove_action( 'wp_enqueue_scripts', 'wp_enqueue_heartbeat' );\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Optimize database\r\n     */\r\n    public function optimize_database() {\r\n        // Schedule database optimization\r\n        if ( function_exists( '\wp_next_scheduled' ) && function_exists( '\wp_schedule_event' ) ) {\r\n            if ( ! \wp_next_scheduled( 'wpca_optimize_database' ) ) {\r\n                \wp_schedule_event( time(), 'weekly', 'wpca_optimize_database' );\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Clean transients\r\n     */\r\n    public function clean_transients() {\r\n        // Schedule transient cleanup\r\n        if ( function_exists( '\wp_next_scheduled' ) && function_exists( '\wp_schedule_event' ) ) {\r\n            if ( ! \wp_next_scheduled( 'wpca_clean_transients' ) ) {\r\n                \wp_schedule_event( time(), 'daily', 'wpca_clean_transients' );\r\n            }\r\n        }\r\n        \r\n        // Add transient cleanup hook\r\n        \add_action( 'wpca_clean_transients', array( $this, 'run_transient_cleanup' ) );\r\n    }\r\n    \r\n    /**\r\n     * Run transient cleanup\r\n     */\r\n    public function run_transient_cleanup() {\r\n        global $wpdb;\r\n        \r\n        // Delete expired transients\r\n        $wpdb->query( $wpdb->prepare( "DELETE FROM {$wpdb->options} WHERE option_name LIKE %s AND option_value < %d", '%_transient_timeout_%', time() ) );\r\n        $wpdb->query( $wpdb->prepare( "DELETE t1 FROM {$wpdb->options} t1 INNER JOIN {$wpdb->options} t2 ON t1.option_name = CONCAT( '_transient_', SUBSTRING( t2.option_name, 19 ) ) WHERE t2.option_name LIKE %s", '%_transient_timeout_%' ) );\r\n    }\r\n    \r\n    /**\r\n     * Clear cache\r\n     *\r\n     * @return array Cache clearing results\r\n     */\r\n    public function clear_cache() {\r\n        $results = array(\r\n            'success' => true,\r\n            'message' => \__( 'Cache cleared successfully', WPCA_TEXT_DOMAIN ),\r\n            'caches' => array()\r\n        );\r\n        \r\n        // Clear WordPress object cache\r\n        if ( function_exists( '\wp_cache_flush' ) ) {\r\n            \wp_cache_flush();\r\n            $results['caches'][] = array(\r\n                'name' => \__( 'WordPress Object Cache', WPCA_TEXT_DOMAIN ),\r\n                'cleared' => true\r\n            );\r\n        }\r\n        \r\n        // Clear transients\r\n        $this->run_transient_cleanup();\r\n        $results['caches'][] = array(\r\n            'name' => \__( 'Transients', WPCA_TEXT_DOMAIN ),\r\n            'cleared' => true\r\n        );\r\n        \r\n        // Clear opcode cache if available\r\n        if ( function_exists( '\opcache_reset' ) ) {\r\n            \opcache_reset();\r\n            $results['caches'][] = array(\r\n                'name' => \__( 'OPcache', WPCA_TEXT_DOMAIN ),\r\n                'cleared' => true\r\n            );\r\n        }\r\n        \r\n        return $results;\r\n    }\r\n    \r\n    /**\r\n     * Get performance statistics\r\n     *\r\n     * @return array Performance statistics\r\n     */\r\n    public function get_performance_stats() {\r\n        global $wpdb;\r\n        \r\n        $stats = array();\r\n        \r\n        // Get PHP memory usage\r\n        $stats['memory_usage'] = array(\r\n            'current' => \size_format( \memory_get_usage() ),\r\n            'peak' => \size_format( \memory_get_peak_usage() ),\r\n            'limit' => \ini_get( 'memory_limit' )\r\n        );\r\n        \r\n        // Get database query count\r\n        $stats['query_count'] = function_exists( '\get_num_queries' ) ? \get_num_queries() : 0;\r\n        \r\n        // Get page load time\r\n        $stats['load_time'] = function_exists( '\timer_stop' ) ? \timer_stop( 0, 3 ) . 's' : '0.000s';\r\n        \r\n        // Get transients count\r\n        $stats['transients_count'] = $wpdb->get_var( "SELECT COUNT(*) FROM {$wpdb->options} WHERE option_name LIKE '%transient%'" );\r\n        \r\n        // Get cache status\r\n        $stats['cache_status'] = array(\r\n            'object_cache' => function_exists( '\wp_cache_get' ) ? \__( 'Enabled', WPCA_TEXT_DOMAIN ) : \__( 'Disabled', WPCA_TEXT_DOMAIN ),\r\n            'opcache' => function_exists( '\opcache_get_status' ) ? \__( 'Enabled', WPCA_TEXT_DOMAIN ) : \__( 'Disabled', WPCA_TEXT_DOMAIN )\r\n        );\r\n        \r\n        return $stats;\r\n    }\r\n    \r\n    /**\r\n     * Optimize resources\r\n     */\r\n    public function optimize_resources() {\r\n        // Load settings\r\n        $settings = wpca_get_settings();\r\n        \r\n        if ( isset( $settings['performance'] ) ) {\r\n            // Minify CSS and JS\r\n            if ( isset( $settings['performance']['minify_resources'] ) && $settings['performance']['minify_resources'] ) {\r\n                \add_filter( 'style_loader_tag', array( $this, 'minify_css' ) );\r\n                \add_filter( 'script_loader_tag', array( $this, 'minify_js' ) );\r\n            }\r\n            \r\n            // Combine CSS and JS\r\n            if ( isset( $settings['performance']['combine_resources'] ) && $settings['performance']['combine_resources'] ) {\r\n                \add_filter( 'stylesheet_uri', array( $this, 'combine_css' ) );\r\n                \add_filter( 'script_uri', array( $this, 'combine_js' ) );\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Minify CSS\r\n     *\r\n     * @param string $tag CSS tag\r\n     * @return string Modified CSS tag\r\n     */\r\n    public function minify_css( $tag ) {\r\n        // This is a placeholder for actual CSS minification\r\n        return $tag;\r\n    }\r\n    \r\n    /**\r\n     * Minify JS\r\n     *\r\n     * @param string $tag JS tag\r\n     * @return string Modified JS tag\r\n     */\r\n    public function minify_js( $tag ) {\r\n        // This is a placeholder for actual JS minification\r\n        return $tag;\r\n    }\r\n    \r\n    /**\r\n     * Combine CSS\r\n     *\r\n     * @param string $uri CSS URI\r\n     * @return string Modified CSS URI\r\n     */\r\n    public function combine_css( $uri ) {\r\n        // This is a placeholder for actual CSS combination\r\n        return $uri;\r\n    }\r\n    \r\n    /**\r\n     * Combine JS\r\n     *\r\n     * @param string $uri JS URI\r\n     * @return string Modified JS URI\r\n     */\r\n    public function combine_js( $uri ) {\r\n        // This is a placeholder for actual JS combination\r\n        return $uri;\r\n    }\r\n}