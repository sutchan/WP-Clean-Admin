<?php\r\n/**\r\n * WPCleanAdmin Login Class\r\n *\r\n * @package WPCleanAdmin\r\n * @version 1.7.15\r\n * @author Sut\r\n * @author URI: https://github.com/sutchan\r\n * @since 1.7.15\r\n */\r\nnamespace WPCleanAdmin;\r\n\r\nif ( ! defined( 'ABSPATH' ) ) {\r\n    exit;\r\n}\r\n\r\n/**\r\n * Login class\r\n */\r\nclass Login {\r\n    \r\n    /**\r\n     * Singleton instance\r\n     *\r\n     * @var Login\r\n     */\r\n    private static $instance;\r\n    \r\n    /**\r\n     * Get singleton instance\r\n     *\r\n     * @return Login\r\n     */\r\n    public static function getInstance() {\r\n        if ( ! isset( self::$instance ) ) {\r\n            self::$instance = new self();\r\n        }\r\n        return self::$instance;\r\n    }\r\n    \r\n    /**\r\n     * Constructor\r\n     */\r\n    private function __construct() {\r\n        $this->init();\r\n    }\r\n    \r\n    /**\r\n     * Initialize the login module\r\n     */\r\n    public function init() {\r\n        // Add login hooks\r\n        if ( function_exists( 'add_action' ) && function_exists( 'add_filter' ) ) {\r\n            \add_action( 'login_enqueue_scripts', array( $this, 'enqueue_login_scripts' ) );\r\n            \add_filter( 'login_headerurl', array( $this, 'filter_login_header_url' ) );\r\n            \add_filter( 'login_headertitle', array( $this, 'filter_login_header_title' ) );\r\n            \add_action( 'login_footer', array( $this, 'add_login_footer_content' ) );\r\n            \add_filter( 'login_body_class', array( $this, 'filter_login_body_class' ) );\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Enqueue login scripts and styles\r\n     */\r\n    public function enqueue_login_scripts() {\r\n        // Load settings\r\n        $settings = wpca_get_settings();\r\n        \r\n        // Enqueue custom login styles if enabled\r\n        if ( isset( $settings['login'] ) && isset( $settings['login']['custom_login_styles'] ) && $settings['login']['custom_login_styles'] ) {\r\n            // Enqueue login CSS\r\n            if ( function_exists( '\wp_enqueue_style' ) ) {\r\n                \wp_enqueue_style(\r\n                    'wpca-login',\r\n                    WPCA_PLUGIN_URL . 'assets/css/wpca-login.css',\r\n                    array(),\r\n                    WPCA_VERSION\r\n                );\r\n            }\r\n            \r\n            // Enqueue login JS\r\n            if ( function_exists( '\wp_enqueue_script' ) ) {\r\n                \wp_enqueue_script(\r\n                    'wpca-login',\r\n                    WPCA_PLUGIN_URL . 'assets/js/wpca-login.js',\r\n                    array( 'jquery' ),\r\n                    WPCA_VERSION,\r\n                    true\r\n                );\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Filter login header URL\r\n     *\r\n     * @param string $url Login header URL\r\n     * @return string Modified URL\r\n     */\r\n    public function filter_login_header_url( $url ) {\r\n        // Load settings\r\n        $settings = wpca_get_settings();\r\n        \r\n        // Change login header URL if custom URL is set\r\n        if ( isset( $settings['login'] ) && isset( $settings['login']['login_header_url'] ) && ! empty( $settings['login']['login_header_url'] ) ) {\r\n            return ( function_exists( 'esc_url' ) ? \esc_url( $settings['login']['login_header_url'] ) : $settings['login']['login_header_url'] );\r\n        }\r\n        \r\n        return $url;\r\n    }\r\n    \r\n    /**\r\n     * Filter login header title\r\n     *\r\n     * @param string $title Login header title\r\n     * @return string Modified title\r\n     */\r\n    public function filter_login_header_title( $title ) {\r\n        // Load settings\r\n        $settings = wpca_get_settings();\r\n        \r\n        // Change login header title if custom title is set\r\n        if ( isset( $settings['login'] ) && isset( $settings['login']['login_header_title'] ) && ! empty( $settings['login']['login_header_title'] ) ) {\r\n            return ( function_exists( 'esc_html' ) ? \esc_html( $settings['login']['login_header_title'] ) : $settings['login']['login_header_title'] );\r\n        }\r\n        \r\n        return $title;\r\n    }\r\n    \r\n    /**\r\n     * Add login footer content\r\n     */\r\n    public function add_login_footer_content() {\r\n        // Load settings\r\n        $settings = wpca_get_settings();\r\n        \r\n        // Add custom footer content if set\r\n        if ( isset( $settings['login'] ) && isset( $settings['login']['login_footer_content'] ) && ! empty( $settings['login']['login_footer_content'] ) ) {\r\n            echo ( function_exists( '\wp_kses_post' ) ? \wp_kses_post( $settings['login']['login_footer_content'] ) : $settings['login']['login_footer_content'] );\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Filter login body class\r\n     *\r\n     * @param array $classes Body classes\r\n     * @return array Modified classes\r\n     */\r\n    public function filter_login_body_class( $classes ) {\r\n        // Load settings\r\n        $settings = wpca_get_settings();\r\n        \r\n        // Add custom body class if set\r\n        if ( isset( $settings['login'] ) && isset( $settings['login']['login_body_class'] ) && ! empty( $settings['login']['login_body_class'] ) ) {\r\n            $classes[] = ( function_exists( '\sanitize_html_class' ) ? \sanitize_html_class( $settings['login']['login_body_class'] ) : $settings['login']['login_body_class'] );\r\n        }\r\n        \r\n        return $classes;\r\n    }\r\n    \r\n    /**\r\n     * Customize login page\r\n     */\r\n    public function customize_login_page() {\r\n        // Load settings\r\n        $settings = wpca_get_settings();\r\n        \r\n        // Customize login page based on settings\r\n        if ( isset( $settings['login'] ) && function_exists( 'add_action' ) ) {\r\n            // Change login logo\r\n            if ( isset( $settings['login']['custom_login_logo'] ) && $settings['login']['custom_login_logo'] && isset( $settings['login']['login_logo_url'] ) && ! empty( $settings['login']['login_logo_url'] ) ) {\r\n                \add_action( 'login_head', array( $this, 'add_custom_login_logo' ) );\r\n            }\r\n            \r\n            // Change login background\r\n            if ( isset( $settings['login']['custom_login_background'] ) && $settings['login']['custom_login_background'] && isset( $settings['login']['login_background_url'] ) && ! empty( $settings['login']['login_background_url'] ) ) {\r\n                \add_action( 'login_head', array( $this, 'add_custom_login_background' ) );\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Add custom login logo\r\n     */\r\n    public function add_custom_login_logo() {\r\n        // Load settings\r\n        $settings = wpca_get_settings();\r\n        \r\n        if ( isset( $settings['login'] ) && isset( $settings['login']['login_logo_url'] ) && ! empty( $settings['login']['login_logo_url'] ) ) {\r\n            $logo_url = ( function_exists( 'esc_url' ) ? \esc_url( $settings['login']['login_logo_url'] ) : $settings['login']['login_logo_url'] );\r\n            $logo_width = isset( $settings['login']['login_logo_width'] ) ? ( function_exists( 'esc_attr' ) ? \esc_attr( $settings['login']['login_logo_width'] ) : $settings['login']['login_logo_width'] ) : '200px';\r\n            $logo_height = isset( $settings['login']['login_logo_height'] ) ? ( function_exists( 'esc_attr' ) ? \esc_attr( $settings['login']['login_logo_height'] ) : $settings['login']['login_logo_height'] ) : '80px';\r\n            \r\n            echo "<style type='text/css'>\r\n                #login h1 a {\r\n                    background-image: url('{$logo_url}');\r\n                    background-size: contain;\r\n                    width: {$logo_width};\r\n                    height: {$logo_height};\r\n                }\r\n            </style>";\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Add custom login background\r\n     */\r\n    public function add_custom_login_background() {\r\n        // Load settings\r\n        $settings = wpca_get_settings();\r\n        \r\n        if ( isset( $settings['login'] ) && isset( $settings['login']['login_background_url'] ) && ! empty( $settings['login']['login_background_url'] ) ) {\r\n            $background_url = ( function_exists( 'esc_url' ) ? \esc_url( $settings['login']['login_background_url'] ) : $settings['login']['login_background_url'] );\r\n            $background_repeat = isset( $settings['login']['login_background_repeat'] ) ? ( function_exists( 'esc_attr' ) ? \esc_attr( $settings['login']['login_background_repeat'] ) : $settings['login']['login_background_repeat'] ) : 'no-repeat';\r\n            $background_position = isset( $settings['login']['login_background_position'] ) ? ( function_exists( 'esc_attr' ) ? \esc_attr( $settings['login']['login_background_position'] ) : $settings['login']['login_background_position'] ) : 'center center';\r\n            $background_size = isset( $settings['login']['login_background_size'] ) ? ( function_exists( 'esc_attr' ) ? \esc_attr( $settings['login']['login_background_size'] ) : $settings['login']['login_background_size'] ) : 'cover';\r\n            \r\n            echo "<style type='text/css'>\r\n                body.login {\r\n                    background-image: url('{$background_url}');\r\n                    background-repeat: {$background_repeat};\r\n                    background-position: {$background_position};\r\n                    background-size: {$background_size};\r\n                }\r\n            </style>";\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Restrict login attempts\r\n     */\r\n    public function restrict_login_attempts() {\r\n        // Load settings\r\n        $settings = wpca_get_settings();\r\n        \r\n        // Restrict login attempts if enabled\r\n        if ( isset( $settings['login'] ) && isset( $settings['login']['restrict_login_attempts'] ) && $settings['login']['restrict_login_attempts'] ) {\r\n            // Add login attempt restriction hooks\r\n            if ( function_exists( 'add_filter' ) && function_exists( 'add_action' ) ) {\r\n                \add_filter( 'authenticate', array( $this, 'check_login_attempts' ), 30, 3 );\r\n                \add_action( 'wp_login_failed', array( $this, 'log_failed_login' ) );\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Check login attempts\r\n     *\r\n     * @param WP_User|WP_Error $user User object or error\r\n     * @param string $username Username\r\n     * @param string $password Password\r\n     * @return WP_User|WP_Error Modified user or error\r\n     */\r\n    public function check_login_attempts( $user, $username, $password ) {\r\n        // Load settings\r\n        $settings = wpca_get_settings();\r\n        \r\n        // Get max login attempts\r\n        $max_attempts = isset( $settings['login']['max_login_attempts'] ) ? intval( $settings['login']['max_login_attempts'] ) : 5;\r\n        \r\n        // Get lockout duration\r\n        $lockout_duration = isset( $settings['login']['lockout_duration'] ) ? intval( $settings['login']['lockout_duration'] ) : 300;\r\n        \r\n        // Get user IP\r\n        $user_ip = $_SERVER['REMOTE_ADDR'];\r\n        \r\n        // Get login attempts\r\n        $login_attempts = ( function_exists( '\get_transient' ) ? \get_transient( 'wpca_login_attempts_' . $user_ip ) : 0 );\r\n        \r\n        // Check if user is locked out\r\n        if ( $login_attempts >= $max_attempts ) {\r\n            return new \WP_Error( 'too_many_attempts', \__( 'Too many login attempts. Please try again later.', WPCA_TEXT_DOMAIN ) );\r\n        }\r\n        \r\n        return $user;\r\n    }\r\n    \r\n    /**\r\n     * Log failed login attempts\r\n     *\r\n     * @param string $username Username\r\n     */\r\n    public function log_failed_login( $username ) {\r\n        // Get user IP\r\n        $user_ip = $_SERVER['REMOTE_ADDR'];\r\n        \r\n        // Get login attempts\r\n        $login_attempts = ( function_exists( '\get_transient' ) ? \get_transient( 'wpca_login_attempts_' . $user_ip ) : 0 );\r\n        \r\n        // Increment login attempts\r\n        $login_attempts = $login_attempts ? $login_attempts + 1 : 1;\r\n        \r\n        // Set transient\r\n        if ( function_exists( '\set_transient' ) ) {\r\n            \set_transient( 'wpca_login_attempts_' . $user_ip, $login_attempts, 300 ); // 5 minutes\r\n        }\r\n    }\r\n}