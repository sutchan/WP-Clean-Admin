<?php\r\n/**\r\n * WPCleanAdmin User Roles Class\r\n *\r\n * @package WPCleanAdmin\r\n * @version 1.7.15\r\n * @author Sut\r\n * @author URI: https://github.com/sutchan\r\n * @since 1.7.15\r\n */\r\nnamespace WPCleanAdmin;\r\n\r\nif ( ! defined( 'ABSPATH' ) ) {\r\n    exit;\r\n}\r\n\r\n\r\n\r\n/**\r\n * User_Roles class\r\n */\r\nclass User_Roles {\r\n    \r\n    /**\r\n     * Singleton instance\r\n     *\r\n     * @var User_Roles\r\n     */\r\n    private static $instance;\r\n    \r\n    /**\r\n     * Get singleton instance\r\n     *\r\n     * @return User_Roles\r\n     */\r\n    public static function getInstance() {\r\n        if ( ! isset( self::$instance ) ) {\r\n            self::$instance = new self();\r\n        }\r\n        return self::$instance;\r\n    }\r\n    \r\n    /**\r\n     * Constructor\r\n     */\r\n    private function __construct() {\r\n        $this->init();\r\n    }\r\n    \r\n    /**\r\n     * Initialize the user roles module\r\n     */\r\n    public function init() {\r\n        // Add user roles hooks\r\n        if ( function_exists( 'add_action' ) ) {\r\n            \add_action( 'init', array( $this, 'register_custom_roles' ) );\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Register custom roles\r\n     */\r\n    public function register_custom_roles() {\r\n        // Load settings\r\n        $settings = \wpca_get_settings();\r\n        \r\n        // Register custom roles based on settings\r\n        if ( isset( $settings['user_roles'] ) && isset( $settings['user_roles']['custom_roles'] ) ) {\r\n            foreach ( $settings['user_roles']['custom_roles'] as $role_slug => $role_data ) {\r\n                // Register custom role\r\n                if ( function_exists( 'add_role' ) ) {\r\n                    \add_role( $role_slug, $role_data['name'], $role_data['capabilities'] );\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Get user roles\r\n     *\r\n     * @return array User roles\r\n     */\r\n    public function get_user_roles() {\r\n        // Get all user roles\r\n        global $wp_roles;\r\n        \r\n        if ( ! isset( $wp_roles ) ) {\r\n            $wp_roles = new \WP_Roles();\r\n        }\r\n        \r\n        return $wp_roles->roles;\r\n    }\r\n    \r\n    /**\r\n     * Update role capabilities\r\n     *\r\n     * @param string $role_slug Role slug\r\n     * @param array $capabilities Capabilities to update\r\n     * @return bool Update result\r\n     */\r\n    public function update_role_capabilities( $role_slug, $capabilities ) {\r\n        // Get role object\r\n        $role = ( function_exists( 'get_role' ) ? \get_role( $role_slug ) : false );\r\n        \r\n        if ( ! $role ) {\r\n            return false;\r\n        }\r\n        \r\n        // Update capabilities\r\n        foreach ( $capabilities as $capability => $grant ) {\r\n            if ( $grant ) {\r\n                if ( method_exists( $role, 'add_cap' ) ) {\r\n                    $role->add_cap( $capability );\r\n                }\r\n            } else {\r\n                if ( method_exists( $role, 'remove_cap' ) ) {\r\n                    $role->remove_cap( $capability );\r\n                }\r\n            }\r\n        }\r\n        \r\n        return true;\r\n    }\r\n    \r\n    /**\r\n     * Create new role\r\n     *\r\n     * @param string $role_slug Role slug\r\n     * @param string $role_name Role name\r\n     * @param array $capabilities Capabilities\r\n     * @return array Create result\r\n     */\r\n    public function create_role( $role_slug, $role_name, $capabilities = array() ) {\r\n        $result = array(\r\n            'success' => false,\r\n            'message' => \__( 'Failed to create role', WPCA_TEXT_DOMAIN )\r\n        );\r\n        \r\n        // Check if role already exists\r\n        if ( function_exists( 'get_role' ) && \get_role( $role_slug ) ) {\r\n            $result['message'] = \__( 'Role already exists', WPCA_TEXT_DOMAIN );\r\n            return $result;\r\n        }\r\n        \r\n        // Create new role\r\n        $role = ( function_exists( 'add_role' ) ? \add_role( $role_slug, $role_name, $capabilities ) : false );\r\n        \r\n        if ( $role ) {\r\n            $result['success'] = true;\r\n            $result['message'] = \__( 'Role created successfully', WPCA_TEXT_DOMAIN );\r\n        }\r\n        \r\n        return $result;\r\n    }\r\n    \r\n    /**\r\n     * Delete role\r\n     *\r\n     * @param string $role_slug Role slug\r\n     * @return array Delete result\r\n     */\r\n    public function delete_role( $role_slug ) {\r\n        $result = array(\r\n            'success' => false,\r\n            'message' => \__( 'Failed to delete role', WPCA_TEXT_DOMAIN )\r\n        );\r\n        \r\n        // Check if role exists\r\n        if ( ! ( function_exists( 'get_role' ) && \get_role( $role_slug ) ) ) {\r\n            $result['message'] = \__( 'Role does not exist', WPCA_TEXT_DOMAIN );\r\n            return $result;\r\n        }\r\n        \r\n        // Delete role\r\n        if ( function_exists( 'remove_role' ) && \remove_role( $role_slug ) ) {\r\n            $result['success'] = true;\r\n            $result['message'] = \__( 'Role deleted successfully', WPCA_TEXT_DOMAIN );\r\n        }\r\n        \r\n        return $result;\r\n    }\r\n    \r\n    /**\r\n     * Duplicate role\r\n     *\r\n     * @param string $role_slug Role slug to duplicate\r\n     * @param string $new_role_name New role name\r\n     * @param string $new_role_slug New role slug\r\n     * @return array Duplicate result\r\n     */\r\n    public function duplicate_role( $role_slug, $new_role_name, $new_role_slug ) {\r\n        $result = array(\r\n            'success' => false,\r\n            'message' => \__( 'Failed to duplicate role', WPCA_TEXT_DOMAIN )\r\n        );\r\n        \r\n        // Check if source role exists\r\n        $source_role = ( function_exists( 'get_role' ) ? \get_role( $role_slug ) : false );\r\n        if ( ! $source_role ) {\r\n            $result['message'] = \__( 'Source role does not exist', WPCA_TEXT_DOMAIN );\r\n            return $result;\r\n        }\r\n        \r\n        // Check if new role already exists\r\n        if ( function_exists( 'get_role' ) && \get_role( $new_role_slug ) ) {\r\n            $result['message'] = \__( 'New role already exists', WPCA_TEXT_DOMAIN );\r\n            return $result;\r\n        }\r\n        \r\n        // Create new role with same capabilities\r\n        $new_role = ( function_exists( 'add_role' ) ? \add_role( $new_role_slug, $new_role_name, $source_role->capabilities ) : false );\r\n        \r\n        if ( $new_role ) {\r\n            $result['success'] = true;\r\n            $result['message'] = \__( 'Role duplicated successfully', WPCA_TEXT_DOMAIN );\r\n        }\r\n        \r\n        return $result;\r\n    }\r\n    \r\n    /**\r\n     * Get role capabilities\r\n     *\r\n     * @param string $role_slug Role slug\r\n     * @return array Role capabilities\r\n     */\r\n    public function get_role_capabilities( $role_slug ) {\r\n        // Get role object\r\n        $role = ( function_exists( 'get_role' ) ? \get_role( $role_slug ) : false );\r\n        \r\n        if ( ! $role ) {\r\n            return array();\r\n        }\r\n        \r\n        return $role->capabilities;\r\n    }\r\n    \r\n    /**\r\n     * Reset role capabilities to default\r\n     *\r\n     * @param string $role_slug Role slug\r\n     * @return bool Reset result\r\n     */\r\n    public function reset_role_capabilities( $role_slug ) {\r\n        // Get default capabilities for the role\r\n        $default_capabilities = $this->get_default_role_capabilities( $role_slug );\r\n        \r\n        if ( empty( $default_capabilities ) ) {\r\n            return false;\r\n        }\r\n        \r\n        // Update role capabilities\r\n        return $this->update_role_capabilities( $role_slug, $default_capabilities );\r\n    }\r\n    \r\n    /**\r\n     * Get default role capabilities\r\n     *\r\n     * @param string $role_slug Role slug\r\n     * @return array Default capabilities\r\n     */\r\n    private function get_default_role_capabilities( $role_slug ) {\r\n        // Default capabilities for WordPress roles\r\n        $default_capabilities = array(\r\n            'administrator' => array(\r\n                'switch_themes' => true,\r\n                'edit_themes' => true,\r\n                'activate_plugins' => true,\r\n                'edit_plugins' => true,\r\n                'edit_users' => true,\r\n                'edit_files' => true,\r\n                'manage_options' => true,\r\n                'moderate_comments' => true,\r\n                'manage_categories' => true,\r\n                'manage_links' => true,\r\n                'upload_files' => true,\r\n                'import' => true,\r\n                'unfiltered_html' => true,\r\n                'edit_posts' => true,\r\n                'edit_others_posts' => true,\r\n                'edit_published_posts' => true,\r\n                'publish_posts' => true,\r\n                'edit_pages' => true,\r\n                'read' => true,\r\n                'level_10' => true,\r\n                'level_9' => true,\r\n                'level_8' => true,\r\n                'level_7' => true,\r\n                'level_6' => true,\r\n                'level_5' => true,\r\n                'level_4' => true,\r\n                'level_3' => true,\r\n                'level_2' => true,\r\n                'level_1' => true,\r\n                'level_0' => true,\r\n                'edit_others_pages' => true,\r\n                'edit_published_pages' => true,\r\n                'publish_pages' => true,\r\n                'delete_pages' => true,\r\n                'delete_others_pages' => true,\r\n                'delete_published_pages' => true,\r\n                'delete_posts' => true,\r\n                'delete_others_posts' => true,\r\n                'delete_published_posts' => true,\r\n                'delete_private_posts' => true,\r\n                'edit_private_posts' => true,\r\n                'read_private_posts' => true,\r\n                'delete_private_pages' => true,\r\n                'edit_private_pages' => true,\r\n                'read_private_pages' => true,\r\n                'delete_users' => true,\r\n                'create_users' => true,\r\n                'unfiltered_upload' => true,\r\n                'edit_dashboard' => true,\r\n                'update_plugins' => true,\r\n                'delete_plugins' => true,\r\n                'install_plugins' => true,\r\n                'update_themes' => true,\r\n                'install_themes' => true,\r\n                'update_core' => true,\r\n                'list_users' => true,\r\n                'remove_users' => true,\r\n                'promote_users' => true,\r\n                'edit_theme_options' => true,\r\n                'delete_themes' => true,\r\n                'export' => true,\r\n            ),\r\n            'editor' => array(\r\n                'moderate_comments' => true,\r\n                'manage_categories' => true,\r\n                'manage_links' => true,\r\n                'upload_files' => true,\r\n                'unfiltered_html' => true,\r\n                'edit_posts' => true,\r\n                'edit_others_posts' => true,\r\n                'edit_published_posts' => true,\r\n                'publish_posts' => true,\r\n                'edit_pages' => true,\r\n                'read' => true,\r\n                'level_7' => true,\r\n                'level_6' => true,\r\n                'level_5' => true,\r\n                'level_4' => true,\r\n                'level_3' => true,\r\n                'level_2' => true,\r\n                'level_1' => true,\r\n                'level_0' => true,\r\n                'edit_others_pages' => true,\r\n                'edit_published_pages' => true,\r\n                'publish_pages' => true,\r\n                'delete_pages' => true,\r\n                'delete_others_pages' => true,\r\n                'delete_published_pages' => true,\r\n                'delete_posts' => true,\r\n                'delete_others_posts' => true,\r\n                'delete_published_posts' => true,\r\n                'delete_private_posts' => true,\r\n                'edit_private_posts' => true,\r\n                'read_private_posts' => true,\r\n                'delete_private_pages' => true,\r\n                'edit_private_pages' => true,\r\n                'read_private_pages' => true,\r\n            ),\r\n            'author' => array(\r\n                'upload_files' => true,\r\n                'edit_posts' => true,\r\n                'edit_published_posts' => true,\r\n                'publish_posts' => true,\r\n                'read' => true,\r\n                'level_2' => true,\r\n                'level_1' => true,\r\n                'level_0' => true,\r\n                'delete_posts' => true,\r\n                'delete_published_posts' => true,\r\n            ),\r\n            'contributor' => array(\r\n                'edit_posts' => true,\r\n                'read' => true,\r\n                'level_1' => true,\r\n                'level_0' => true,\r\n                'delete_posts' => true,\r\n            ),\r\n            'subscriber' => array(\r\n                'read' => true,\r\n                'level_0' => true,\r\n            ),\r\n        );\r\n        \r\n        return isset( $default_capabilities[$role_slug] ) ? $default_capabilities[$role_slug] : array();\r\n    }\r\n}