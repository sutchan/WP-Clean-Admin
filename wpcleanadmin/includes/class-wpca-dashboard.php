<?php\r\n/**\r\n * WPCleanAdmin Dashboard Class\r\n *\r\n * @package WPCleanAdmin\r\n * @version 1.7.15\r\n * @author Sut\r\n * @author URI: https://github.com/sutchan\r\n * @since 1.7.15\r\n */\r\nnamespace WPCleanAdmin;\r\n\r\n/**\r\n * Dashboard class for WP Clean Admin plugin\r\n *\r\n * @package WPCleanAdmin\r\n */\r\n\r\nif ( ! defined( 'ABSPATH' ) ) {\r\n    exit;\r\n}\r\n\r\n/**\r\n * Dashboard class\r\n */\r\nclass Dashboard {\r\n    \r\n    /**\r\n     * Singleton instance\r\n     *\r\n     * @var Dashboard\r\n     */\r\n    private static $instance;\r\n    \r\n    /**\r\n     * Get singleton instance\r\n     *\r\n     * @return Dashboard\r\n     */\r\n    public static function getInstance() {\r\n        if ( ! isset( self::$instance ) ) {\r\n            self::$instance = new self();\r\n        }\r\n        return self::$instance;\r\n    }\r\n    \r\n    /**\r\n     * Constructor\r\n     */\r\n    private function __construct() {\r\n        $this->init();\r\n    }\r\n    \r\n    /**\r\n     * Initialize the dashboard module\r\n     */\r\n    public function init() {\r\n        // Register dashboard widgets\r\n        if ( function_exists( '\add_action' ) ) {\r\n            \add_action( 'wp_dashboard_setup', array( $this, 'register_dashboard_widgets' ) );\r\n            \r\n            // Enqueue dashboard scripts and styles\r\n            \add_action( 'admin_enqueue_scripts', array( $this, 'enqueue_dashboard_scripts' ) );\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Register dashboard widgets\r\n     */\r\n    public function register_dashboard_widgets() {\r\n        // Add WPCA dashboard widget\r\n        if ( function_exists( '\wp_add_dashboard_widget' ) ) {\r\n            \wp_add_dashboard_widget(\r\n                'wpca_dashboard_widget',\r\n                \__( 'WP Clean Admin', WPCA_TEXT_DOMAIN ),\r\n                array( $this, 'render_dashboard_widget' )\r\n            );\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Render dashboard widget\r\n     */\r\n    public function render_dashboard_widget() {\r\n        $stats = $this->get_dashboard_stats();\r\n        \r\n        ?>        <div class="wpca-dashboard-widget">\r\n            <h3><?php \_e( 'Dashboard Overview', WPCA_TEXT_DOMAIN ); ?></h3>\r\n            <div class="wpca-dashboard-stats">\r\n                <div class="wpca-stat-item">\r\n                    <span class="wpca-stat-label"><?php \_e( 'Database Size', WPCA_TEXT_DOMAIN ); ?></span>\r\n                    <span class="wpca-stat-value"><?php echo esc_html( $stats['database_size'] ); ?></span>\r\n                </div>\r\n                <div class="wpca-stat-item">\r\n                    <span class="wpca-stat-label"><?php \_e( 'Transients', WPCA_TEXT_DOMAIN ); ?></span>\r\n                    <span class="wpca-stat-value"><?php echo esc_html( $stats['transients'] ); ?></span>\r\n                </div>\r\n                <div class="wpca-stat-item">\r\n                    <span class="wpca-stat-label"><?php \_e( 'Orphaned Postmeta', WPCA_TEXT_DOMAIN ); ?></span>\r\n                    <span class="wpca-stat-value"><?php echo esc_html( $stats['orphaned_postmeta'] ); ?></span>\r\n                </div>\r\n                <div class="wpca-stat-item">\r\n                    <span class="wpca-stat-label"><?php \_e( 'Orphaned Termmeta', WPCA_TEXT_DOMAIN ); ?></span>\r\n                    <span class="wpca-stat-value"><?php echo esc_html( $stats['orphaned_termmeta'] ); ?></span>\r\n                </div>\r\n            </div>\r\n            <div class="wpca-dashboard-actions">\r\n                <button class="button button-primary wpca-quick-action" data-action="cleanup_database">\r\n                    <?php \_e( 'Quick Database Cleanup', WPCA_TEXT_DOMAIN ); ?>\r\n                </button>\r\n                <button class="button button-secondary wpca-quick-action" data-action="optimize_database">\r\n                    <?php \_e( 'Optimize Database', WPCA_TEXT_DOMAIN ); ?>\r\n                </button>\r\n            </div>\r\n        </div>\r\n        <?php\r\n    }\r\n    \r\n    /**\r\n     * Enqueue dashboard scripts and styles\r\n     *\r\n     * @param string $hook Current admin page hook\r\n     */\r\n    public function enqueue_dashboard_scripts( $hook ) {\r\n        // Only enqueue on dashboard page\r\n        if ( $hook !== 'index.php' ) {\r\n            return;\r\n        }\r\n        \r\n        // Enqueue dashboard JS\r\n        if ( function_exists( '\wp_enqueue_script' ) ) {\r\n            \wp_enqueue_script(\r\n                'wpca-dashboard',\r\n                WPCA_PLUGIN_URL . 'assets/js/wpca-dashboard.js',\r\n                array( 'jquery' ),\r\n                WPCA_VERSION,\r\n                true\r\n            );\r\n        }\r\n        \r\n        // Localize script\r\n        if ( function_exists( '\wp_localize_script' ) && function_exists( '\wp_create_nonce' ) && function_exists( '\admin_url' ) ) {\r\n            \wp_localize_script( 'wpca-dashboard', 'wpca_dashboard_vars', array(\r\n                'ajax_url' => \admin_url( 'admin-ajax.php' ),\r\n                'nonce' => \wp_create_nonce( 'wpca_dashboard_nonce' )\r\n            ));\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Get dashboard statistics\r\n     *\r\n     * @return array Dashboard statistics\r\n     */\r\n    public function get_dashboard_stats() {\r\n        global $wpdb;\r\n        \r\n        $stats = array();\r\n        \r\n        // Get database size\r\n        $result = $wpdb->get_row( $wpdb->prepare( "SELECT SUM(data_length + index_length) AS size FROM information_schema.TABLES WHERE table_schema = %s", $wpdb->dbname ), ARRAY_A );\r\n        $stats['database_size'] = ( function_exists( '\size_format' ) ? \size_format( $result['size'], 2 ) : $result['size'] );\r\n        \r\n        // Get transients count\r\n        $stats['transients'] = $wpdb->get_var( "SELECT COUNT(*) FROM {$wpdb->options} WHERE option_name LIKE '%transient%'" );\r\n        \r\n        // Get orphaned postmeta count\r\n        $stats['orphaned_postmeta'] = $wpdb->get_var( "SELECT COUNT(*) FROM {$wpdb->postmeta} LEFT JOIN {$wpdb->posts} ON {$wpdb->postmeta}.post_id = {$wpdb->posts}.ID WHERE {$wpdb->posts}.ID IS NULL" );\r\n        \r\n        // Get orphaned termmeta count\r\n        $stats['orphaned_termmeta'] = $wpdb->get_var( "SELECT COUNT(*) FROM {$wpdb->termmeta} LEFT JOIN {$wpdb->terms} ON {$wpdb->termmeta}.term_id = {$wpdb->terms}.term_id WHERE {$wpdb->terms}.term_id IS NULL" );\r\n        \r\n        return $stats;\r\n    }\r\n    \r\n    /**\r\n     * Get system information\r\n     *\r\n     * @return array System information\r\n     */\r\n    public function get_system_info() {\r\n        global $wp_version, $wpdb;\r\n        \r\n        $info = array();\r\n        \r\n        // WordPress information\r\n        $info['wordpress'] = array(\r\n            'version' => $wp_version,\r\n            'language' => ( function_exists( '\get_locale' ) ? \get_locale() : 'en_US' ),\r\n            'multisite' => ( function_exists( '\is_multisite' ) && \is_multisite() ) ? \__( 'Yes', WPCA_TEXT_DOMAIN ) : \__( 'No', WPCA_TEXT_DOMAIN ),\r\n            'debug_mode' => defined( 'WP_DEBUG' ) && WP_DEBUG ? \__( 'Yes', WPCA_TEXT_DOMAIN ) : \__( 'No', WPCA_TEXT_DOMAIN )\r\n        );\r\n        \r\n        // Server information\r\n        $info['server'] = array(\r\n            'php_version' => phpversion(),\r\n            'mysql_version' => $wpdb->db_version(),\r\n            'server_software' => $_SERVER['SERVER_SOFTWARE'],\r\n            'memory_limit' => ini_get( 'memory_limit' )\r\n        );\r\n        \r\n        // Plugin information\r\n        $info['plugin'] = array(\r\n            'version' => WPCA_VERSION,\r\n            'active' => ( function_exists( '\is_plugin_active' ) && function_exists( '\plugin_basename' ) && \is_plugin_active( \plugin_basename( WPCA_PLUGIN_DIR . 'wp-clean-admin.php' ) ) ) ? \__( 'Yes', WPCA_TEXT_DOMAIN ) : \__( 'Yes', WPCA_TEXT_DOMAIN )\r\n        );\r\n        \r\n        return $info;\r\n    }\r\n    \r\n    /**\r\n     * Run quick action\r\n     *\r\n     * @param string $action Action name\r\n     * @return array Action result\r\n     */\r\n    public function run_quick_action( $action ) {\r\n        $result = array(\r\n            'success' => false,\r\n            'message' => \__( 'Invalid action', WPCA_TEXT_DOMAIN )\r\n        );\r\n        \r\n        switch ( $action ) {\r\n            case 'cleanup_database':\r\n                // Run database cleanup\r\n                $cleanup = new Cleanup();\r\n                $cleanup_result = $cleanup->run_database_cleanup( array(\r\n                    'transients' => true,\r\n                    'orphaned_postmeta' => true,\r\n                    'orphaned_termmeta' => true\r\n                ) );\r\n                \r\n                $result['success'] = true;\r\n                $result['message'] = \__( 'Database cleanup completed successfully', WPCA_TEXT_DOMAIN );\r\n                $result['data'] = $cleanup_result;\r\n                break;\r\n                \r\n            case 'optimize_database':\r\n                // Run database optimization\r\n                $database = new Database();\r\n                $optimize_result = $database->optimize_database();\r\n                \r\n                $result['success'] = true;\r\n                $result['message'] = \__( 'Database optimization completed successfully', WPCA_TEXT_DOMAIN );\r\n                $result['data'] = $optimize_result;\r\n                break;\r\n        }\r\n        \r\n        return $result;\r\n    }\r\n}