<!-- OPENSPEC:START -->
# WP Clean Admin 技术栈报告

**生成时间**：2025年12月26日  
**项目版本**：1.7.15  
**报告类型**：技术栈分析

---

## 1. 项目概述

WP Clean Admin 是一个 WordPress 后台清理和优化插件，提供丰富的后台管理功能，包括菜单定制、权限管理、数据库优化、性能调优等。该插件采用模块化设计，遵循 WordPress 最佳实践，注重安全性、性能和用户体验。

---

## 2. 后端技术栈

### 2.1 核心语言与框架

| 技术 | 版本要求 | 说明 |
|------|----------|------|
| PHP | 7.0+ | WordPress 插件标准 PHP 版本 |
| WordPress | 5.0+ | 兼容主流 WordPress 版本 |
| PSR-4 | 自动加载规范 | 类文件自动加载标准 |

### 2.2 编程规范

**文件格式要求：**
- 编码格式：UTF-8 with BOM
- 换行符：Unix LF
- 缩进：4 个空格
- 行宽：不超过 120 个字符
- PHP 闭合标签：禁止使用 `?>`

**命名规范：**
- 类名：PascalCase（如 `WPCleanAdmin\Core`）
- 方法名：camelCase（如 `getInstance()`）
- 函数名：snake_case（如 `wpca_get_settings()`）
- 变量名：snake_case（如 `$plugin_settings`）
- 常量名：全大写 + 下划线（如 `WPCA_VERSION`）
- 钩子名：snake_case（如 `wpca_after_save_settings`）

### 2.3 设计模式

| 模式 | 应用场景 | 说明 |
|------|----------|------|
| Singleton | 所有核心类 | 通过 `getInstance()` 方法获取单例实例 |
| PSR-4 Autoloading | 类文件加载 | 自定义自动加载器，将命名空间转换为文件路径 |
| WordPress Hooks | 功能扩展 | 使用 `add_action()` 和 `add_filter()` 挂载功能 |

### 2.4 命名空间结构

```php
namespace WPCleanAdmin;
```

所有核心类均位于 `WPCleanAdmin` 命名空间下，通过 PSR-4 自动加载。

---

## 3. 前端技术栈

### 3.1 技术组成

| 技术 | 类型 | 用途 |
|------|------|------|
| jQuery | JavaScript 库 | WordPress 内置，DOM 操作和事件处理 |
| 原生 JavaScript | 脚本语言 | 核心交互逻辑和 AJAX 处理 |
| CSS3 | 样式语言 | 插件界面样式和响应式设计 |

### 3.2 JavaScript 架构

**模块结构：**
- `wpca-main.js`：主入口文件，初始化所有功能
- `wpca-settings.js`：设置页面交互
- `wpca-tabs.js`：标签页切换
- `wpca-menu.js`：菜单管理
- `wpca-database.js`：数据库操作
- `wpca-performance.js`：性能监控
- `wpca-permissions.js`：权限设置
- `wpca-reset.js`：重置功能
- `wpca-login.js`：登录页面定制

**使用规范：**
- 使用 IIFE 封装避免全局污染
- 使用 `const` 和 `let` 声明变量
- 使用单引号定义字符串
- 必须使用分号结束语句

### 3.3 CSS 架构

| 文件 | 用途 |
|------|------|
| wpca-admin.css | 通用管理界面样式 |
| wpca-settings.css | 设置页面专用样式 |
| wpca-database.css | 数据库管理页面样式 |
| wpca-performance.css | 性能优化页面样式 |
| wpca-login-styles.css | 登录页面样式 |

**样式规范：**
- 使用 BEM 命名规范
- 使用 CSS 变量定义颜色
- 使用 `box-sizing: border-box` 盒模型
- 支持响应式设计

---

## 4. 模块架构

### 4.1 核心模块列表

| 模块 | 类名 | 功能描述 |
|------|------|----------|
| 核心模块 | `Core` | 插件初始化和模块加载 |
| 设置管理 | `Settings` | 插件设置页面和配置管理 |
| 仪表盘 | `Dashboard` | 数据统计和系统信息展示 |
| 数据库 | `Database` | 数据库优化、备份和恢复 |
| 性能优化 | `Performance` | 性能优化和缓存管理 |
| 菜单管理 | `Menu_Manager` | 菜单结构获取和管理 |
| 菜单定制 | `Menu_Customizer` | 菜单自定义和排序 |
| 权限管理 | `Permissions` | 用户权限控制和管理 |
| 用户角色 | `User_Roles` | 自定义角色创建和管理 |
| 登录管理 | `Login` | 登录页面定制 |
| 清理功能 | `Cleanup` | 数据库和内容清理 |
| 资源管理 | `Resources` | CSS/JS 资源优化 |
| 重置功能 | `Reset` | 插件设置重置 |
| AJAX 处理 | `AJAX` | 异步请求处理 |
| 国际化 | `i18n` | 多语言支持 |

### 4.2 模块初始化流程

```php
// 核心类按顺序初始化以下模块
Core::init() → 加载模块 → Singleton 实例化
├── Settings::getInstance()
├── Dashboard::getInstance()
├── Database::getInstance()
├── Performance::getInstance()
├── Menu_Manager::getInstance()
├── Menu_Customizer::getInstance()
├── Permissions::getInstance()
├── User_Roles::getInstance()
├── Login::getInstance()
├── Cleanup::getInstance()
├── Resources::getInstance()
├── Reset::getInstance()
├── AJAX::getInstance()
└── i18n::getInstance()
```

### 4.3 AJAX 接口

**Dashboard 接口：**
- `wp_ajax_wpca_get_dashboard_stats`：获取仪表盘统计
- `wp_ajax_wpca_get_system_info`：获取系统信息
- `wp_ajax_wpca_run_quick_action`：执行快速操作

**Cleanup 接口：**
- `wp_ajax_wpca_cleanup_database`：清理数据库
- `wp_ajax_wpca_cleanup_media`：清理媒体库
- `wp_ajax_wpca_cleanup_comments`：清理评论
- `wp_ajax_wpca_cleanup_content`：清理内容
- `wp_ajax_wpca_get_cleanup_stats`：获取清理统计

**Settings 接口：**
- `wp_ajax_wpca_save_settings`：保存设置
- `wp_ajax_wpca_get_settings`：获取设置
- `wp_ajax_wpca_reset_settings`：重置设置

**User Roles 接口：**
- `wp_ajax_wpca_get_user_roles`：获取用户角色
- `wp_ajax_wpca_update_role_capabilities`：更新角色权限
- `wp_ajax_wpca_create_role`：创建角色
- `wp_ajax_wpca_delete_role`：删除角色
- `wp_ajax_wpca_duplicate_role`：复制角色

**Database 接口：**
- `wp_ajax_wpca_get_database_info`：获取数据库信息
- `wp_ajax_wpca_backup_database`：备份数据库
- `wp_ajax_wpca_restore_database`：恢复数据库
- `wp_ajax_wpca_get_database_backups`：获取备份列表
- `wp_ajax_wpca_delete_database_backup`：删除备份

---

## 5. 安全机制

### 5.1 安全规范

| 安全措施 | 实现方式 | 说明 |
|----------|----------|------|
| 输入验证 | `sanitize_text_field()` 等 | 所有用户输入必须验证和过滤 |
| 输出转义 | `esc_html()`, `esc_attr()`, `esc_url()` | 所有输出到页面的内容必须转义 |
| SQL 注入防护 | `$wpdb->prepare()` | 使用参数绑定避免 SQL 注入 |
| CSRF 防护 | `wp_create_nonce()`, `wp_verify_nonce()` | 表单提交必须验证 nonce |
| 权限检查 | `current_user_can()` | 所有管理操作必须检查权限 |

### 5.2 AJAX 安全验证

```php
private function verify_ajax_request( $action ) {
    // 验证 nonce
    if ( ! \wp_verify_nonce( $_POST['_wpnonce'], 'wpca_ajax_nonce' ) ) {
        \wp_send_json_error( \__( 'Invalid nonce', WPCA_TEXT_DOMAIN ) );
    }
    
    // 验证权限
    if ( ! \current_user_can( 'manage_options' ) ) {
        \wp_send_json_error( \__( 'Insufficient permissions', WPCA_TEXT_DOMAIN ) );
    }
    
    return true;
}
```

### 5.3 数据验证示例

```php
public function validate_settings( $input ) {
    $validated = array();
    
    // 验证复选框值
    $validated['general']['clean_admin_bar'] = isset( $input['general']['clean_admin_bar'] ) ? 1 : 0;
    
    // 验证文本字段
    $validated['menu']['role_menu_restrictions'][$sanitized_role] = array();
    
    return $validated;
}
```

---

## 6. 国际化支持

### 6.1 文本域

```php
define( 'WPCA_TEXT_DOMAIN', 'wp-clean-admin' );
```

### 6.2 翻译函数

| 函数 | 用途 |
|------|------|
| `__()` | 返回翻译后的字符串 |
| `_e()` | 输出翻译后的字符串 |
| `_x()` | 返回带上下文的翻译 |
| `_ex()` | 输出带上下文的翻译 |

### 6.3 语言文件

| 文件 | 语言 | 说明 |
|------|------|------|
| wp-clean-admin.pot | 模板文件 | 可翻译字符串模板 |
| wp-clean-admin-zh_CN.po | 中文 | 中文翻译 |
| wp-clean-admin-en_US.po | 英文 | 英文翻译 |

---

## 7. 文件结构

### 7.1 目录结构

```
wpcleanadmin/
├── assets/
│   ├── css/
│   │   ├── wpca-admin.css
│   │   ├── wpca-database.css
│   │   ├── wpca-login-styles.css
│   │   ├── wpca-performance.css
│   │   └── wpca-settings.css
│   └── js/
│       ├── wpca-database.js
│       ├── wpca-login.js
│       ├── wpca-main.js
│       ├── wpca-menu.js
│       ├── wpca-performance.js
│       ├── wpca-permissions.js
│       ├── wpca-reset.js
│       ├── wpca-settings.js
│       └── wpca-tabs.js
├── includes/
│   ├── autoload.php                    # PSR-4 自动加载器
│   ├── class-wpca-ajax.php             # AJAX 处理器
│   ├── class-wpca-cleanup.php          # 清理功能
│   ├── class-wpca-core.php             # 核心类
│   ├── class-wpca-dashboard.php        # 仪表盘
│   ├── class-wpca-database.php         # 数据库管理
│   ├── class-wpca-database-settings.php # 数据库设置
│   ├── class-wpca-helpers.php          # 辅助函数
│   ├── class-wpca-i18n.php             # 国际化
│   ├── class-wpca-login.php            # 登录管理
│   ├── class-wpca-menu-customizer.php  # 菜单定制
│   ├── class-wpca-menu-manager.php     # 菜单管理
│   ├── class-wpca-performance.php      # 性能优化
│   ├── class-wpca-performance-settings.php # 性能设置
│   ├── class-wpca-permissions.php      # 权限管理
│   ├── class-wpca-reset.php            # 重置功能
│   ├── class-wpca-resources.php        # 资源管理
│   ├── class-wpca-settings.php         # 设置管理
│   ├── class-wpca-user-roles.php       # 用户角色
│   ├── wpca-core-functions.php         # 核心函数
│   ├── wpca-wordpress-stubs.php        # WordPress 函数存根
│   └── wp-stub.php                     # WordPress 存根
├── languages/
│   ├── wp-clean-admin-en_US.po
│   ├── wp-clean-admin-zh_CN.po
│   └── wp-clean-admin.pot
└── wp-clean-admin.php                   # 插件主文件
```

### 7.2 插件入口

```php
// 插件主文件 wp-clean-admin.php
define( 'WPCA_VERSION', '1.7.15' );
define( 'WPCA_PLUGIN_DIR', ... );
define( 'WPCA_PLUGIN_URL', ... );
define( 'WPCA_TEXT_DOMAIN', 'wp-clean-admin' );

// 初始化插件
function wpca_init() {
    load_plugin_textdomain( WPCA_TEXT_DOMAIN );
    WPCleanAdmin\Core::getInstance();
}
add_action( 'plugins_loaded', 'wpca_init' );
```

---

## 8. 依赖关系

### 8.1 WordPress 依赖

**必须依赖函数：**
- `add_action()`：注册动作钩子
- `add_filter()`：注册过滤器钩子
- `add_menu_page()`：添加管理菜单
- `add_settings_section()`：添加设置板块
- `add_settings_field()`：添加设置字段
- `register_setting()`：注册设置选项
- `wp_enqueue_style()`：入队 CSS
- `wp_enqueue_script()`：入队 JavaScript
- `wp_localize_script()`：本地化脚本数据

### 8.2 可选依赖函数

| 函数 | 用途 | 降级处理 |
|------|------|----------|
| `plugin_dir_path()` | 获取插件目录路径 | 使用 `dirname(__FILE__)` |
| `plugin_dir_url()` | 获取插件 URL | 使用空字符串 |
| `wp_roles()` | 获取用户角色 | 返回空数组 |
| `wp_send_json_success()` | 发送 JSON 成功响应 | 直接返回 |
| `wp_send_json_error()` | 发送 JSON 错误响应 | 直接返回 |
| `size_format()` | 格式化文件大小 | 手动计算 |

### 8.3 IDE 支持

项目包含 `wpca-wordpress-stubs.php` 文件，为 IDE 提供 WordPress 核心函数定义，避免未定义函数警告。

---

## 9. 兼容性

### 9.1 环境兼容性

| 环境 | 要求 | 说明 |
|------|------|------|
| WordPress | 5.0+ | 兼容主流版本 |
| PHP | 7.0+ | WordPress 推荐版本 |
| 浏览器 | Chrome, Firefox, Safari, Edge | 现代浏览器 |
| 主题 | 主流 WordPress 主题 | 样式隔离处理 |

### 9.2 主题兼容性

- 样式使用特定前缀避免冲突
- 主要样式在 WordPress 管理界面内生效
- 不修改前端样式（登录页除外）

---

## 10. 开发工具

### 10.1 代码质量

| 工具 | 用途 |
|------|------|
| cspell.json | 拼写检查配置 |
| WordPress 编码标准 | 代码风格规范 |
| PHPDoc | 文档注释标准 |

### 10.2 版本管理

| 规范 | 说明 |
|------|------|
| Semantic Versioning | 语义化版本 (MAJOR.MINOR.PATCH) |
| Conventional Commits | 提交信息格式规范 |
| Git Flow | 分支管理策略 |

---

## 11. 总结

WP Clean Admin 是一个功能完整的 WordPress 插件，采用现代化的 PHP 技术和 WordPress 最佳实践。主要技术特点包括：

1. **模块化设计**：14 个核心模块，职责清晰，便于维护和扩展
2. **安全优先**：完整的输入验证、输出转义、CSRF 防护和权限检查机制
3. **国际化支持**：完整的中英文语言包，易于扩展其他语言
4. **规范编码**：遵循 PSR-4、WordPress 编码标准和项目自定义规范
5. **用户体验**：响应式设计、AJAX 交互、完善的错误处理

该项目技术栈成熟稳定，适合作为 WordPress 插件开发的参考模板。

<!-- OPENSPEC:END -->
