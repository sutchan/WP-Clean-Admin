# 安全开发实践指南

## 1. 概述

### 1.1 文档目的

本指南旨在为 WP Clean Admin 项目的开发人员提供安全开发的最佳实践和规范，确保项目代码的安全性，防止常见的安全漏洞，保护用户数据和系统安全。

### 1.2 安全原则

- **最小权限原则**：只授予必要的权限，避免过度授权
- **防御深度原则**：多层次防御，单一防御失效时仍能保护系统
- **安全优先原则**：在设计和开发阶段就考虑安全，而不是事后补救
- **安全编码原则**：遵循安全编码规范，避免常见安全漏洞
- **定期审计原则**：定期进行安全审计和代码审查
- **及时更新原则**：及时更新依赖库和修复安全漏洞

## 2. 输入验证与过滤

### 2.1 验证所有输入

**原则**：所有来自外部的输入必须经过验证，包括用户输入、URL 参数、表单数据、Cookie、HTTP 头信息等。

**最佳实践**：

1. **使用 WordPress 内置验证函数**：
   ```php
   // 验证文本字段
   $sanitized_text = sanitize_text_field( $_POST['text_field'] );
   
   // 验证电子邮件
   $sanitized_email = sanitize_email( $_POST['email_field'] );
   
   // 验证 URL
   $sanitized_url = esc_url_raw( $_POST['url_field'] );
   
   // 验证整数
   $sanitized_int = absint( $_POST['int_field'] );
   
   // 验证布尔值
   $sanitized_bool = rest_sanitize_boolean( $_POST['bool_field'] );
   ```

2. **使用类型转换**：
   ```php
   // 将输入转换为整数
   $id = (int) $_GET['id'];
   
   // 将输入转换为字符串
   $name = (string) $_POST['name'];
   ```

3. **使用正则表达式验证复杂格式**：
   ```php
   // 验证电话号码
   if ( preg_match( '/^[0-9]{10,11}$/', $_POST['phone'] ) ) {
       // 验证通过
   } else {
       // 验证失败
   }
   ```

### 2.2 过滤输出

**原则**：所有输出到页面的内容必须经过转义，防止 XSS 攻击。

**最佳实践**：

1. **使用 WordPress 内置转义函数**：
   ```php
   // 转义 HTML 内容
   echo esc_html( $text );
   
   // 转义 HTML 属性
   echo '<div class="' . esc_attr( $class ) . '"></div>';
   
   // 转义 URL
   echo '<a href="' . esc_url( $url ) . '">Link</a>';
   
   // 转义 JavaScript
   echo '<script>var data = "' . esc_js( $data ) . '";</script>';
   
   // 转义 CSS
   echo '<style>body { background-color: ' . esc_css( $color ) . '; }</style>';
   ```

2. **使用 `wp_kses()` 过滤 HTML 标签**：
   ```php
   // 定义允许的 HTML 标签和属性
   $allowed_tags = array(
       'a' => array(
           'href' => array(),
           'title' => array()
       ),
       'br' => array(),
       'em' => array(),
       'strong' => array()
   );
   
   // 过滤 HTML 内容
   $filtered_content = wp_kses( $content, $allowed_tags );
   ```

## 3. SQL 注入防护

### 3.1 使用参数化查询

**原则**：所有 SQL 查询必须使用参数化查询，避免直接拼接 SQL 语句。

**最佳实践**：

1. **使用 `$wpdb->prepare()`**：
   ```php
   // 正确示例：使用参数化查询
   $results = $wpdb->get_results(
       $wpdb->prepare(
           "SELECT * FROM {$wpdb->posts} WHERE post_type = %s AND post_status = %s",
           'post',
           'publish'
       )
   );
   
   // 错误示例：直接拼接 SQL
   $results = $wpdb->get_results(
       "SELECT * FROM {$wpdb->posts} WHERE post_type = '$post_type' AND post_status = '$post_status'"
   );
   ```

2. **使用 WordPress 数据访问函数**：
   ```php
   // 使用 WordPress 内置函数获取数据
   $post = get_post( $post_id );
   $user = get_user_by( 'id', $user_id );
   $option = get_option( 'option_name' );
   ```

3. **避免使用 `$wpdb->query()` 执行复杂查询**：
   ```php
   // 尽量使用更安全的专用函数
   $wpdb->insert( $table, $data, $format );
   $wpdb->update( $table, $data, $where, $format, $where_format );
   $wpdb->delete( $table, $where, $where_format );
   ```

## 4. CSRF 防护

### 4.1 使用 Nonce

**原则**：所有修改数据的操作必须使用 Nonce 验证，防止跨站请求伪造攻击。

**最佳实践**：

1. **生成 Nonce**：
   ```php
   // 生成 Nonce 字段
   wp_nonce_field( 'wpca_action', 'wpca_nonce' );
   
   // 生成 Nonce URL
   $url = wp_nonce_url( $url, 'wpca_action', 'wpca_nonce' );
   
   // 生成 Nonce 字符串
   $nonce = wp_create_nonce( 'wpca_action' );
   ```

2. **验证 Nonce**：
   ```php
   // 验证表单提交的 Nonce
   if ( ! isset( $_POST['wpca_nonce'] ) || ! wp_verify_nonce( $_POST['wpca_nonce'], 'wpca_action' ) ) {
       wp_die( 'Invalid nonce' );
   }
   
   // 验证 URL 中的 Nonce
   if ( ! isset( $_GET['wpca_nonce'] ) || ! wp_verify_nonce( $_GET['wpca_nonce'], 'wpca_action' ) ) {
       wp_die( 'Invalid nonce' );
   }
   ```

3. **在 AJAX 请求中使用 Nonce**：
   ```php
   // 在 WordPress 后台添加 AJAX Nonce
   wp_localize_script( 'wpca-script', 'wpca_ajax', array(
       'url' => admin_url( 'admin-ajax.php' ),
       'nonce' => wp_create_nonce( 'wpca_ajax_action' )
   ) );
   ```
   
   ```javascript
   // 在 JavaScript 中发送 AJAX 请求
   jQuery.ajax({
       url: wpca_ajax.url,
       type: 'POST',
       data: {
           action: 'wpca_ajax_handler',
           nonce: wpca_ajax.nonce,
           data: some_data
       },
       success: function( response ) {
           // 处理响应
       }
   });
   ```
   
   ```php
   // 在 AJAX 处理函数中验证 Nonce
   function wpca_ajax_handler() {
       if ( ! isset( $_POST['nonce'] ) || ! wp_verify_nonce( $_POST['nonce'], 'wpca_ajax_action' ) ) {
           wp_send_json_error( 'Invalid nonce' );
       }
       
       // 处理 AJAX 请求
       wp_send_json_success( $response );
   }
   ```

## 5. 权限检查

### 5.1 验证用户权限

**原则**：所有管理操作必须检查用户权限，确保只有授权用户才能执行敏感操作。

**最佳实践**：

1. **使用 WordPress 内置权限函数**：
   ```php
   // 检查用户是否有管理权限
   if ( ! current_user_can( 'manage_options' ) ) {
       wp_die( 'You do not have sufficient permissions to access this page.' );
   }
   
   // 检查用户是否有编辑文章权限
   if ( ! current_user_can( 'edit_post', $post_id ) ) {
       wp_die( 'You do not have permission to edit this post.' );
   }
   ```

2. **在 AJAX 处理函数中检查权限**：
   ```php
   function wpca_ajax_handler() {
       // 检查用户权限
       if ( ! current_user_can( 'manage_options' ) ) {
           wp_send_json_error( 'Insufficient permissions' );
       }
       
       // 处理 AJAX 请求
   }
   ```

3. **在 REST API 端点中检查权限**：
   ```php
   register_rest_route( 'wpca/v1', '/settings', array(
       'methods' => 'GET',
       'callback' => 'wpca_get_settings',
       'permission_callback' => function() {
           return current_user_can( 'manage_options' );
       }
   ) );
   ```

## 6. 文件操作安全

### 6.1 安全的文件操作

**原则**：所有文件操作必须经过严格验证，防止路径遍历和文件包含漏洞。

**最佳实践**：

1. **验证文件路径**：
   ```php
   // 安全的文件包含
   $allowed_files = array(
       'file1' => 'path/to/file1.php',
       'file2' => 'path/to/file2.php'
   );
   
   if ( isset( $_GET['file'] ) && isset( $allowed_files[ $_GET['file'] ] ) ) {
       include( $allowed_files[ $_GET['file'] ] );
   } else {
       include( 'path/to/default.php' );
   }
   ```

2. **避免直接使用用户输入作为文件名**：
   ```php
   // 错误示例：直接使用用户输入作为文件名
   $filename = $_GET['filename'];
   include( "files/{$filename}.php" ); // 存在路径遍历风险
   
   // 正确示例：验证文件名
   $safe_filename = sanitize_file_name( $_GET['filename'] );
   $file_path = realpath( "files/{$safe_filename}.php" );
   
   // 验证文件路径是否在允许的目录内
   $allowed_dir = realpath( 'files' );
   if ( strpos( $file_path, $allowed_dir ) === 0 ) {
       include( $file_path );
   }
   ```

3. **安全的文件上传**：
   ```php
   // 验证文件类型
   $allowed_types = array( 'image/jpeg', 'image/png', 'image/gif' );
   if ( in_array( $_FILES['file']['type'], $allowed_types ) ) {
       // 验证文件大小
       if ( $_FILES['file']['size'] < 1024 * 1024 * 2 ) { // 2MB
           // 安全处理文件上传
           $upload = wp_handle_upload( $_FILES['file'], array( 'test_form' => false ) );
           if ( $upload && ! isset( $upload['error'] ) ) {
               // 文件上传成功
               $file_url = $upload['url'];
               $file_path = $upload['file'];
           }
       }
   }
   ```

## 7. 安全的密码处理

### 7.1 密码存储

**原则**：密码必须使用安全的哈希算法存储，禁止明文存储密码。

**最佳实践**：

1. **使用 WordPress 内置密码函数**：
   ```php
   // 验证密码
   if ( wp_check_password( $password, $hashed_password, $user_id ) ) {
       // 密码正确
   }
   
   // 生成密码哈希
   $hashed_password = wp_hash_password( $password );
   ```

2. **避免自定义密码处理**：
   ```php
   // 错误示例：使用不安全的哈希算法
   $hashed_password = md5( $password ); // 不安全
   $hashed_password = sha1( $password ); // 不安全
   
   // 正确示例：使用 WordPress 内置函数
   $hashed_password = wp_hash_password( $password ); // 使用 bcrypt
   ```

3. **强制使用强密码**：
   ```php
   // 验证密码强度
   if ( ! wp_check_password_strength( $password, 3 ) ) {
       // 密码强度不足
       $error = '密码强度不足，请使用至少 8 个字符，包含大小写字母、数字和特殊字符';
   }
   ```

## 8. 安全的会话管理

### 8.1 会话安全

**原则**：会话管理必须安全，防止会话劫持和会话固定攻击。

**最佳实践**：

1. **使用 WordPress 内置会话管理**：
   ```php
   // 使用 WordPress 内置函数管理用户会话
   wp_set_auth_cookie( $user_id );
   wp_clear_auth_cookie();
   wp_validate_auth_cookie();
   ```

2. **避免使用自定义会话**：
   ```php
   // 错误示例：使用自定义会话
   session_start();
   $_SESSION['user_id'] = $user_id;
   
   // 正确示例：使用 WordPress 内置会话
   wp_set_current_user( $user_id );
   ```

3. **设置安全的 Cookie 属性**：
   ```php
   // 设置安全的 Cookie
   setcookie( $name, $value, $expire, $path, $domain, true, true ); // secure, httponly
   ```

## 9. 安全的错误处理

### 9.1 安全的错误信息

**原则**：错误信息必须安全，避免泄露敏感信息。

**最佳实践**：

1. **在生产环境中隐藏错误信息**：
   ```php
   // 在 wp-config.php 中设置
   define( 'WP_DEBUG', false );
   define( 'WP_DEBUG_DISPLAY', false );
   define( 'WP_DEBUG_LOG', true );
   ```

2. **使用安全的错误处理**：
   ```php
   // 安全的错误处理
   try {
       // 可能抛出异常的代码
   } catch ( Exception $e ) {
       // 记录错误日志
       error_log( 'WP Clean Admin Error: ' . $e->getMessage() );
       
       // 向用户显示友好的错误信息
       wp_die( 'An error occurred. Please try again later.' );
   }
   ```

3. **避免在错误信息中泄露敏感数据**：
   ```php
   // 错误示例：泄露敏感信息
   echo 'Error: Failed to connect to database with credentials: ' . $username . ':' . $password;
   
   // 正确示例：显示友好的错误信息
   echo 'Error: Failed to connect to database. Please check your database settings.';
   ```

## 10. 安全的依赖管理

### 10.1 依赖库安全

**原则**：所有依赖库必须保持最新，及时修复安全漏洞。

**最佳实践**：

1. **使用 Composer 管理依赖**：
   ```bash
   # 安装依赖
   composer install
   
   # 更新依赖
   composer update
   
   # 检查依赖安全
   composer audit
   ```

2. **定期更新依赖**：
   ```bash
   # 检查依赖更新
   composer outdated
   
   # 更新到安全版本
   composer update vendor/package --with-dependencies
   ```

3. **使用安全的依赖源**：
   ```json
   // composer.json
   {
       "repositories": [
           {
               "type": "composer",
               "url": "https://packagist.org"
           }
       ]
   }
   ```

## 11. 安全的 API 设计

### 11.1 REST API 安全

**原则**：所有 API 端点必须经过严格的安全设计，防止未授权访问和数据泄露。

**最佳实践**：

1. **使用 WordPress REST API**：
   ```php
   // 注册 REST API 端点
   register_rest_route( 'wpca/v1', '/endpoint', array(
       'methods' => 'GET',
       'callback' => 'wpca_endpoint_callback',
       'permission_callback' => function() {
           return current_user_can( 'manage_options' );
       },
       'args' => array(
           'param' => array(
               'validate_callback' => function( $param ) {
                   return is_numeric( $param );
               }
           )
       )
   ) );
   ```

2. **验证 API 请求**：
   ```php
   function wpca_endpoint_callback( $request ) {
       // 验证请求参数
       $param = $request->get_param( 'param' );
       if ( ! is_numeric( $param ) ) {
           return new WP_Error( 'invalid_param', 'Invalid parameter', array( 'status' => 400 ) );
       }
       
       // 处理 API 请求
   }
   ```

3. **限制 API 访问频率**：
   ```php
   // 使用 WordPress 插件限制 API 访问频率
   // 或使用自定义代码实现
   function wpca_rate_limit( $response, $handler, $request ) {
       // 实现速率限制逻辑
       return $response;
   }
   add_filter( 'rest_post_dispatch', 'wpca_rate_limit', 10, 3 );
   ```

## 12. 安全的日志记录

### 12.1 安全的日志记录

**原则**：日志记录必须安全，避免泄露敏感信息，同时提供足够的调试信息。

**最佳实践**：

1. **使用 WordPress 内置日志函数**：
   ```php
   // 记录错误日志
   error_log( 'WP Clean Admin Error: ' . $error_message );
   
   // 使用 WordPress 调试日志
   if ( defined( 'WP_DEBUG_LOG' ) && WP_DEBUG_LOG ) {
       error_log( 'WP Clean Admin Debug: ' . $debug_message );
   }
   ```

2. **避免在日志中记录敏感信息**：
   ```php
   // 错误示例：记录敏感信息
   error_log( 'User login: ' . $username . ' Password: ' . $password );
   
   // 正确示例：记录安全的日志信息
   error_log( 'User login attempt: ' . $username . ' IP: ' . $_SERVER['REMOTE_ADDR'] );
   ```

3. **定期清理日志文件**：
   ```bash
   # 定期清理日志文件
   find /path/to/logs -name "*.log" -mtime +30 -delete
   ```

## 13. 安全的部署

### 13.1 部署安全

**原则**：部署过程必须安全，确保代码和配置的安全性。

**最佳实践**：

1. **使用版本控制**：
   ```bash
   # 使用 Git 管理代码
   git init
   git add .
   git commit -m "Initial commit"
   ```

2. **使用 CI/CD 自动化部署**：
   ```yaml
   # GitHub Actions 示例
   name: Deploy
   
   on: [push]
   
   jobs:
     deploy:
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v2
         - name: Install dependencies
           run: composer install
         - name: Run tests
           run: phpunit
         - name: Deploy to production
           run: |
             # 部署脚本
   ```

3. **设置安全的文件权限**：
   ```bash
   # 设置安全的文件权限
   chmod 644 wp-config.php
   chmod 755 wp-content
   chmod 644 *.php
   ```

## 14. 安全的开发流程

### 14.1 安全的开发实践

**原则**：整个开发流程必须融入安全实践，从需求分析到部署上线。

**最佳实践**：

1. **安全需求分析**：在需求分析阶段就考虑安全需求
2. **安全设计**：在设计阶段采用安全的架构和设计模式
3. **安全编码**：遵循安全编码规范，避免常见安全漏洞
4. **代码审查**：所有代码必须经过安全审查
5. **安全测试**：进行单元测试、集成测试和安全测试
6. **安全审计**：定期进行安全审计和漏洞扫描
7. **安全培训**：定期对开发人员进行安全培训

### 14.2 安全测试工具

1. **静态代码分析**：
   - PHPStan
   - ESLint
   - WordPress Coding Standards (WPCS)

2. **动态安全测试**：
   - OWASP ZAP
   - Burp Suite
   - Nikto

3. **依赖安全检查**：
   - Composer Audit
   - npm audit
   - Snyk

## 15. 应急响应

### 15.1 安全事件处理

**原则**：建立完善的应急响应机制，及时处理安全事件。

**最佳实践**：

1. **建立应急响应团队**：明确团队成员的职责和联系方式
2. **制定应急响应计划**：包括事件检测、分析、 containment、根除和恢复
3. **定期演练**：定期进行应急响应演练，提高团队的应急处理能力
4. **及时通知**：及时通知受影响的用户和相关方
5. **事后分析**：对安全事件进行事后分析，总结经验教训

## 16. 总结

安全是一个持续的过程，不是一次性的任务。开发人员必须始终保持安全意识，遵循安全开发最佳实践，定期更新安全知识，及时修复安全漏洞。

通过严格遵循本指南中的安全开发实践，可以有效防止常见的安全漏洞，保护 WP Clean Admin 项目的安全性，为用户提供安全可靠的产品。

## 17. 版本历史

| 版本号 | 更新时间 | 更新内容 | 更新人员 |
|--------|----------|----------|----------|
| 1.0.0 | 2025-11-30 | 初始版本 | Sut |
