# 模块开发指南

## 1. 概述

### 1.1 文档目的

本指南旨在帮助开发者了解 WP Clean Admin 项目的模块化架构，学习如何开发、测试和维护模块，以及如何遵循模块开发的最佳实践，确保模块的质量和可维护性。

### 1.2 模块化架构

WP Clean Admin 采用模块化架构设计，将功能拆分为独立的模块，便于开发、测试和维护。模块化架构具有以下优势：

- **高内聚低耦合**：模块内部功能紧密相关，模块之间依赖关系清晰
- **可扩展性**：便于添加新功能，无需修改现有代码
- **可维护性**：模块独立，便于理解、测试和修改
- **可重用性**：模块可以在不同项目中重用
- **并行开发**：多个开发者可以同时开发不同模块

### 1.3 模块类型

WP Clean Admin 支持以下类型的模块：

1. **核心模块**：提供插件的核心功能，如菜单管理、性能优化等
2. **扩展模块**：扩展核心功能，如自定义样式、高级设置等
3. **集成模块**：与第三方服务或插件集成
4. **工具模块**：提供开发或管理工具
5. **主题模块**：自定义插件的外观和样式

## 2. 模块架构

### 2.1 模块结构

1. **标准模块结构**：
   ```
   includes/
   ├── modules/                  # 模块目录
   │   ├── menu/                 # 菜单模块
   │   │   ├── class-wpca-menu-module.php # 模块主类
   │   │   ├── assets/           # 模块静态资源
   │   │   │   ├── css/          # CSS 文件
   │   │   │   └── js/           # JavaScript 文件
   │   │   └── includes/         # 模块辅助文件
   │   ├── performance/          # 性能优化模块
   │   └── style/                # 样式定制模块
   └── class-wpca-module-manager.php # 模块管理器
   ```

2. **模块组件**：
   - **模块主类**：负责模块的初始化和管理
   - **静态资源**：CSS、JavaScript、图片等
   - **辅助文件**：工具类、函数等
   - **配置文件**：模块配置和设置

### 2.2 模块管理器

1. **模块管理器职责**：
   - 模块的注册和加载
   - 模块的初始化和激活
   - 模块之间的通信和依赖管理
   - 模块的配置和设置
   - 模块的卸载和清理

2. **模块管理器实现**：
   ```php
   <?php
   namespace WPCleanAdmin;
   
   class ModuleManager {
       /**
        * 已注册的模块
        * @var array
        */
       private $modules = array();
       
       /**
        * 已激活的模块
        * @var array
        */
       private $active_modules = array();
       
       /**
        * 单例实例
        * @var ModuleManager
        */
       private static $instance = null;
       
       /**
        * 获取单例实例
        * @return ModuleManager
        */
       public static function getInstance() {
           if ( null === self::$instance ) {
               self::$instance = new self();
           }
           return self::$instance;
       }
       
       /**
        * 注册模块
        * @param string $module_name 模块名称
        * @param array $module_info 模块信息
        */
       public function registerModule( $module_name, $module_info ) {
           $this->modules[ $module_name ] = $module_info;
       }
       
       /**
        * 激活模块
        * @param string $module_name 模块名称
        */
       public function activateModule( $module_name ) {
           if ( isset( $this->modules[ $module_name ] ) ) {
               // 激活模块
               $module = $this->modules[ $module_name ];
               if ( class_exists( $module['class'] ) ) {
                   $module_instance = new $module['class']();
                   $module_instance->init();
                   $this->active_modules[ $module_name ] = $module_instance;
               }
           }
       }
       
       /**
        * 获取所有模块
        * @return array
        */
       public function getModules() {
           return $this->modules;
       }
       
       /**
        * 获取已激活的模块
        * @return array
        */
       public function getActiveModules() {
           return $this->active_modules;
       }
   }
   ```

## 3. 模块开发流程

### 3.1 开发准备

1. **了解模块化架构**：
   - 熟悉 WP Clean Admin 的模块化架构
   - 了解模块管理器的工作原理
   - 了解模块之间的通信机制

2. **确定模块需求**：
   - 明确模块的功能和范围
   - 确定模块的依赖关系
   - 设计模块的 API 和接口

3. **创建模块目录结构**：
   - 创建模块主目录
   - 创建模块主类文件
   - 创建静态资源目录
   - 创建辅助文件目录

### 3.2 开发流程

1. **创建模块主类**：
   - 实现模块的基本结构
   - 实现模块的初始化方法
   - 实现模块的核心功能

2. **注册模块**：
   - 在模块管理器中注册模块
   - 设置模块的元数据和依赖关系

3. **开发模块功能**：
   - 实现模块的核心功能
   - 添加静态资源
   - 实现模块的配置和设置

4. **测试模块**：
   - 单元测试
   - 集成测试
   - 功能测试

5. **调试模块**：
   - 启用调试模式
   - 使用调试工具
   - 记录日志

6. **发布模块**：
   - 更新模块元数据
   - 更新 CHANGELOG
   - 发布模块

## 4. 模块开发基础

### 4.1 模块主类

1. **模块主类结构**：
   ```php
   <?php
   namespace WPCleanAdmin\Modules\Menu;
   
   class MenuModule {
       /**
        * 模块版本
        * @var string
        */
       const VERSION = '1.0.0';
       
       /**
        * 模块名称
        * @var string
        */
       const NAME = 'menu';
       
       /**
        * 模块实例
        * @var MenuModule
        */
       private static $instance = null;
       
       /**
        * 获取单例实例
        * @return MenuModule
        */
       public static function getInstance() {
           if ( null === self::$instance ) {
               self::$instance = new self();
           }
           return self::$instance;
       }
       
       /**
        * 初始化模块
        */
       public function init() {
           // 注册钩子
           $this->registerHooks();
           
           // 加载静态资源
           $this->loadAssets();
           
           // 初始化功能
           $this->initFeatures();
       }
       
       /**
        * 注册钩子
        */
       private function registerHooks() {
           add_action( 'admin_menu', array( $this, 'addMenuPage' ) );
           add_action( 'admin_init', array( $this, 'registerSettings' ) );
       }
       
       /**
        * 加载静态资源
        */
       private function loadAssets() {
           add_action( 'admin_enqueue_scripts', array( $this, 'enqueueScripts' ) );
       }
       
       /**
        * 初始化功能
        */
       private function initFeatures() {
           // 初始化模块功能
       }
       
       /**
        * 添加菜单页面
        */
       public function addMenuPage() {
           add_submenu_page(
               'wp-clean-admin',
               __( '菜单管理', 'wp-clean-admin' ),
               __( '菜单管理', 'wp-clean-admin' ),
               'manage_options',
               'wpca-menu',
               array( $this, 'renderMenuPage' )
           );
       }
       
       /**
        * 渲染菜单页面
        */
       public function renderMenuPage() {
           // 渲染菜单页面
       }
       
       /**
        * 注册设置
        */
       public function registerSettings() {
           // 注册模块设置
       }
       
       /**
        * 加载脚本和样式
        */
       public function enqueueScripts() {
           // 加载模块脚本和样式
       }
   }
   ```

2. **模块注册**：
   ```php
   // 在插件主文件中注册模块
   function wpca_register_modules() {
       $module_manager = ModuleManager::getInstance();
       
       // 注册菜单模块
       $module_manager->registerModule( 'menu', array(
           'name' => __( '菜单管理', 'wp-clean-admin' ),
           'description' => __( '管理和清理 WordPress 后台菜单', 'wp-clean-admin' ),
           'class' => 'WPCleanAdmin\Modules\Menu\MenuModule',
           'version' => WPCleanAdmin\Modules\Menu\MenuModule::VERSION,
           'dependencies' => array(),
           'enabled' => true
       ) );
       
       // 注册其他模块
   }
   add_action( 'wpca_before_init', 'wpca_register_modules' );
   ```

### 4.2 模块配置

1. **模块设置**：
   ```php
   /**
    * 注册模块设置
    */
   public function registerSettings() {
       register_setting( 'wpca_menu_settings', 'wpca_menu_settings' );
       
       add_settings_section(
           'wpca_menu_general',
           __( '常规设置', 'wp-clean-admin' ),
           array( $this, 'renderGeneralSection' ),
           'wpca-menu'
       );
       
       add_settings_field(
           'wpca_menu_enabled',
           __( '启用菜单管理', 'wp-clean-admin' ),
           array( $this, 'renderEnabledField' ),
           'wpca-menu',
           'wpca_menu_general'
       );
   }
   
   /**
    * 渲染常规设置部分
    */
   public function renderGeneralSection() {
       echo __( '配置菜单管理的常规设置', 'wp-clean-admin' );
   }
   
   /**
    * 渲染启用字段
    */
   public function renderEnabledField() {
       $settings = get_option( 'wpca_menu_settings', array() );
       $enabled = isset( $settings['enabled'] ) ? $settings['enabled'] : true;
       
       echo '<input type="checkbox" name="wpca_menu_settings[enabled]" value="1" ' . checked( $enabled, true, false ) . ' />';
   }
   ```

2. **获取模块设置**：
   ```php
   /**
    * 获取模块设置
    * @return array
    */
   public function getSettings() {
       $default_settings = array(
           'enabled' => true,
           'menu_items' => array()
       );
       
       $settings = get_option( 'wpca_menu_settings', array() );
       return wp_parse_args( $settings, $default_settings );
   }
   ```

### 4.3 模块通信

1. **使用钩子系统**：
   ```php
   // 在模块中定义钩子
   do_action( 'wpca_menu_after_save', $menu_items );
   
   // 在其他模块中监听钩子
   add_action( 'wpca_menu_after_save', 'other_module_handle_menu_save' );
   function other_module_handle_menu_save( $menu_items ) {
       // 处理菜单保存事件
   }
   ```

2. **使用过滤器**：
   ```php
   // 在模块中使用过滤器
   $filtered_items = apply_filters( 'wpca_menu_items', $menu_items );
   
   // 在其他模块中添加过滤器
   add_filter( 'wpca_menu_items', 'other_module_modify_menu_items' );
   function other_module_modify_menu_items( $menu_items ) {
       // 修改菜单项目
       $menu_items['new-item'] = array(
           'name' => __( '新项目', 'wp-clean-admin' ),
           'slug' => 'new-item'
       );
       return $menu_items;
   }
   ```

3. **直接调用模块方法**：
   ```php
   // 获取模块实例
   $module_manager = ModuleManager::getInstance();
   $menu_module = $module_manager->getActiveModules()['menu'];
   
   // 调用模块方法
   $menu_items = $menu_module->getMenuItems();
   ```

## 4. 模块开发进阶

### 4.1 模块依赖管理

1. **声明模块依赖**：
   ```php
   // 注册带有依赖的模块
   $module_manager->registerModule( 'advanced-menu', array(
       'name' => __( '高级菜单管理', 'wp-clean-admin' ),
       'description' => __( '高级菜单管理功能', 'wp-clean-admin' ),
       'class' => 'WPCleanAdmin\Modules\AdvancedMenu\AdvancedMenuModule',
       'version' => '1.0.0',
       'dependencies' => array( 'menu' ), // 依赖菜单模块
       'enabled' => true
   ) );
   ```

2. **检查模块依赖**：
   ```php
   /**
    * 检查模块依赖
    * @param string $module_name 模块名称
    * @return bool
    */
   public function checkDependencies( $module_name ) {
       if ( ! isset( $this->modules[ $module_name ] ) ) {
           return false;
       }
       
       $module = $this->modules[ $module_name ];
       $dependencies = isset( $module['dependencies'] ) ? $module['dependencies'] : array();
       
       foreach ( $dependencies as $dependency ) {
           if ( ! isset( $this->modules[ $dependency ] ) || ! isset( $this->active_modules[ $dependency ] ) ) {
               return false;
           }
       }
       
       return true;
   }
   ```

### 4.2 模块国际化

1. **加载语言文件**：
   ```php
   /**
    * 加载语言文件
    */
   private function loadTextdomain() {
       load_plugin_textdomain( 'wp-clean-admin', false, dirname( plugin_basename( WPCA_PLUGIN_FILE ) ) . '/languages/' );
   }
   ```

2. **使用翻译函数**：
   ```php
   // 翻译文本
   $text = __( '菜单管理', 'wp-clean-admin' );
   
   // 翻译并回显文本
   _e( '菜单管理', 'wp-clean-admin' );
   
   // 翻译带上下文的文本
   $context_text = _x( '菜单', '上下文描述', 'wp-clean-admin' );
   
   // 翻译复数形式
   $plural_text = _n( '菜单项', '菜单项', $count, 'wp-clean-admin' );
   ```

### 4.3 模块 REST API

1. **注册 REST API 端点**：
   ```php
   /**
    * 注册 REST API 端点
    */
   private function registerRestRoutes() {
       register_rest_route( 'wpca/v1', '/menu/items', array(
           'methods' => 'GET',
           'callback' => array( $this, 'getMenuItemsApi' ),
           'permission_callback' => function() {
               return current_user_can( 'manage_options' );
           }
       ) );
       
       register_rest_route( 'wpca/v1', '/menu/items', array(
           'methods' => 'POST',
           'callback' => array( $this, 'saveMenuItemsApi' ),
           'permission_callback' => function() {
               return current_user_can( 'manage_options' );
           }
       ) );
   }
   ```

2. **实现 API 回调**：
   ```php
   /**
    * 获取菜单项目 API
    */
   public function getMenuItemsApi( $request ) {
       $menu_items = $this->getMenuItems();
       return rest_ensure_response( $menu_items );
   }
   
   /**
    * 保存菜单项目 API
    */
   public function saveMenuItemsApi( $request ) {
       $data = $request->get_json_params();
       $this->saveMenuItems( $data );
       return rest_ensure_response( array( 'success' => true ) );
   }
   ```

### 4.4 模块升级

1. **版本管理**：
   ```php
   /**
    * 检查模块升级
    */
   public function checkUpgrade() {
       $current_version = get_option( 'wpca_menu_version', '0.0.0' );
       
       // 如果版本不同，执行升级
       if ( version_compare( $current_version, self::VERSION, '<' ) ) {
           $this->upgrade( $current_version );
           // 更新版本号
           update_option( 'wpca_menu_version', self::VERSION );
       }
   }
   
   /**
    * 执行模块升级
    * @param string $from_version 旧版本
    */
   private function upgrade( $from_version ) {
       // 根据版本执行不同的升级操作
       if ( version_compare( $from_version, '1.0.0', '<' ) ) {
           // 升级到 1.0.0 版本
           $this->upgradeTo100();
       }
       
       if ( version_compare( $from_version, '1.1.0', '<' ) ) {
           // 升级到 1.1.0 版本
           $this->upgradeTo110();
       }
   }
   
   /**
    * 升级到 1.0.0 版本
    */
   private function upgradeTo100() {
       // 执行 1.0.0 版本的升级操作
   }
   
   /**
    * 升级到 1.1.0 版本
    */
   private function upgradeTo110() {
       // 执行 1.1.0 版本的升级操作
   }
   ```

2. **调用升级检查**：
   ```php
   // 在模块初始化时检查升级
   public function init() {
       // 检查升级
       $this->checkUpgrade();
       
       // 其他初始化操作
   }
   ```

## 5. 模块测试与调试

### 5.1 测试方法

1. **单元测试**：
   ```php
   <?php
   
   use PHPUnit\Framework\TestCase;
   use WPCleanAdmin\Modules\Menu\MenuModule;
   
   class TestMenuModule extends TestCase {
       /**
        * 测试模块初始化
        */
       public function testInit() {
           $menu_module = MenuModule::getInstance();
           $this->assertInstanceOf( MenuModule::class, $menu_module );
           
           // 测试模块初始化
           $menu_module->init();
           $this->assertTrue( true ); // 初始化没有抛出异常
       }
       
       /**
        * 测试获取菜单项目
        */
       public function testGetMenuItems() {
           $menu_module = MenuModule::getInstance();
           $menu_items = $menu_module->getMenuItems();
           $this->assertIsArray( $menu_items );
       }
   }
   ```

2. **集成测试**：
   ```php
   <?php
   
   use PHPUnit\Framework\TestCase;
   use WPCleanAdmin\ModuleManager;
   use WPCleanAdmin\Modules\Menu\MenuModule;
   
   class TestModuleIntegration extends TestCase {
       /**
        * 测试模块注册和激活
        */
       public function testModuleRegistration() {
           $module_manager = ModuleManager::getInstance();
           
           // 注册模块
           $module_manager->registerModule( 'menu', array(
               'name' => '菜单管理',
               'class' => MenuModule::class,
               'enabled' => true
           ) );
           
           // 激活模块
           $module_manager->activateModule( 'menu' );
           
           // 检查模块是否激活
           $active_modules = $module_manager->getActiveModules();
           $this->assertArrayHasKey( 'menu', $active_modules );
           $this->assertInstanceOf( MenuModule::class, $active_modules['menu'] );
       }
   }
   ```

3. **功能测试**：
   - 在本地开发环境中测试模块功能
   - 测试模块的核心功能
   - 测试模块的边界情况
   - 测试模块的错误处理

### 5.2 调试技巧

1. **启用调试模式**：
   ```php
   // 在 wp-config.php 中添加
   define( 'WP_DEBUG', true );
   define( 'WP_DEBUG_DISPLAY', true );
   define( 'WP_DEBUG_LOG', true );
   ```

2. **使用调试工具**：
   - Debug Bar
   - Query Monitor
   - Xdebug

3. **日志记录**：
   ```php
   // 记录模块日志
   error_log( 'WP Clean Admin Menu Module: ' . $message );
   
   // 使用 WordPress 调试日志
   if ( defined( 'WP_DEBUG_LOG' ) && WP_DEBUG_LOG ) {
       error_log( 'WP Clean Admin Menu Module Debug: ' . $debug_message );
   }
   ```

4. **使用 var_dump 和 print_r**：
   ```php
   // 调试变量
   var_dump( $menu_items );
   print_r( $settings );
   
   // 在 WordPress 后台输出调试信息
   add_action( 'admin_notices', function() {
       echo '<div class="notice notice-debug"><p>' . esc_html( $debug_message ) . '</p></div>';
   } );
   ```

## 6. 模块发布与维护

### 6.1 准备发布

1. **更新模块元数据**：
   - 检查模块版本号
   - 更新模块描述
   - 更新作者信息
   - 更新依赖关系

2. **更新 CHANGELOG**：
   ```markdown
   # Changelog
   
   ## 1.0.0 (2025-11-30)
   - 初始版本
   - 添加菜单管理功能
   - 支持菜单清理和定制
   
   ## 1.1.0 (2025-12-15)
   - 添加高级菜单设置
   - 支持按角色管理菜单
   - 优化菜单加载性能
   ```

3. **测试模块**：
   - 运行所有测试
   - 测试模块的兼容性
   - 测试模块的性能

### 6.2 发布流程

1. **提交代码**：
   ```bash
   # 提交代码
   git add .
   git commit -m "feat(menu): 添加高级菜单功能"
   git push origin feature/advanced-menu
   ```

2. **创建 Pull Request**：
   - 登录 GitHub
   - 进入项目仓库
   - 点击「New Pull Request」
   - 选择源分支和目标分支
   - 填写 PR 描述
   - 提交 PR

3. **代码审查**：
   - 等待代码审查
   - 根据审查意见修改代码
   - 重新提交代码

4. **合并代码**：
   - 代码审查通过后，合并到主分支
   - 标记版本标签
   - 发布新版本

### 6.3 模块维护

1. **定期更新**：
   - 修复 bug
   - 添加新功能
   - 优化性能
   - 提高兼容性

2. **收集反馈**：
   - 监听用户反馈
   - 处理 bug 报告
   - 考虑用户建议

3. **文档维护**：
   - 更新模块文档
   - 提供使用示例
   - 编写教程和指南

4. **社区支持**：
   - 回答用户问题
   - 参与社区讨论
   - 分享知识和经验

## 7. 最佳实践

### 7.1 编码规范

1. **遵循 WordPress 编码规范**：
   - 使用 4 个空格作为缩进
   - 每行代码长度不超过 120 个字符
   - 使用 `<?php` 标签，禁止使用短标签 `<?`
   - PHP 文件末尾禁止使用闭合标签 `?>`

2. **使用命名空间**：
   ```php
   namespace WPCleanAdmin\Modules\Menu;
   
   class MenuModule {
       // 类代码
   }
   ```

3. **添加注释**：
   - 使用 PHPDoc 注释类、方法和函数
   - 为复杂代码添加行内注释
   - 注释使用中文

4. **使用单例模式**：
   ```php
   class MenuModule {
       private static $instance = null;
       
       public static function getInstance() {
           if ( null === self::$instance ) {
               self::$instance = new self();
           }
           return self::$instance;
       }
       
       private function __construct() {
           // 私有构造函数
       }
   }
   ```

### 7.2 模块设计原则

1. **单一职责原则**：
   - 每个模块只负责一个功能领域
   - 模块内部功能紧密相关

2. **依赖倒置原则**：
   - 依赖抽象而非具体实现
   - 使用接口定义模块之间的通信

3. **开闭原则**：
   - 对扩展开放，对修改关闭
   - 便于添加新功能，无需修改现有代码

4. **接口隔离原则**：
   - 模块接口应该小而专一
   - 避免不必要的依赖

5. **迪米特法则**：
   - 模块只与直接依赖的模块通信
   - 减少模块之间的耦合

### 7.3 性能优化

1. **懒加载**：
   - 只在需要时加载模块
   - 延迟加载资源

2. **缓存**：
   - 使用对象缓存存储频繁访问的数据
   - 缓存计算结果

3. **优化资源加载**：
   - 只在需要时加载脚本和样式
   - 压缩脚本和样式文件
   - 使用异步加载和延迟加载

4. **优化数据库查询**：
   - 减少数据库查询次数
   - 使用索引加速查询
   - 缓存查询结果

### 7.4 安全性

1. **输入验证和过滤**：
   - 验证所有用户输入
   - 使用 WordPress 内置验证函数
   - 过滤所有输出到页面的内容

2. **权限检查**：
   - 验证用户权限
   - 使用 WordPress 内置权限函数
   - 为所有管理操作添加权限检查

3. **防止 SQL 注入**：
   - 使用预处理语句
   - 避免直接拼接 SQL 语句
   - 使用 WordPress 数据库类

4. **防止 CSRF 攻击**：
   - 使用 Nonce 验证
   - 为所有表单添加 Nonce
   - 验证 AJAX 请求的 Nonce

## 8. 总结

模块化开发是 WP Clean Admin 项目的核心设计理念，通过模块化架构，可以提高代码的可维护性、可扩展性和可重用性。本指南介绍了模块开发的各个方面，包括模块架构、开发流程、基础开发、进阶开发、测试与调试、发布与维护以及最佳实践。

通过遵循本指南中的最佳实践和规范，开发者可以开发出高质量、可维护的模块，为 WP Clean Admin 项目做出贡献。模块化开发不仅可以提高开发效率，还可以提高代码质量，减少 bug，增强系统的可靠性和可扩展性。

## 9. 版本历史

| 版本号 | 更新时间 | 更新内容 | 更新人员 |
|--------|----------|----------|----------|
| 1.0.0 | 2025-11-30 | 初始版本 | Sut |
