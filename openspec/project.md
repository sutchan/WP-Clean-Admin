<!-- OPENSPEC:START -->
# 项目上下文

## 目的
WP Clean Admin 是一个全面的 WordPress 后台清理和优化插件，旨在帮助管理员清理和优化 WordPress 后台，提高网站性能和管理效率。

## 技术栈
- PHP 7.0+
- WordPress 5.0+
- MySQL 5.6+
- JavaScript (ES6+)
- CSS3

## 项目约定

### 代码风格
- 采用 WordPress 编码规范
- 使用 PSR-4 自动加载
- 类名采用 PascalCase 命名
- 方法名采用 camelCase 命名
- 函数名采用 snake_case 命名，以 `wpca_` 为前缀
- 变量名采用 snake_case 命名
- 常量名采用全大写加下划线命名，以 `WPCA_` 为前缀
- 代码缩进使用 4 个空格
- 文件编码为 UTF-8 with BOM
- 行尾序列为 Unix LF

### 架构模式
- 模块化设计：功能划分为独立模块，便于维护和扩展
- 单例模式：核心类和功能模块使用单例模式
- 钩子机制：深度集成 WordPress 钩子系统
- 面向对象设计：采用面向对象编程范式
- 依赖注入：通过核心类初始化和协调其他模块

### 测试策略
- 单元测试：对核心功能进行单元测试
- 集成测试：测试模块之间的集成
- 手动测试：验证用户界面和功能完整性
- 兼容性测试：测试不同 WordPress 版本和主题的兼容性
- 代码覆盖率：确保代码覆盖率不低于 80%

### Git 工作流程
- 主分支：main
- 开发分支：dev
- 功能分支：feature/功能名
- 修复分支：fix/问题描述
- 提交消息格式：<类型>: <描述>，如 feat: 添加新功能，fix: 修复bug

## 领域上下文
WordPress 插件开发领域，专注于后台管理优化和性能提升。插件通过 WordPress 钩子系统扩展 WordPress 功能，无需修改核心文件。

## 重要约束
- 不修改 WordPress 核心文件
- 兼容 WordPress 5.0+ 和 PHP 7.0+
- 遵循 WordPress 安全最佳实践
- 保持插件体积小，加载速度快
- 遵循 WordPress 插件开发规范
- 提供完整的国际化支持

## 外部依赖
- WordPress 核心功能
- MySQL 数据库
- PHP 标准库
- WordPress 钩子系统
- WordPress 函数和类

## 目录结构

### 插件主目录结构
```
wpcleanadmin/
├── assets/                    # 静态资源目录
│   ├── css/                   # CSS 文件
│   └── js/                    # JavaScript 文件
├── includes/                  # 核心功能目录
│   ├── autoload.php           # 自动加载文件
│   ├── class-*.php            # 各个功能类
│   └── wpca-core-functions.php # 核心函数
├── languages/                 # 语言文件目录
└── wp-clean-admin.php         # 插件主文件
```

### OpenSpec 目录结构
```
openspec/
├── project.md              # 项目约定
├── specs/                  # 当前规范 - 已构建的内容
│   └── [capability]/       # 单个聚焦功能
│       ├── spec.md         # 需求和场景
│       └── design.md       # 技术模式
├── changes/                # 提案 - 应该变更的内容
│   ├── [change-name]/
│   │   ├── proposal.md     # 原因、内容、影响
│   │   ├── tasks.md        # 实施清单
│   │   ├── design.md       # 技术决策（可选）
│   │   └── specs/          # 增量变更
│   │       └── [capability]/
│   │           └── spec.md # ADDED/MODIFIED/REMOVED
│   └── archive/            # 已完成的变更
└── archive/                # 归档的旧文档
```

## 核心功能模块

### 1. 核心模块 (Core)
- 插件初始化和模块协调
- 版本管理和激活/停用处理
- 默认设置初始化

### 2. 设置管理模块 (Settings)
- 管理插件的所有设置
- 提供设置页面和表单处理
- 设置验证和保存

### 3. 仪表盘模块 (Dashboard)
- 优化 WordPress 仪表盘
- 提供插件的主要管理界面
- 显示系统信息和统计数据
- 隐藏不需要的仪表盘小工具

### 4. 清理模块 (Cleanup)
- 提供数据库、媒体、评论和内容清理功能
- 清理过期的transients
- 清理孤儿元数据
- 清理过期的cron事件
- 清理孤儿媒体和未使用的媒体
- 清理垃圾评论、回收站评论和未批准评论
- 清理未使用的短代码和空帖子

### 5. 性能优化模块 (Performance)
- 优化 WordPress 网站性能
- 禁用不必要的功能（Emojis、XML-RPC、REST API、Heartbeat）
- 优化数据库
- 清理Transients
- 提供缓存清理功能
- 提供性能统计信息

### 6. 权限管理模块 (Permissions)
- 管理用户权限和访问控制
- 过滤用户权限
- 检查用户功能访问权限
- 限制管理后台访问
- 限制特定管理页面访问

### 7. 用户角色模块 (User_Roles)
- 管理用户角色和权限
- 允许创建、编辑和删除角色
- 提供角色权限编辑器

### 8. 菜单管理模块 (Menu_Manager)
- 管理 WordPress 后台菜单结构
- 提供菜单信息和结构

### 9. 菜单定制模块 (Menu_Customizer)
- 自定义 WordPress 后台菜单和管理栏
- 自定义菜单顺序
- 自定义菜单项目（隐藏、修改标题、图标和位置）
- 自定义子菜单项目（隐藏、修改标题）
- 自定义管理栏项目（隐藏、修改标题）
- 提供设置导出/导入功能

### 10. 登录页面模块 (Login)
- 自定义 WordPress 登录页面
- 自定义登录页面样式
- 增强登录页面安全性

### 11. 数据库管理模块 (Database)
- 管理和优化 WordPress 数据库
- 清理数据库
- 优化数据库
- 备份数据库
- 恢复数据库

### 12. 资源管理模块 (Resources)
- 管理和优化 WordPress 资源
- 优化 CSS 和 JavaScript 加载
- 处理静态资源

### 13. 重置模块 (Reset)
- 提供插件设置的重置功能
- 允许重置特定模块或全部设置

### 14. AJAX 模块 (AJAX)
- 处理插件的 AJAX 请求
- 提供 AJAX 回调函数

### 15. 国际化模块 (i18n)
- 处理插件的国际化和本地化
- 加载翻译文件

### 16. 扩展 API 模块 (Extension_API)
- 提供插件扩展 API
- 允许第三方扩展插件功能

### 17. Composer 集成模块 (Composer)
- 提供 Composer 依赖管理
- 处理依赖冲突和版本管理

### 18. Elementor 集成模块 (Elementor)
- 集成和优化 Elementor 页面构建器
- 清理 Elementor 缓存和数据

### 19. 主题模板模块 (Theme_Templates)
- 管理和优化主题模板
- 检测和清理未使用的主题文件

## 安全设计

### 输入验证
- 所有用户输入必须经过验证：使用 WordPress 验证函数
- 验证类型：字符串、数字、邮箱、URL 等
- 验证函数：`sanitize_text_field()`, `sanitize_email()`, `sanitize_url()`, `absint()` 等

### 输出转义
- 所有输出到页面的内容必须转义：防止 XSS 攻击
- 转义函数：`esc_html()`, `esc_attr()`, `esc_url()`, `esc_js()` 等

### SQL 注入防护
- 使用 `$wpdb->prepare()` 处理所有 SQL 查询：防止 SQL 注入
- 参数绑定：将用户输入作为参数绑定，而不是直接插入 SQL

### CSRF 防护
- 使用 nonce 验证所有表单提交：防止 CSRF 攻击
- 函数：`wp_nonce_field()`, `wp_verify_nonce()`

### 权限检查
- 所有管理操作必须检查权限：防止未授权访问
- 函数：`wpca_current_user_can()`, `current_user_can()`

### 安全头部
- 添加安全 HTTP 头部：增强网站安全性
- 头部：X-Frame-Options, X-XSS-Protection, X-Content-Type-Options, Strict-Transport-Security, Content-Security-Policy

## 兼容性

### WordPress 版本兼容性
- 最低版本：WordPress 5.0+
- 兼容性检查：使用 `function_exists()` 检查函数是否存在
- 功能降级：根据 WordPress 版本提供不同功能

### PHP 版本兼容性
- 最低版本：PHP 7.0+
- 兼容性检查：使用 `function_exists()` 检查函数是否存在
- 语法兼容：使用兼容 PHP 7.0+ 的语法

### 浏览器兼容性
- 支持浏览器：Chrome, Firefox, Safari, Edge
- 兼容性处理：使用兼容的 HTML, CSS, JavaScript
- 响应式设计：支持不同屏幕尺寸

### 主题兼容性
- 兼容性处理：与主流 WordPress 主题兼容
- 样式隔离：使用独特的 CSS 类名，避免样式冲突
- 钩子集成：提供钩子供主题扩展

## 部署和维护

### 插件安装
- 自动安装：通过 WordPress 后台安装
- 手动安装：上传 ZIP 文件或 FTP 上传
- 命令行安装：使用 WP CLI 安装

### 版本管理
- 自动更新：支持 WordPress 自动更新
- 手动更新：上传新版本 ZIP 文件
- 版本控制：使用 Git 进行版本控制

### 错误处理
- 日志记录：使用 `wpca_log()` 函数记录日志
- 异常处理：使用 `try/catch` 块处理异常
- 管理通知：使用 `wpca_admin_notice()` 函数显示通知

### 数据迁移
- 设置迁移：支持设置的导入和导出
- 数据库迁移：支持数据库备份和恢复
- 升级迁移：处理版本升级时的数据迁移

## 开发指南

### 代码规范
- 遵循 WordPress 编码规范
- 使用 PSR-4 自动加载
- 类名采用 PascalCase 命名
- 方法名采用 camelCase 命名
- 函数名采用 snake_case 命名，以 `wpca_` 为前缀
- 变量名采用 snake_case 命名
- 常量名采用全大写加下划线命名，以 `WPCA_` 为前缀

### 命名空间
- 使用 `WPCleanAdmin` 命名空间
- 所有类都位于该命名空间下

### 自动加载
- 使用 PSR-4 自动加载规范
- 类文件位于 `includes/` 目录下
- 类名与文件名对应，例如 `WPCleanAdmin\Core` 对应 `includes/class-wpca-core.php`

### 测试
- 编写单元测试和集成测试
- 确保代码覆盖率不低于 80%
- 提交代码前运行测试

### 文档
- 文档与代码同步更新
- 为每个功能模块编写规范文档
- 为 API 函数编写文档
- 为类和方法编写 PHPDoc 注释

## 贡献指南

### 贡献方式
- Fork 仓库
- 创建功能分支
- 提交代码
- 创建 Pull Request

### 代码要求
- 遵循项目编码规范
- 编写测试用例
- 更新文档
- 遵循提交信息格式

### 审查流程
- 代码审查
- 测试验证
- 合并到 develop 分支
- 定期发布到 main 分支

## 版本历史

### [1.8.0] - 2026-01-02
- 新增了主题模板模块
- 增强了Elementor集成功能
- 优化了Composer依赖管理
- 完善了扩展API
- 修复了多处安全漏洞
- 优化了性能
- 更新了语言文件
- 完善了文档

### [1.7.15] - 2025-11-29
- 修复了后台菜单隐藏功能的兼容性问题
- 修复了数据库优化功能的错误
- 优化了插件的加载性能
- 改进了登录页面样式
- 更新了语言文件
- 优化了代码结构

### [1.7.14] - 2025-11-20
- 新增了用户界面自定义功能
- 新增了菜单组创建功能
- 修复了仪表盘小工具隐藏功能
- 修复了设置页面的错误
- 优化了后台界面的响应式设计
- 改进了插件的错误处理机制

### [1.7.13] - 2025-11-10
- 新增了数据库备份和恢复功能
- 新增了登录尝试限制功能
- 修复了性能优化模块的计时问题
- 修复了菜单定位功能的错误
- 优化了插件的资源加载
- 改进了用户体验

### [1.7.12] - 2025-11-01
- 新增了安全增强功能
- 新增了 XML-RPC 禁用选项
- 修复了后台清理功能的错误
- 修复了用户权限管理功能
- 优化了插件的代码结构
- 改进了文档

### [1.7.11] - 2025-10-20
- 新增了菜单定位功能
- 新增了性能优化模块
- 修复了数据库管理功能的错误
- 修复了登录页面样式问题
- 优化了插件的加载速度
- 改进了界面设计

### [1.7.10] - 2025-10-10
- 新增了数据库管理功能
- 新增了用户权限管理系统
- 修复了后台清理功能的兼容性问题
- 修复了仪表盘小工具隐藏功能
- 优化了插件的整体性能
- 改进了错误处理

### [1.7.9] - 2025-09-25
- 新增了仪表盘小工具隐藏功能
- 新增了后台头部和底部清理功能
- 修复了菜单隐藏功能的错误
- 修复了插件更新检查功能
- 优化了插件的设置界面
- 改进了用户体验

### [1.7.8] - 2025-09-15
- 新增了后台菜单隐藏功能
- 新增了登录页面优化功能
- 修复了插件的兼容性问题
- 修复了语言文件加载问题
- 优化了插件的代码结构
- 改进了文档

### [1.7.7] - 2025-09-05
- 新增了插件设置页面
- 新增了多语言支持
- 修复了插件的初始化问题
- 修复了资源加载错误
- 优化了插件的性能
- 改进了界面设计

### [1.7.6] - 2025-08-25
- 新增了自动加载功能
- 新增了插件核心架构
- 修复了插件的缓存问题
- 修复了文件路径问题
- 优化了插件的代码组织
- 改进了开发流程

### [1.7.5] - 2025-08-15
- 首次发布 WP Clean Admin 插件
- 实现了基本的后台清理功能
- 支持 WordPress 5.0+
- 修复了初始版本的一些小问题
- 优化了插件的初始架构
- 改进了用户体验

### [1.0.0] - 2025-08-01
- 项目初始版本
- 核心功能设计
- 框架代码实现

## 许可证

WP Clean Admin 插件遵循 GPLv2 或更高版本许可证。

<!-- OPENSPEC:END -->
