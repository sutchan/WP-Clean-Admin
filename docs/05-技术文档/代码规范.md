# WP Clean Admin 代码规范

## 目录

- [1. 基础规范](#1-基础规范)
- [2. PHP 代码规范](#2-php-代码规范)
- [3. JavaScript 代码规范](#3-javascript-代码规范)
- [4. CSS 代码规范](#4-css-代码规范)
- [5. HTML 代码规范](#5-html-代码规范)
- [6. 插件开发规范](#6-插件开发规范)
- [7. 测试规范](#7-测试规范)
- [8. 文档规范](#8-文档规范)
- [9. 版本管理规范](#9-版本管理规范)
- [10. 总结](#10-总结)

## 1. 基础规范

### 1.1 文件命名规范
- **编码格式**：所有文件必须使用 UTF-8 编码，无 BOM
- **换行符**：统一使用 Unix LF 换行符
- **缩进**：使用 4 个空格作为缩进，禁止使用制表符
- **行宽**：每行代码长度建议不超过 120 个字符
- **文件名**：使用小写字母和连字符，例如 `class-wpca-core.php`

### 1.2 命名规范
- **类名**：使用 PascalCase，例如 `WPCleanAdmin\Core`
- **方法名**：使用 camelCase，例如 `getInstance()`
- **函数名**：使用 snake_case，例如 `wpca_get_settings()`
- **变量名**：使用 snake_case，例如 `$plugin_settings`
- **常量名**：使用全大写字母和下划线，例如 `WPCA_VERSION`
- **钩子名**：使用 snake_case，例如 `wpca_after_save_settings`

### 1.3 注释规范
- **文件头部注释**：每个文件必须包含头部注释，说明文件名称、版本、作者等信息
- **类注释**：每个类必须包含 PHPDoc 注释，说明类的功能和用途
- **方法注释**：每个方法必须包含 PHPDoc 注释，说明方法的参数、返回值和功能
- **函数注释**：每个函数必须包含 PHPDoc 注释，说明函数的参数、返回值和功能
- **单行注释**：使用 `//` 进行单行注释，注释内容与代码之间保持一个空格
- **多行注释**：使用 `/* */` 进行多行注释，适用于较长的注释内容

### 1.4 Git 规范
- **提交信息格式**：使用 Conventional Commits 规范
  - `feat:` 新增功能
  - `fix:` 修复 bug
  - `docs:` 更新文档
  - `style:` 代码风格变更
  - `refactor:` 代码重构
  - `test:` 测试相关
  - `chore:` 构建或辅助工具变更
  - 示例：`feat: 添加菜单定制功能`
- **分支命名**：
  - `main`：主分支，用于发布稳定版本
  - `develop`：开发分支，用于集成新功能
  - `feature/xxx`：功能分支，用于开发新功能
  - `bugfix/xxx`：修复分支，用于修复 bug
- **版本号**：遵循 SemVer 规范，格式为 `MAJOR.MINOR.PATCH`

## 2. PHP 代码规范

### 2.1 基础语法规范
- **PHP 标签**：使用 `<?php` 标签，禁止使用短标签 `<?`
- **闭合标签**：PHP 文件末尾禁止使用闭合标签 `?>`
- **命名空间**：使用 `WPCleanAdmin` 命名空间，例如 `namespace WPCleanAdmin;`
- **自动加载**：遵循 PSR-4 自动加载规范

### 2.2 类设计规范
- **类结构**：类成员变量在前，方法在后，按访问权限排序
- **构造函数**：使用 `__construct()` 方法
- **单例模式**：使用 `getInstance()` 方法实现单例模式
- **访问修饰符**：明确使用 `public`、`protected` 或 `private` 修饰符
- **方法参数**：参数类型声明，返回值类型声明
- **文档注释**：每个类和方法必须包含 PHPDoc 注释

**示例代码**：
```php
<?php
/**
 * Core class for WP Clean Admin plugin
 *
 * @package WPCleanAdmin
 */

namespace WPCleanAdmin;

/**
 * Core class
 */
class Core {
    /**
     * Singleton instance
     *
     * @var Core
     */
    protected static $instance = null;

    /**
     * Get singleton instance
     *
     * @return Core
     */
    public static function getInstance() {
        if ( null === self::$instance ) {
            self::$instance = new self();
        }
        return self::$instance;
    }

    /**
     * Constructor
     */
    protected function __construct() {
        $this->init();
    }

    /**
     * Initialize plugin
     *
     * @return void
     */
    protected function init() {
        // Initialization code
    }
}
```

### 2.3 变量和常量规范
- **变量命名**：使用 `$` 符号，变量名使用 snake_case
- **常量定义**：使用 `define()` 函数或 `const` 关键字
- **全局变量**：尽量避免使用全局变量，如需使用必须使用 `global` 关键字声明
- **超全局变量**：直接使用超全局变量，如 `$_GET`、`$_POST`、`$_SERVER`

### 2.4 函数设计规范
- **函数命名**：使用 `function` 关键字，函数名使用 snake_case
- **引用传递**：明确使用 `&` 符号表示引用传递
- **文档注释**：每个函数必须包含 PHPDoc 注释
- **错误处理**：使用 `WP_Error` 类处理错误

**示例代码**：
```php
/**
 * Get plugin settings
 *
 * @param string $key Specific setting key to get
 * @param mixed $default Default value if setting not found
 * @return mixed Plugin settings or specific setting value
 */
function wpca_get_settings( string $key = '', $default = false ) {
    $settings = get_option( 'wpca_settings', array() );
    
    if ( empty( $key ) ) {
        return $settings;
    }
    
    return isset( $settings[ $key ] ) ? $settings[ $key ] : $default;
}
```

### 2.5 控制结构规范
- **条件语句**：使用 `if/elseif/else` 或 `switch` 语句，缩进正确
- **循环语句**：优先使用 `foreach` 循环，其次是 `for` 循环
- **大括号位置**：大括号必须单独占一行，与控制结构对齐
- **比较运算符**：使用 `===` 和 `!==` 进行严格比较，避免使用 `==` 和 `!=`

**示例代码**：
```php
// 条件语句
if ( $a === $b ) {
    // 执行代码
} elseif ( $a > $b ) {
    // 执行代码
} else {
    // 执行代码
}

// 循环语句
foreach ( $array as $key => $value ) {
    // 执行代码
}

for ( $i = 0; $i < 10; $i++ ) {
    // 执行代码
}
```

### 2.6 错误处理规范
- **调试模式**：使用 `WP_DEBUG` 常量控制调试输出
- **异常处理**：使用 `try/catch` 块处理异常
- **日志记录**：使用 `wpca_log()` 函数记录日志
- **管理通知**：使用 `wpca_admin_notice()` 函数显示管理通知

### 2.7 安全规范
- **输入验证**：所有用户输入必须经过验证和过滤
- **输出转义**：所有输出到页面的内容必须经过转义
- **SQL 注入防护**：使用 `$wpdb->prepare()` 函数处理 SQL 查询
- **XSS 防护**：使用 `esc_html()`、`esc_attr()`、`esc_url()` 等函数转义输出
- **CSRF 防护**：使用 `wp_nonce_field()` 和 `wp_verify_nonce()` 函数防止 CSRF 攻击
- **权限检查**：使用 `wpca_current_user_can()` 函数检查用户权限

**示例代码**：
```php
// 输入验证
$name = sanitize_text_field( $_POST['name'] );
$email = sanitize_email( $_POST['email'] );

// 输出转义
echo '<h1>' . esc_html( $title ) . '</h1>';
echo '<a href="' . esc_url( $url ) . '" title="' . esc_attr( $title ) . '">链接文本</a>';

// SQL 注入防护
$results = $wpdb->get_results( $wpdb->prepare( "SELECT * FROM {$wpdb->posts} WHERE ID = %d", $post_id ) );

// CSRF 防护
if ( isset( $_POST['submit'] ) ) {
    if ( ! wp_verify_nonce( $_POST['_wpnonce'], 'wpca_save_settings' ) ) {
        wp_die( 'Invalid nonce' );
    }
    // 执行保存操作
}
```

## 3. JavaScript 代码规范

### 3.1 基础语法规范
- **文件名**：使用小写字母和连字符，例如 `wpca-main.js`
- **变量声明**：使用 `const` 或 `let`，禁止使用 `var`
- **分号**：必须使用分号结束语句
- **字符串引号**：使用单引号 `'` 定义字符串

### 3.2 命名规范
- **变量名**：使用 camelCase，例如 `pluginSettings`
- **函数名**：使用 camelCase，例如 `initPlugin()`
- **类名**：使用 PascalCase，例如 `WPCleanAdmin`
- **常量**：使用全大写字母和下划线，例如 `PLUGIN_VERSION`

### 3.3 代码组织规范
- **模块封装**：使用 IIFE（立即执行函数表达式）封装代码，避免污染全局命名空间
- **错误处理**：使用 `try/catch` 块处理异步操作错误
- **异步编程**：优先使用 `async/await` 语法，其次是 Promise
- **错误处理**：使用 `try/catch` 块处理异常

**示例代码**：
```javascript
// IIFE 模块封装
( function( $ ) {
    'use strict';

    const WPCleanAdmin = {
        /**
         * Initialize plugin
         */
        init() {
            this.bindEvents();
            this.loadSettings();
        },

        /**
         * Bind events
         */
        bindEvents() {
            $( document ).on( 'click', '.wpca-save-btn', ( e ) => {
                e.preventDefault();
                this.saveSettings();
            } );
        },

        /**
         * Load settings
         */
        async loadSettings() {
            try {
                const response = await fetch( ajaxurl, {
                    method: 'POST',
                    body: new URLSearchParams( {
                        action: 'wpca_get_settings',
                        nonce: wpca_vars.nonce
                    } )
                } );

                const settings = await response.json();
                this.renderSettings( settings );
            } catch ( error ) {
                console.error( 'Error loading settings:', error );
            }
        },

        /**
         * Save settings
         */
        async saveSettings() {
            // 保存设置代码
        },

        /**
         * Render settings
         * @param {Object} settings - Plugin settings
         */
        renderSettings( settings ) {
            // 渲染设置代码
        }
    };

    // Initialize plugin when DOM is ready
    $( document ).ready( () => {
        WPCleanAdmin.init();
    } );

} )( jQuery );
```

### 3.4 DOM 操作规范
- **DOM 加载**：确保 DOM 加载完成后再执行操作
- **事件委托**：优先使用事件委托，减少事件监听器数量
- **选择器优化**：使用高效的 CSS 选择器
- **代码压缩**：生产环境下必须压缩 JavaScript 代码

### 3.5 安全规范
- **数据验证**：所有从服务器获取的数据必须经过验证
- **输出转义**：所有输出到页面的内容必须经过转义
- **禁止使用 eval()**：禁止使用 `eval()` 函数，避免安全风险
- **本地化脚本**：使用 `wp_localize_script()` 函数传递数据到 JavaScript

## 4. CSS 代码规范

### 4.1 基础语法规范
- **文件名**：使用小写字母和连字符，例如 `wpca-admin.css`
- **命名规范**：使用 BEM（Block Element Modifier）命名规范
- **颜色变量**：使用 CSS 变量定义颜色，便于主题定制
- **响应式设计**：使用媒体查询实现响应式设计

### 4.2 BEM 命名规范
- **Block**：独立的功能块，例如 `.wpca-settings`
- **Element**：块的组成部分，例如 `.wpca-settings__field`
- **Modifier**：块或元素的状态，例如 `.wpca-settings__field--disabled`

**示例代码**：
```css
/* Block */
.wpca-settings {
    background: #fff;
    padding: 20px;
    border: 1px solid #ddd;
}

/* Element */
.wpca-settings__field {
    margin-bottom: 15px;
}

.wpca-settings__label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.wpca-settings__input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

/* Modifier */
.wpca-settings__field--disabled {
    opacity: 0.6;
    pointer-events: none;
}

.wpca-settings__input--error {
    border-color: #dc3232;
}
```

### 4.3 样式设计规范
- **继承 WordPress 样式**：尽量继承 WordPress 核心样式，保持一致性
- **盒模型**：使用 `box-sizing: border-box`
- **CSS 变量**：使用 CSS 变量定义常用样式值
- **字体**：使用 WordPress 默认字体

**示例代码**：
```css
/* CSS 变量 */
:root {
    --wpca-primary-color: #007cba;
    --wpca-secondary-color: #f0f0f1;
    --wpca-text-color: #3c434a;
    --wpca-border-color: #ddd;
    --wpca-error-color: #dc3232;
    --wpca-success-color: #46b450;
}

/* 盒模型 */
*,
*::before,
*::after {
    box-sizing: border-box;
}

/* 按钮样式 */
.wpca-btn {
    display: inline-block;
    padding: 8px 16px;
    background: var(--wpca-primary-color);
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s ease;
}

.wpca-btn:hover {
    background: #006ba1;
}

.wpca-btn--secondary {
    background: var(--wpca-secondary-color);
    color: var(--wpca-text-color);
}

.wpca-btn--secondary:hover {
    background: #e0e0e1;
}
```

### 4.4 响应式设计规范
- **移动优先**：采用移动优先的设计理念
- **断点设置**：使用 WordPress 推荐的断点值
- **弹性布局**：使用 `flex` 或 `grid` 布局实现响应式设计

**示例代码**：
```css
/* 基础布局 */
.wpca-grid {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* 平板断点 */
@media (min-width: 768px) {
    .wpca-grid {
        flex-direction: row;
        flex-wrap: wrap;
    }
    
    .wpca-grid__item {
        flex: 0 0 calc(50% - 10px);
    }
}

/* 桌面断点 */
@media (min-width: 1024px) {
    .wpca-grid__item {
        flex: 0 0 calc(33.333% - 13.333px);
    }
}
```

## 5. HTML 代码规范

### 5.1 基础语法规范
- **DOCTYPE**：使用 `<!DOCTYPE html>`
- **语言属性**：添加 `lang` 属性，例如 `<html lang="zh-CN">`
- **字符集**：使用 `<meta charset="UTF-8">`
- **语义化标签**：优先使用 HTML5 语义化标签，例如 `<header>`、`<nav>`、`<main>`、`<footer>`

### 5.2 标签使用规范
- **闭合标签**：所有标签必须正确闭合
- **引号**：属性值必须使用双引号 `"`
- **ID 和 Class**：使用有意义的 ID 和 Class 名称，例如 `id="wpca-settings"`、`class="wpca-field"`
- **标签嵌套**：正确嵌套标签，例如 `<label>` 标签必须包含 `<input>` 标签或关联到 `<input>` 标签

**示例代码**：
```html
<form id="wpca-settings-form" method="post">
    <div class="wpca-settings__field">
        <label for="wpca-option-1" class="wpca-settings__label">选项 1</label>
        <input type="text" id="wpca-option-1" name="wpca_option_1" class="wpca-settings__input" value="" placeholder="请输入选项 1">
    </div>
    
    <div class="wpca-settings__field">
        <label for="wpca-option-2" class="wpca-settings__label">选项 2</label>
        <select id="wpca-option-2" name="wpca_option_2" class="wpca-settings__select">
            <option value="">请选择</option>
            <option value="1">选项 1</option>
            <option value="2">选项 2</option>
        </select>
    </div>
    
    <div class="wpca-settings__field">
        <label class="wpca-settings__label">
            <input type="checkbox" name="wpca_option_3" value="1" class="wpca-settings__checkbox">
            选项 3
        </label>
    </div>
    
    <?php wp_nonce_field( 'wpca_save_settings', '_wpnonce' ); ?>
    <button type="submit" name="submit" class="wpca-btn">保存设置</button>
</form>
```

### 5.3 可访问性规范
- **ARIA 属性**：为交互元素添加适当的 ARIA 属性
- **键盘导航**：确保所有功能可以通过键盘访问
- **对比度**：确保文本和背景的对比度符合 WCAG 标准
- **替代文本**：为所有图片添加 `alt` 属性

## 6. 插件开发规范

### 6.1 插件结构规范
- **模块化设计**：采用模块化设计，每个功能模块独立封装
- **文件组织**：合理组织文件结构，按功能分类
- **单例模式**：核心类使用单例模式，确保只有一个实例
- **WordPress 钩子**：使用 WordPress 钩子系统，避免直接修改核心代码

### 6.2 资源管理规范
- **资源加载**：按需加载资源，避免不必要的资源加载
- **本地化**：使用 WordPress 本地化函数处理文本
- **资源版本**：为 CSS 和 JavaScript 文件添加版本号
- **异步加载**：非关键资源使用 `async` 或 `defer` 属性加载

### 6.3 兼容性规范
- **WordPress 版本**：兼容 WordPress 5.0+ 版本
- **PHP 版本**：兼容 PHP 7.0+ 版本
- **浏览器兼容**：兼容主流浏览器，包括 Chrome、Firefox、Safari、Edge
- **主题兼容**：兼容主流 WordPress 主题

### 6.4 国际化规范
- **文本域**：使用 `WPCA_TEXT_DOMAIN` 常量定义文本域
- **翻译函数**：使用 `__()`、`_e()`、`_x()`、`_ex()` 等函数处理文本
- **POT 文件**：提供 `wp-clean-admin.pot` 模板文件
- **翻译更新**：定期更新翻译文件

**示例代码**：
```php
// 加载文本域
load_plugin_textdomain( WPCA_TEXT_DOMAIN, false, dirname( plugin_basename( __FILE__ ) ) . '/languages/' );

// 使用翻译函数
echo '<h1>' . __( 'WP Clean Admin Settings', WPCA_TEXT_DOMAIN ) . '</h1>';
_e( 'Save Changes', WPCA_TEXT_DOMAIN ); // 直接输出翻译文本
$translated_text = __( 'Settings saved successfully', WPCA_TEXT_DOMAIN ); // 赋值给变量
```

## 7. 测试规范

### 7.1 测试类型
- **单元测试**：测试单个函数或方法的功能
- **集成测试**：测试多个模块之间的交互
- **功能测试**：测试插件的完整功能
- **兼容性测试**：测试插件与不同环境的兼容性

### 7.2 测试工具
- **PHPUnit**：用于 PHP 单元测试
- **QUnit**：用于 JavaScript 单元测试
- **WP CLI**：用于 WordPress 集成测试
- **BrowserStack**：用于跨浏览器测试

### 7.3 测试覆盖率
- **代码覆盖率**：争取达到 80% 以上的代码覆盖率
- **测试用例**：为每个功能编写测试用例
- **持续集成**：使用 CI 工具自动运行测试

## 8. 文档规范

### 8.1 代码文档
- **函数注释**：每个函数必须包含 PHPDoc 注释
- **类注释**：每个类必须包含 PHPDoc 注释
- **文件注释**：每个文件必须包含文件头部注释
- **TODO 注释**：使用 `// TODO: 描述待完成的任务` 格式

### 8.2 项目文档
- **README.md**：项目介绍、功能特点、安装方法、使用说明
- **CHANGELOG.md**：版本更新记录
- **贡献指南**：如何贡献代码
- **API 文档**：函数和类的详细说明

### 8.3 文档格式
- **Markdown 格式**：所有文档使用 Markdown 格式
- **清晰的结构**：使用标题、列表、代码块等元素组织内容
- **示例代码**：提供完整的示例代码
- **版本控制**：文档与代码同步更新

## 9. 版本管理规范

### 9.1 版本号格式
- **SemVer 规范**：遵循 Semantic Versioning 规范，格式为 `MAJOR.MINOR.PATCH`
  - MAJOR：不兼容的 API 变更
  - MINOR：向后兼容的新功能
  - PATCH：向后兼容的 bug 修复

### 9.2 发布流程
- **代码审查**：所有代码必须经过审查
- **更新 CHANGELOG**：更新 CHANGELOG.md 文件
- **测试**：运行所有测试，确保通过
- **标签发布**：创建 Git 标签，推送至 GitHub
- **打包发布**：打包插件，发布到 WordPress.org

### 9.3 发布步骤
1. 更新代码中的版本号
2. 更新 CHANGELOG.md 文件
3. 运行测试
4. 提交代码，创建 Git 标签
5. 推送代码和标签到 GitHub
6. 打包插件，发布到 WordPress.org

## 10. 总结

WP Clean Admin 插件的代码规范旨在确保代码的可读性、可维护性和安全性。所有开发者必须严格遵守这些规范，以保证插件的质量和一致性。

代码规范是一个不断演进的过程，我们会根据实际情况定期更新和完善这些规范。如果您对代码规范有任何建议或意见，欢迎通过 GitHub Issues 或 Pull Requests 提出。

通过遵循这些规范，我们可以共同打造一个高质量、易于维护的 WordPress 插件，为用户提供更好的体验。