# 插件开发指南

## 1. 概述

### 1.1 文档目的

本指南旨在帮助开发者了解 WP Clean Admin 项目的插件架构，学习如何开发扩展插件功能的插件，以及如何遵循插件开发的最佳实践。

### 1.2 插件架构

WP Clean Admin 采用模块化、插件化的架构设计，支持通过插件扩展功能。插件架构主要包括以下组件：

- **核心框架**：提供基础功能和插件管理机制
- **插件接口**：定义插件必须实现的接口和方法
- **钩子系统**：提供动作钩子和过滤器钩子，允许插件扩展和修改核心功能
- **API 系统**：提供 REST API 接口，允许插件与核心功能交互

### 1.3 插件类型

WP Clean Admin 支持以下类型的插件：

1. **功能扩展插件**：添加新功能或增强现有功能
2. **集成插件**：与第三方服务或插件集成
3. **主题插件**：自定义插件的外观和样式
4. **工具插件**：提供开发或管理工具

## 2. 插件开发环境搭建

### 2.1 开发准备

1. **了解 WordPress 插件开发**：
   - 熟悉 WordPress 插件开发基础知识
   - 了解 WordPress 钩子系统
   - 了解 WordPress REST API

2. **安装开发工具**：
   - 代码编辑器（推荐 VS Code）
   - WordPress 本地开发环境（推荐 Local by Flywheel、XAMPP 等）
   - Git 版本控制
   - Composer 包管理器

3. **获取 WP Clean Admin 源码**：
   ```bash
   git clone https://github.com/sutchan/WPCleanAdmin.git
   cd WPCleanAdmin
   ```

### 2.2 插件目录结构

1. **标准插件目录结构**：
   ```
   wpca-my-plugin/
   ├── includes/                  # 核心功能目录
   │   ├── class-wpca-my-plugin.php # 插件主类
   │   └── functions.php         # 辅助函数
   ├── assets/                    # 静态资源目录
   │   ├── css/                   # CSS 文件
   │   └── js/                    # JavaScript 文件
   ├── languages/                 # 语言文件目录
   ├── README.md                  # 插件说明文档
   └── wpca-my-plugin.php         # 插件主文件
   ```

2. **目录说明**：
   - `includes/`：存放插件的核心功能代码
   - `assets/`：存放插件的静态资源，如 CSS、JavaScript、图片等
   - `languages/`：存放插件的多语言文件
   - `README.md`：插件的说明文档，包含安装、使用、开发等信息
   - `wpca-my-plugin.php`：插件的主文件，包含插件的元数据和初始化代码

## 3. 插件开发基础

### 3.1 插件主文件

1. **插件元数据**：
   ```php
   <?php
   /**
    * Plugin Name: WP Clean Admin - My Plugin
    * Plugin URI: https://github.com/sutchan/WPCleanAdmin
    * Description: 这是一个 WP Clean Admin 扩展插件
    * Version: 1.0.0
    * Author: Sut
    * Author URI: https://github.com/sutchan
    * Text Domain: wpca-my-plugin
    * Domain Path: /languages
    * Requires at least: 5.0
    * Requires PHP: 7.0
    * Network: false
    */
   ```

2. **插件初始化**：
   ```php
   // 防止直接访问文件
   if ( ! defined( 'ABSPATH' ) ) {
       exit;
   }
   
   // 定义插件常量
   define( 'WPCA_MY_PLUGIN_VERSION', '1.0.0' );
   define( 'WPCA_MY_PLUGIN_DIR', plugin_dir_path( __FILE__ ) );
   define( 'WPCA_MY_PLUGIN_URL', plugin_dir_url( __FILE__ ) );
   
   // 加载插件类
   require_once WPCA_MY_PLUGIN_DIR . 'includes/class-wpca-my-plugin.php';
   
   // 初始化插件
   function wpca_my_plugin_init() {
       return WPCAMyPlugin\Plugin::getInstance();
   }
   $GLOBALS['wpca_my_plugin'] = wpca_my_plugin_init();
   ```

### 3.2 插件主类

1. **创建插件主类**：
   ```php
   <?php
   namespace WPCAMyPlugin;
   
   class Plugin {
       /**
        * 单例实例
        * @var Plugin
        */
       private static $instance = null;
       
       /**
        * 获取单例实例
        * @return Plugin
        */
       public static function getInstance() {
           if ( null === self::$instance ) {
               self::$instance = new self();
           }
           return self::$instance;
       }
       
       /**
        * 构造函数
        */
       private function __construct() {
           $this->init();
       }
       
       /**
        * 初始化插件
        */
       public function init() {
           // 注册钩子
           $this->registerHooks();
           
           // 加载语言文件
           $this->loadTextdomain();
           
           // 初始化功能
           $this->initFeatures();
       }
       
       /**
        * 注册钩子
        */
       private function registerHooks() {
           // 激活钩子
           register_activation_hook( WPCA_MY_PLUGIN_DIR . 'wpca-my-plugin.php', array( $this, 'activate' ) );
           
           // 停用钩子
           register_deactivation_hook( WPCA_MY_PLUGIN_DIR . 'wpca-my-plugin.php', array( $this, 'deactivate' ) );
           
           // 卸载钩子
           register_uninstall_hook( WPCA_MY_PLUGIN_DIR . 'wpca-my-plugin.php', array( __CLASS__, 'uninstall' ) );
           
           // WordPress 钩子
           add_action( 'init', array( $this, 'onInit' ) );
           add_action( 'admin_init', array( $this, 'onAdminInit' ) );
       }
       
       /**
        * 加载语言文件
        */
       private function loadTextdomain() {
           load_plugin_textdomain( 'wpca-my-plugin', false, dirname( plugin_basename( WPCA_MY_PLUGIN_DIR . 'wpca-my-plugin.php' ) ) . '/languages/' );
       }
       
       /**
        * 初始化功能
        */
       private function initFeatures() {
           // 初始化插件功能
       }
       
       /**
        * 激活插件
        */
       public function activate() {
           // 激活插件时执行的操作
       }
       
       /**
        * 停用插件
        */
       public function deactivate() {
           // 停用插件时执行的操作
       }
       
       /**
        * 卸载插件
        */
       public static function uninstall() {
           // 卸载插件时执行的操作
       }
       
       /**
        * WordPress init 钩子回调
        */
       public function onInit() {
           // 处理 WordPress init 钩子
       }
       
       /**
        * WordPress admin_init 钩子回调
        */
       public function onAdminInit() {
           // 处理 WordPress admin_init 钩子
       }
   }
   ```

### 3.3 插件钩子系统

1. **使用动作钩子**：
   ```php
   // 添加动作钩子
   add_action( 'wpca_after_init', 'my_plugin_after_init' );
   
   // 钩子回调函数
   function my_plugin_after_init() {
       // 在 WP Clean Admin 初始化后执行操作
   }
   ```

2. **使用过滤器钩子**：
   ```php
   // 添加过滤器钩子
   add_filter( 'wpca_menu_items', 'my_plugin_modify_menu_items' );
   
   // 钩子回调函数
   function my_plugin_modify_menu_items( $menu_items ) {
       // 修改菜单项目
       $menu_items['my-item'] = array(
           'name' => __( '我的菜单项', 'wpca-my-plugin' ),
           'slug' => 'my-item'
       );
       return $menu_items;
   }
   ```

3. **自定义钩子**：
   ```php
   // 在插件中定义钩子
   do_action( 'wpca_my_plugin_after_process', $data );
   
   // 使用 apply_filters 返回过滤后的值
   $filtered_data = apply_filters( 'wpca_my_plugin_filter_data', $data );
   ```

## 3. 插件开发进阶

### 3.1 与核心功能交互

1. **访问核心功能**：
   ```php
   // 获取 WP Clean Admin 核心实例
   global $wpca_core;
   
   // 调用核心方法
   $settings = $wpca_core->getSettings();
   ```

2. **使用核心 API**：
   ```php
   // 调用核心函数
   $menu_items = wpca_get_menu_items();
   
   // 更新核心设置
   wpca_update_settings( array( 'my_setting' => 'value' ) );
   ```

### 3.2 添加设置页面

1. **注册设置页面**：
   ```php
   /**
    * 注册设置页面
    */
   function wpca_my_plugin_add_settings_page() {
       add_submenu_page(
           'wp-clean-admin',
           __( '我的插件设置', 'wpca-my-plugin' ),
           __( '我的插件', 'wpca-my-plugin' ),
           'manage_options',
           'wpca-my-plugin-settings',
           'wpca_my_plugin_settings_page_callback'
       );
   }
   add_action( 'admin_menu', 'wpca_my_plugin_add_settings_page' );
   ```

2. **渲染设置页面**：
   ```php
   /**
    * 设置页面回调函数
    */
   function wpca_my_plugin_settings_page_callback() {
       // 获取设置
       $settings = get_option( 'wpca_my_plugin_settings', array() );
       
       // 渲染设置页面
       ?>
       <div class="wrap">
           <h1><?php _e( '我的插件设置', 'wpca-my-plugin' ); ?></h1>
           <form method="post" action="options.php">
               <?php
               settings_fields( 'wpca_my_plugin_settings' );
               do_settings_sections( 'wpca-my-plugin-settings' );
               submit_button();
               ?>
           </form>
       </div>
       <?php
   }
   ```

3. **注册设置**：
   ```php
   /**
    * 注册设置
    */
   function wpca_my_plugin_register_settings() {
       register_setting( 'wpca_my_plugin_settings', 'wpca_my_plugin_settings' );
       
       add_settings_section(
           'wpca_my_plugin_general_section',
           __( '常规设置', 'wpca-my-plugin' ),
           'wpca_my_plugin_general_section_callback',
           'wpca-my-plugin-settings'
       );
       
       add_settings_field(
           'wpca_my_plugin_option',
           __( '我的选项', 'wpca-my-plugin' ),
           'wpca_my_plugin_option_callback',
           'wpca-my-plugin-settings',
           'wpca_my_plugin_general_section'
       );
   }
   add_action( 'admin_init', 'wpca_my_plugin_register_settings' );
   
   /**
    * 常规设置部分回调
    */
   function wpca_my_plugin_general_section_callback() {
       echo __( '这是常规设置部分', 'wpca-my-plugin' );
   }
   
   /**
    * 选项回调
    */
   function wpca_my_plugin_option_callback() {
       $settings = get_option( 'wpca_my_plugin_settings', array() );
       $option = isset( $settings['my_option'] ) ? $settings['my_option'] : '';
       
       echo '<input type="text" name="wpca_my_plugin_settings[my_option]" value="' . esc_attr( $option ) . '" />';
   }
   ```

### 3.3 添加 REST API 端点

1. **注册 REST API 端点**：
   ```php
   /**
    * 注册 REST API 端点
    */
   function wpca_my_plugin_register_rest_routes() {
       register_rest_route( 'wpca-my-plugin/v1', '/data', array(
           'methods' => 'GET',
           'callback' => 'wpca_my_plugin_get_data',
           'permission_callback' => function() {
               return current_user_can( 'manage_options' );
           }
       ) );
       
       register_rest_route( 'wpca-my-plugin/v1', '/data', array(
           'methods' => 'POST',
           'callback' => 'wpca_my_plugin_save_data',
           'permission_callback' => function() {
               return current_user_can( 'manage_options' );
           }
       ) );
   }
   add_action( 'rest_api_init', 'wpca_my_plugin_register_rest_routes' );
   ```

2. **实现 API 回调**：
   ```php
   /**
    * 获取数据 API
    */
   function wpca_my_plugin_get_data( $request ) {
       // 获取数据
       $data = get_option( 'wpca_my_plugin_data', array() );
       
       return rest_ensure_response( $data );
   }
   
   /**
    * 保存数据 API
    */
   function wpca_my_plugin_save_data( $request ) {
       // 获取请求数据
       $data = $request->get_json_params();
       
       // 验证数据
       if ( empty( $data['name'] ) ) {
           return new WP_Error( 'invalid_data', __( '名称不能为空', 'wpca-my-plugin' ), array( 'status' => 400 ) );
       }
       
       // 保存数据
       update_option( 'wpca_my_plugin_data', $data );
       
       return rest_ensure_response( array( 'success' => true ) );
   }
   ```

### 3.4 添加脚本和样式

1. **注册和加载脚本**：
   ```php
   /**
    * 注册和加载脚本
    */
   function wpca_my_plugin_enqueue_scripts() {
       // 只在插件设置页面加载脚本
       $screen = get_current_screen();
       if ( $screen->id !== 'wp-clean-admin_page_wpca-my-plugin-settings' ) {
           return;
       }
       
       // 注册脚本
       wp_register_script(
           'wpca-my-plugin-admin-script',
           WPCA_MY_PLUGIN_URL . 'assets/js/admin.js',
           array( 'jquery' ),
           WPCA_MY_PLUGIN_VERSION,
           true
       );
       
       // 本地化脚本
       wp_localize_script( 'wpca-my-plugin-admin-script', 'wpcaMyPlugin', array(
           'ajax_url' => admin_url( 'admin-ajax.php' ),
           'nonce' => wp_create_nonce( 'wpca-my-plugin-nonce' ),
           'rest_url' => rest_url( 'wpca-my-plugin/v1/' )
       ) );
       
       // 加载脚本
       wp_enqueue_script( 'wpca-my-plugin-admin-script' );
   }
   add_action( 'admin_enqueue_scripts', 'wpca_my_plugin_enqueue_scripts' );
   ```

2. **注册和加载样式**：
   ```php
   /**
    * 注册和加载样式
    */
   function wpca_my_plugin_enqueue_styles() {
       // 注册样式
       wp_register_style(
           'wpca-my-plugin-admin-style',
           WPCA_MY_PLUGIN_URL . 'assets/css/admin.css',
           array(),
           WPCA_MY_PLUGIN_VERSION
       );
       
       // 加载样式
       wp_enqueue_style( 'wpca-my-plugin-admin-style' );
   }
   add_action( 'admin_enqueue_scripts', 'wpca_my_plugin_enqueue_styles' );
   ```

## 4. 插件开发最佳实践

### 4.1 代码规范

1. **遵循 WordPress 编码规范**：
   - 使用 4 个空格作为缩进
   - 每行代码长度不超过 120 个字符
   - 使用 `<?php` 标签，禁止使用短标签 `<?`
   - PHP 文件末尾禁止使用闭合标签 `?>`

2. **使用命名空间**：
   ```php
   namespace WPCAMyPlugin;
   
   class Plugin {
       // 类代码
   }
   ```

3. **添加注释**：
   - 使用 PHPDoc 注释类、方法和函数
   - 为复杂代码添加行内注释
   - 注释使用中文

### 4.2 安全性

1. **输入验证和过滤**：
   - 验证所有用户输入
   - 使用 WordPress 内置验证函数
   - 过滤所有输出到页面的内容

2. **权限检查**：
   - 验证用户权限
   - 使用 WordPress 内置权限函数
   - 为所有管理操作添加权限检查

3. **防止 SQL 注入**：
   - 使用参数化查询
   - 使用 WordPress 数据库类
   - 避免直接拼接 SQL 语句

4. **防止 CSRF 攻击**：
   - 使用 Nonce 验证
   - 为所有表单添加 Nonce
   - 验证 AJAX 请求的 Nonce

### 4.3 性能优化

1. **优化代码**：
   - 减少数据库查询
   - 使用缓存
   - 优化算法

2. **优化资源加载**：
   - 只在需要时加载脚本和样式
   - 使用异步加载和延迟加载
   - 压缩脚本和样式文件

3. **优化数据库**：
   - 使用索引
   - 优化查询
   - 定期清理数据

### 4.4 兼容性

1. **版本兼容性**：
   - 支持 WordPress 5.0+
   - 支持 PHP 7.0+
   - 定期测试最新版本的 WordPress 和 PHP

2. **插件兼容性**：
   - 避免与其他插件冲突
   - 测试与主流插件的兼容性
   - 使用唯一的函数和类名前缀

3. **主题兼容性**：
   - 与主流 WordPress 主题兼容
   - 样式隔离，避免冲突
   - 使用 WordPress 内置样式类

## 5. 插件测试与调试

### 5.1 测试方法

1. **单元测试**：
   ```bash
   # 运行单元测试
   composer run test
   ```

2. **集成测试**：
   ```bash
   # 运行集成测试
   composer run test:integration
   ```

3. **功能测试**：
   - 在本地开发环境中测试
   - 测试所有功能
   - 测试边界情况
   - 测试错误处理

### 5.2 调试技巧

1. **启用调试模式**：
   ```php
   // 在 wp-config.php 中添加
   define( 'WP_DEBUG', true );
   define( 'WP_DEBUG_DISPLAY', true );
   define( 'WP_DEBUG_LOG', true );
   ```

2. **使用调试工具**：
   - Debug Bar
   - Query Monitor
   - Xdebug

3. **日志记录**：
   ```php
   // 记录日志
   error_log( 'WP Clean Admin My Plugin: ' . $message );
   
   // 使用 WordPress 调试日志
   if ( defined( 'WP_DEBUG_LOG' ) && WP_DEBUG_LOG ) {
       error_log( 'WP Clean Admin My Plugin Debug: ' . $debug_message );
   }
   ```

## 6. 插件发布

### 6.1 准备发布

1. **更新插件元数据**：
   - 检查插件版本号
   - 更新插件描述
   - 更新作者信息

2. **更新 CHANGELOG**：
   ```markdown
   # Changelog
   
   ## 1.0.0 (2025-11-30)
   - 初始版本
   - 添加基本功能
   - 支持 WordPress 5.0+
   ```

3. **更新 README**：
   - 安装说明
   - 使用说明
   - 功能介绍
   - 常见问题
   - 贡献指南

4. **构建和压缩**：
   ```bash
   # 构建插件
   npm run build
   
   # 压缩插件
   zip -r wpca-my-plugin.zip wpca-my-plugin/
   ```

### 6.2 发布渠道

1. **WordPress.org 插件目录**：
   - 注册 WordPress.org 账户
   - 提交插件审核
   - 遵循 WordPress.org 插件指南

2. **GitHub Releases**：
   - 创建 GitHub Release
   - 上传插件 ZIP 文件
   - 编写发布说明

3. **第三方市场**：
   - CodeCanyon
   - WP Engine Marketplace
   - 其他 WordPress 插件市场

## 7. 插件维护

### 7.1 定期更新

1. **更新频率**：
   - 定期更新插件
   - 及时修复安全漏洞
   - 支持最新版本的 WordPress 和 PHP

2. **更新内容**：
   - 修复 bug
   - 添加新功能
   - 改进性能
   - 增强安全性
   - 提高兼容性

### 7.2 收集反馈

1. **反馈渠道**：
   - GitHub Issues
   - WordPress.org 支持论坛
   - 电子邮件
   - 社交媒体

2. **处理反馈**：
   - 及时回复反馈
   - 优先处理 bug 报告
   - 考虑用户建议
   - 定期更新插件

### 7.3 社区维护

1. **开放源代码**：
   - 在 GitHub 上托管源代码
   - 接受 Pull Request
   - 鼓励社区贡献

2. **文档维护**：
   - 保持文档更新
   - 提供详细的开发文档
   - 编写教程和示例

3. **社区支持**：
   - 参与社区讨论
   - 回答用户问题
   - 分享知识和经验

## 8. 总结

插件开发是 WP Clean Admin 项目的重要组成部分，通过插件可以扩展和增强插件的功能，满足不同用户的需求。

本指南介绍了插件开发的基础知识、进阶技巧、最佳实践、测试调试、发布和维护等内容，希望能够帮助开发者更好地开发 WP Clean Admin 插件。

通过遵循本指南中的开发规范和最佳实践，可以开发出高质量、安全、可靠的插件，为 WP Clean Admin 项目的发展做出贡献。

## 9. 版本历史

| 版本号 | 更新时间 | 更新内容 | 更新人员 |
|--------|----------|----------|----------|
| 1.0.0 | 2025-11-30 | 初始版本 | Sut |
